# レビューフィードバック: WBS-14, WBS-15, WBS-16

## 概要

バッチ実装（WBS-14, WBS-15, WBS-16）の人間レビューで発見された問題と修正内容。
今後の実装時に同じ問題を繰り返さないための学習資料。

---

## 発見された問題

### 1. PII（個人識別情報）のログ出力 🔴 重大

**ファイル**: `server/api/contact.post.ts`

**問題のコード**:
```typescript
console.log(`[LEAD] New lead acquired: ${email} (Org: ${organization.id})`)
```

**なぜ問題か**:
- メールアドレスは個人情報（PII）
- 本番ログに残ると情報漏洩リスク
- GDPR/個人情報保護法違反の可能性

**修正後**:
```typescript
// メールアドレスをマスク化してログ出力（PII保護）
console.log(`[LEAD] New lead acquired: ***@${email.split('@')[1]} (Org: ${organization.id})`)
```

**今後の対策**:
- ログ出力時はPII（メール、電話番号、氏名等）をマスク化
- または構造化ログを使用し、本番ではPIIフィールドを除外

---

### 2. 甘いバリデーション 🟡 中程度

**ファイル**: `server/api/contact.post.ts`

**問題のコード**:
```typescript
if (!email || !/^\S+@\S+\.\S+$/.test(email)) {
```

**なぜ問題か**:
- `a@b.c` のような無効なメールも通過する
- スパム登録やボット攻撃に弱い

**修正後**:
```typescript
const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/
if (!email || !emailRegex.test(email)) {
```

**今後の対策**:
- ユーザー入力のバリデーションは厳格に
- 可能なら `zod` や `valibot` 等のスキーマバリデーションを使用

---

### 3. シークレットのハードコード（コメント不足） 🟡 中程度

**ファイル**: `prisma/seed-succeed.ts`

**問題のコード**:
```typescript
kioskSecret: 'succeed-kiosk-secret-001',
```

**なぜ問題か**:
- 本番で変更し忘れるリスク
- シードデータのシークレットがそのまま使われる可能性

**修正後**:
```typescript
kioskSecret: 'succeed-kiosk-secret-001', // ⚠️ 本番運用前に必ず変更すること
```

**今後の対策**:
- シード/テスト用のシークレットには警告コメントを付ける
- 本番シークレットは環境変数から取得

---

## 発見されなかった問題（良い点）

- ✅ マルチテナント境界: `organizationId` フィルタが適切
- ✅ Prisma ORM使用: 生SQLなし
- ✅ 認証: 公開API（contact, health）は認証不要で正しい
- ✅ テスト: 全テストファイルが作成されている

---

## AUDIT_IMPL への追加提案

以下のチェック項目を `rules/audit-criteria.md` に追加することを推奨:

### 新規チェック項目

| カテゴリ | 項目 | 配点 |
|---------|------|------|
| セキュリティ | console.log/errorにPIIが含まれていない | 5点 |
| セキュリティ | ユーザー入力のバリデーションが厳格 | 5点 |
| ドキュメント | シード/テスト用シークレットに警告コメント | 2点 |

### 新規減点項目

| 問題 | 減点 |
|------|------|
| PIIのログ出力 | -10点 |
| 甘いバリデーション（正規表現が緩い等） | -5点 |

---

## 関連コミット

- `1ee2ad4` fix(security): メールバリデーション強化とPII漏洩対策

---

## レビュー実施日

2026-01-23

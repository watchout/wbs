# ãƒŸã‚¨ãƒ«ãƒœãƒ¼ãƒ‰ ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆæ§‹æˆè¨­è¨ˆæ›¸

## æ¦‚è¦

ãƒŸã‚¨ãƒ«ãƒœãƒ¼ãƒ‰ã¯è¤‡æ•°ã®ä¼æ¥­ãƒ»çµ„ç¹”ãŒç‹¬ç«‹ã—ã¦ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†ã‚’è¡Œãˆã‚‹ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆSaaSã‚·ã‚¹ãƒ†ãƒ ã¨ã—ã¦è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚å„ãƒ†ãƒŠãƒ³ãƒˆï¼ˆé¡§å®¢çµ„ç¹”ï¼‰ã®ãƒ‡ãƒ¼ã‚¿ã¯å®Œå…¨ã«åˆ†é›¢ã•ã‚Œã€ã‚»ã‚­ãƒ¥ã‚¢ãªç’°å¢ƒã§ã‚µãƒ¼ãƒ“ã‚¹ã‚’æä¾›ã—ã¾ã™ã€‚

## ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ãƒŸã‚¨ãƒ«ãƒœãƒ¼ãƒ‰ SaaS                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                     Load Balancer (Nginx)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Nuxt 3 Application Server (Node.js)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   ãƒ†ãƒŠãƒ³ãƒˆA    â”‚   ãƒ†ãƒŠãƒ³ãƒˆB    â”‚        ãƒ†ãƒŠãƒ³ãƒˆC          â”‚  â”‚
â”‚  â”‚  (çµ„ç¹”ID: A)   â”‚  (çµ„ç¹”ID: B)   â”‚      (çµ„ç¹”ID: C)         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                PostgreSQL Database                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Row-Level Security (RLS) ã«ã‚ˆã‚‹è«–ç†çš„åˆ†é›¢                  â”‚  â”‚
â”‚  â”‚  å„ãƒ¬ã‚³ãƒ¼ãƒ‰ã«organizationIdã‚’ä»˜ä¸                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

### ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆæ–¹å¼ï¼šRow-Level Security (RLS)

**æ¡ç”¨ç†ç”±:**
- ã‚³ã‚¹ãƒˆåŠ¹ç‡ï¼ˆå˜ä¸€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼‰
- é‹ç”¨ç®¡ç†ã®ç°¡ç´ åŒ–
- Prisma ORMã¨ã®è¦ªå’Œæ€§
- é©åˆ‡ãªã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£

### ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ 

#### 1. çµ„ç¹”ç®¡ç†ãƒ†ãƒ¼ãƒ–ãƒ«

```sql
-- Organizations: ãƒ†ãƒŠãƒ³ãƒˆã®ãƒã‚¹ã‚¿ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«
model Organization {
  id              String            @id @default(cuid())
  name            String            -- çµ„ç¹”å
  code            String?           -- çµ„ç¹”ã‚³ãƒ¼ãƒ‰ï¼ˆã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ç”¨ï¼‰
  settings        Json?             -- çµ„ç¹”å›ºæœ‰è¨­å®š
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  -- ãƒ—ãƒ©ãƒ³ã¨èª²é‡‘æƒ…å ±
  billingSettings BillingSettings[]
  billingHistory  BillingHistory[]
  aiUsage         AIUsage[]
  
  -- çµ„ç¹”å†…ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
  users           User[]
  departments     Department[]
  positions       Position[]
  schedules       Schedule[]
  boards          Board[]
  devices         Device[]
}
```

#### 2. ãƒ†ãƒŠãƒ³ãƒˆåˆ†é›¢ãƒ‘ã‚¿ãƒ¼ãƒ³

**å…¨ã¦ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«organizationIdã‚’å¿…é ˆã¨ã—ã¦ä»˜ä¸:**

```sql
-- ä¾‹ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«
model User {
  id             String       @id @default(cuid())
  organizationId String       -- ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆåˆ†é›¢ã‚­ãƒ¼
  email          String       @unique
  name           String
  -- ãã®ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
  
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}

-- ä¾‹ï¼šã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ†ãƒ¼ãƒ–ãƒ«
model Schedule {
  id             String       @id @default(cuid())
  organizationId String       -- ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆåˆ†é›¢ã‚­ãƒ¼
  title          String
  -- ãã®ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
  
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}
```

### ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡

#### Prisma Middleware ãƒ‘ã‚¿ãƒ¼ãƒ³

```typescript
// server/middleware/tenant-isolation.ts
export const tenantIsolationMiddleware = (prisma: PrismaClient) => {
  prisma.$use(async (params, next) => {
    const organizationId = getCurrentOrganizationId()
    
    // CREATEæ“ä½œ: organizationIdã‚’è‡ªå‹•ä»˜ä¸
    if (params.action === 'create') {
      params.args.data.organizationId = organizationId
    }
    
    // READæ“ä½œ: organizationIdã§ãƒ•ã‚£ãƒ«ã‚¿
    if (['findMany', 'findFirst', 'findUnique'].includes(params.action)) {
      params.args.where = {
        ...params.args.where,
        organizationId
      }
    }
    
    // UPDATE/DELETEæ“ä½œ: organizationIdã§ãƒ•ã‚£ãƒ«ã‚¿
    if (['update', 'updateMany', 'delete', 'deleteMany'].includes(params.action)) {
      params.args.where = {
        ...params.args.where,
        organizationId
      }
    }
    
    return next(params)
  })
}
```

## èªè¨¼ãƒ»èªå¯ã‚·ã‚¹ãƒ†ãƒ 

### 3æ®µéšæ¨©é™ã‚·ã‚¹ãƒ†ãƒ 

```typescript
// æ¨©é™ãƒ¬ãƒ™ãƒ«å®šç¾©
export const PERMISSION_LEVELS = {
  USER: 1,      // æä¾›å…ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆä¸€èˆ¬ï¼‰
  USER_PLUS: 2, // æä¾›å…ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆä¸Šç´šï¼‰
  ADMIN: 3,     // æä¾›å…ˆç®¡ç†è€…
  ADMIN_PLUS: 4,// æä¾›å…ˆç®¡ç†è€…ï¼ˆä¸Šç´šï¼‰
  SUPERADMIN: 5 // é–‹ç™ºè€…ï¼ˆå½“ç¤¾ï¼‰
}
```

#### æ¨©é™ãƒãƒˆãƒªãƒƒã‚¯ã‚¹

| æ©Ÿèƒ½ | User(1-2) | Admin(3-4) | SuperAdmin(5) |
|------|-----------|------------|---------------|
| ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«é–²è¦§ãƒ»ä½œæˆ | âœ… | âœ… | âœ… |
| ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç·¨é›†ãƒ»å‰Šé™¤ | â–³ | âœ… | âœ… |
| ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç† | âŒ | âœ… | âœ… |
| éƒ¨ç½²ãƒ»å½¹è·ç®¡ç† | âŒ | âœ… | âœ… |
| ãƒ—ãƒ©ãƒ³å¤‰æ›´ | âŒ | â–³ | âœ… |
| æ–™é‡‘è¨­å®šå¤‰æ›´ | âŒ | âŒ | âœ… |
| ä»–çµ„ç¹”ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ | âŒ | âŒ | âœ… |

### ãƒ†ãƒŠãƒ³ãƒˆè­˜åˆ¥æ–¹æ³•

#### 1. ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³æ–¹å¼ï¼ˆæ¨å¥¨ï¼‰
```
https://companyA.mieruboard.com
https://companyB.mieruboard.com
https://companyC.mieruboard.com
```

#### 2. ãƒ‘ã‚¹æ–¹å¼ï¼ˆä»£æ›¿æ¡ˆï¼‰
```
https://mieruboard.com/companyA
https://mieruboard.com/companyB
https://mieruboard.com/companyC
```

#### 3. å®Ÿè£…ä¾‹

```typescript
// middleware/tenant-detection.global.ts
export default defineNuxtRouteMiddleware((to) => {
  const subdomain = getSubdomain(to.fullPath)
  
  if (subdomain) {
    // ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ã‹ã‚‰ãƒ†ãƒŠãƒ³ãƒˆIDã‚’å–å¾—
    const organizationId = await getOrganizationByCode(subdomain)
    
    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ãƒ†ãƒŠãƒ³ãƒˆæƒ…å ±ã‚’è¨­å®š
    await setCurrentTenant(organizationId)
  }
})
```

## ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæ§‹æˆ

### Single Instance Multiple Tenant (SIMT)

```yaml
# docker-compose.yml
version: '3.8'
services:
  app:
    build: .
    ports:
      - "3001:3001"
    environment:
      - DATABASE_URL=postgresql://user:pass@db:5432/mieruboard
      - NUXT_PUBLIC_BASE_URL=https://mieruboard.com
    depends_on:
      - db
      - redis

  db:
    image: postgres:15
    environment:
      POSTGRES_DB: mieruboard
      POSTGRES_USER: user
      POSTGRES_PASSWORD: pass
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - app

volumes:
  postgres_data:
  redis_data:
```

### Nginxè¨­å®šï¼ˆã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³å¯¾å¿œï¼‰

```nginx
# nginx.conf
server {
    listen 80;
    server_name *.mieruboard.com mieruboard.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name *.mieruboard.com mieruboard.com;
    
    ssl_certificate /etc/nginx/ssl/mieruboard.com.crt;
    ssl_certificate_key /etc/nginx/ssl/mieruboard.com.key;
    
    location / {
        proxy_pass http://app:3001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

## æ–™é‡‘ãƒ»ãƒ—ãƒ©ãƒ³ç®¡ç†

### ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆå¯¾å¿œæ–™é‡‘ã‚·ã‚¹ãƒ†ãƒ 

#### 1. ãƒ—ãƒ©ãƒ³æ§‹æˆ

| ãƒ—ãƒ©ãƒ³ | æœˆé¡æ–™é‡‘ | åŸºæœ¬ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ | è¿½åŠ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ | AIä½¿ç”¨å›æ•° |
|--------|----------|---------------|---------------|------------|
| ãƒ©ã‚¤ãƒˆ | Â¥4,980 | 5å | Â¥600/å | 30å›/æœˆ |
| ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ | Â¥9,800 | 15å | Â¥500/å | 100å›/æœˆ |
| ãƒ—ãƒ¬ãƒŸã‚¢ãƒ  | Â¥19,800 | 50å | Â¥400/å | 300å›/æœˆ |
| ã‚¨ã‚¯ã‚¹ãƒˆãƒ© | Â¥39,800 | 100å | Â¥300/å | 500å›/æœˆ |
| ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚º | åˆ¥é€”è¦‹ç© | 100å | åˆ¥é€”è¦‹ç© | 1,000å›/æœˆ |

#### 2. çµ„ç¹”åˆ¥ãƒ—ãƒ©ãƒ³ç®¡ç†

```typescript
// çµ„ç¹”åˆ¥ãƒ—ãƒ©ãƒ³è¨­å®š
model BillingSettings {
  id             String       @id @default(cuid())
  organizationId String       -- ãƒ†ãƒŠãƒ³ãƒˆåˆ†é›¢
  planType       String       -- ãƒ—ãƒ©ãƒ³ã‚¿ã‚¤ãƒ—
  customSettings Json?        -- ã‚«ã‚¹ã‚¿ãƒ è¨­å®šï¼ˆSuperAdminç”¨ï¼‰
  isActive       Boolean      @default(true)
  startDate      DateTime
  endDate        DateTime?
  
  organization   Organization @relation(fields: [organizationId], references: [id])
}
```

#### 3. ä½¿ç”¨é‡ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°

```typescript
// AIä½¿ç”¨é‡ç®¡ç†
model AIUsage {
  id             String       @id @default(cuid())
  organizationId String       -- ãƒ†ãƒŠãƒ³ãƒˆåˆ†é›¢
  userId         String
  month          String       -- "2024-01"å½¢å¼
  feature        String       -- "chat", "voice"ç­‰
  credits        Int          -- ä½¿ç”¨ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆæ•°
  
  organization   Organization @relation(fields: [organizationId], references: [id])
  user           User         @relation(fields: [userId], references: [id])
}
```

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

### 1. ãƒ‡ãƒ¼ã‚¿åˆ†é›¢ä¿è¨¼

#### å¿œç”¨ãƒ¬ãƒ™ãƒ«ã§ã®ä¿è­·
```typescript
// APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ã®å¿…é ˆãƒã‚§ãƒƒã‚¯
export default defineEventHandler(async (event) => {
  const userSession = await getUserSession(event)
  const organizationId = userSession.organizationId
  
  // å¿…ãšorganizationIdã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
  const data = await prisma.schedule.findMany({
    where: { organizationId }
  })
  
  return data
})
```

#### Database ãƒ¬ãƒ™ãƒ«ã§ã®ä¿è­·
```sql
-- Row Level Security (RLS) è¨­å®šä¾‹
ALTER TABLE schedules ENABLE ROW LEVEL SECURITY;

CREATE POLICY tenant_isolation ON schedules
USING (organization_id = current_setting('app.current_organization_id'));
```

### 2. èªè¨¼ãƒ»ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†

```typescript
// ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
interface UserSession {
  userId: string
  organizationId: string
  permissions: number[]
  role: string
}

// ã‚¯ãƒ­ã‚¹ãƒ†ãƒŠãƒ³ãƒˆã‚¢ã‚¯ã‚»ã‚¹é˜²æ­¢
async function validateTenantAccess(userId: string, resourceId: string) {
  const user = await prisma.user.findUnique({
    where: { id: userId },
    include: { organization: true }
  })
  
  const resource = await prisma.schedule.findUnique({
    where: { id: resourceId }
  })
  
  if (user?.organizationId !== resource?.organizationId) {
    throw new Error('Cross-tenant access denied')
  }
}
```

### 3. ç›£æŸ»ãƒ­ã‚°

```typescript
// å…¨æ“ä½œã®ç›£æŸ»ãƒ­ã‚°
model AuditLog {
  id             String       @id @default(cuid())
  organizationId String       -- ãƒ†ãƒŠãƒ³ãƒˆåˆ†é›¢
  userId         String
  action         String       -- "CREATE", "UPDATE", "DELETE"
  resourceType   String       -- "Schedule", "User"ç­‰
  resourceId     String
  changes        Json?        -- å¤‰æ›´å†…å®¹
  ipAddress      String
  userAgent      String
  createdAt      DateTime     @default(now())
  
  organization   Organization @relation(fields: [organizationId], references: [id])
}
```

## é‹ç”¨ç®¡ç†

### 1. ãƒ†ãƒŠãƒ³ãƒˆä½œæˆãƒ•ãƒ­ãƒ¼

```typescript
// æ–°è¦ãƒ†ãƒŠãƒ³ãƒˆä½œæˆ
async function createNewTenant(tenantData: {
  name: string
  code: string
  adminUser: {
    name: string
    email: string
    password: string
  }
  plan: string
}) {
  return await prisma.$transaction(async (tx) => {
    // 1. çµ„ç¹”ä½œæˆ
    const organization = await tx.organization.create({
      data: {
        name: tenantData.name,
        code: tenantData.code,
        settings: {
          planType: tenantData.plan,
          setupCompleted: false
        }
      }
    })
    
    // 2. ç®¡ç†è€…ãƒã‚¸ã‚·ãƒ§ãƒ³ä½œæˆ
    const adminPosition = await tx.position.create({
      data: {
        name: 'ç®¡ç†è€…',
        level: 3,
        organizationId: organization.id
      }
    })
    
    // 3. ç®¡ç†è€…ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
    const adminUser = await tx.user.create({
      data: {
        name: tenantData.adminUser.name,
        email: tenantData.adminUser.email,
        password: await hashPassword(tenantData.adminUser.password),
        organizationId: organization.id,
        positionId: adminPosition.id
      }
    })
    
    // 4. èª²é‡‘è¨­å®šä½œæˆ
    await tx.billingSettings.create({
      data: {
        organizationId: organization.id,
        planType: tenantData.plan,
        startDate: new Date(),
        isActive: true
      }
    })
    
    return { organization, adminUser }
  })
}
```

### 2. ç›£è¦–ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆ

#### ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†
```typescript
// çµ„ç¹”åˆ¥ãƒªã‚½ãƒ¼ã‚¹ä½¿ç”¨é‡
const organizationMetrics = {
  userCount: await prisma.user.count({ where: { organizationId } }),
  scheduleCount: await prisma.schedule.count({ where: { organizationId } }),
  aiUsageThisMonth: await getAIUsage(organizationId, currentMonth),
  storageUsage: await calculateStorageUsage(organizationId)
}
```

#### ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š
- AIä½¿ç”¨é‡ãŒåˆ¶é™ã®80%ã«é”ã—ãŸå ´åˆ
- ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä½¿ç”¨é‡ãŒç•°å¸¸ã«å¤šã„å ´åˆ
- ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—ãŒé€£ç¶šã—ãŸå ´åˆ
- å¤§é‡ã®APIå‘¼ã³å‡ºã—ãŒç™ºç”Ÿã—ãŸå ´åˆ

### 3. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»ç½å®³å¾©æ—§

#### å®šæœŸãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
```bash
#!/bin/bash
# daily-backup.sh

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å…¨ä½“ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
pg_dump $DATABASE_URL > /backup/mieruboard_$(date +%Y%m%d).sql

# çµ„ç¹”åˆ¥ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆå¤§è¦æ¨¡ãƒ†ãƒŠãƒ³ãƒˆç”¨ï¼‰
for org_id in $(psql -t -c "SELECT id FROM organizations WHERE plan = 'enterprise'"); do
  pg_dump --where="organization_id='$org_id'" $DATABASE_URL > /backup/org_${org_id}_$(date +%Y%m%d).sql
done
```

## ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°æˆ¦ç•¥

### 1. å‚ç›´ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°
- CPUã¨ãƒ¡ãƒ¢ãƒªã®å¢—å¼·
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ—ãƒ¼ãƒ«ã®æœ€é©åŒ–
- Redis ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æ´»ç”¨

### 2. æ°´å¹³ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°

#### ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤
```yaml
# kubernetes deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mieruboard-app
spec:
  replicas: 3
  selector:
    matchLabels:
      app: mieruboard
  template:
    metadata:
      labels:
        app: mieruboard
    spec:
      containers:
      - name: app
        image: mieruboard:latest
        ports:
        - containerPort: 3001
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
```

#### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å±¤
```yaml
# PostgreSQL ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼æ§‹æˆ
primary:
  host: pg-primary
  port: 5432
  max_connections: 200

replicas:
  - host: pg-replica-1
    port: 5432
    purpose: read_only
  - host: pg-replica-2
    port: 5432
    purpose: read_only
```

### 3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

#### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æˆ¦ç•¥
```sql
-- ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆç”¨ã®è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_schedules_org_date ON schedules (organization_id, start_time);
CREATE INDEX idx_users_org_active ON users (organization_id, is_active);
CREATE INDEX idx_ai_usage_org_month ON ai_usage (organization_id, month);
```

#### ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥
```typescript
// Redis ã‚’ä½¿ã£ãŸçµ„ç¹”æƒ…å ±ã‚­ãƒ£ãƒƒã‚·ãƒ¥
class OrganizationCache {
  static async get(organizationId: string) {
    const cached = await redis.get(`org:${organizationId}`)
    if (cached) return JSON.parse(cached)
    
    const org = await prisma.organization.findUnique({
      where: { id: organizationId },
      include: { billingSettings: true }
    })
    
    await redis.setex(`org:${organizationId}`, 3600, JSON.stringify(org))
    return org
  }
}
```

## æ–™é‡‘è¨ˆç®—ãƒ»è«‹æ±‚ã‚·ã‚¹ãƒ†ãƒ 

### 1. æœˆæ¬¡èª²é‡‘è¨ˆç®—

```typescript
// æœˆæ¬¡è«‹æ±‚é¡è¨ˆç®—
async function calculateMonthlyBilling(organizationId: string, month: string) {
  const org = await getOrganizationWithPlan(organizationId)
  const plan = await getActivePlanSettings()
  const currentPlan = plan[org.planType]
  
  // åŸºæœ¬æ–™é‡‘
  const basePrice = currentPlan.basePrice
  
  // è¿½åŠ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæ–™é‡‘
  const userCount = await prisma.user.count({
    where: { organizationId, isActive: true }
  })
  const additionalUsers = Math.max(0, userCount - currentPlan.baseAccounts)
  const additionalAccountFee = additionalUsers * currentPlan.additionalPrice
  
  // AIä½¿ç”¨é‡è¶…éæ–™é‡‘
  const aiUsage = await getChatUsage(organizationId, month)
  const overageUsage = Math.max(0, aiUsage - currentPlan.chatCreditsIncluded)
  const overageFee = overageUsage * currentPlan.chatOveragePrice
  
  return {
    basePrice,
    additionalAccountFee,
    overageFee,
    totalAmount: basePrice + additionalAccountFee + overageFee,
    breakdown: {
      userCount,
      additionalUsers,
      aiUsage,
      overageUsage
    }
  }
}
```

### 2. è«‹æ±‚å±¥æ­´ç®¡ç†

```typescript
model BillingHistory {
  id             String       @id @default(cuid())
  organizationId String
  month          String       -- "2024-01"
  planType       String
  basePrice      Int
  additionalFee  Int
  overageFee     Int
  totalAmount    Int
  status         String       -- "pending", "paid", "overdue"
  dueDate        DateTime
  paidAt         DateTime?
  details        Json         -- è©³ç´°ãªè¨ˆç®—å†…è¨³
  
  organization   Organization @relation(fields: [organizationId], references: [id])
}
```

## ç§»è¡Œãƒ»ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰æˆ¦ç•¥

### 1. æ®µéšçš„ç§»è¡Œ

#### Phase 1: åŸºç›¤æ•´å‚™
- ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆå¯¾å¿œãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹é€ 
- åŸºæœ¬çš„ãªãƒ†ãƒŠãƒ³ãƒˆåˆ†é›¢æ©Ÿèƒ½
- èªè¨¼ãƒ»èªå¯ã‚·ã‚¹ãƒ†ãƒ 

#### Phase 2: æ©Ÿèƒ½æ‹¡å¼µ
- SuperAdminç®¡ç†æ©Ÿèƒ½
- é«˜åº¦ãªç›£è¦–ãƒ»ãƒ­ã‚°æ©Ÿèƒ½
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

#### Phase 3: æ‹¡å¼µãƒ»é‹ç”¨
- è‡ªå‹•åŒ–ãƒ„ãƒ¼ãƒ«
- é«˜å¯ç”¨æ€§æ§‹æˆ
- ç½å®³å¾©æ—§ã‚·ã‚¹ãƒ†ãƒ 

### 2. ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

```typescript
// æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆåŒ–
async function migrateToMultiTenant() {
  // 1. ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆçµ„ç¹”ä½œæˆ
  const defaultOrg = await prisma.organization.create({
    data: {
      name: 'Default Organization',
      code: 'default'
    }
  })
  
  // 2. æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«çµ„ç¹”IDä»˜ä¸
  await prisma.user.updateMany({
    where: { organizationId: null },
    data: { organizationId: defaultOrg.id }
  })
  
  // 3. æ—¢å­˜ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã«çµ„ç¹”IDä»˜ä¸
  await prisma.schedule.updateMany({
    where: { organizationId: null },
    data: { organizationId: defaultOrg.id }
  })
}
```

## ã¾ã¨ã‚

ãƒŸã‚¨ãƒ«ãƒœãƒ¼ãƒ‰ã®ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆæ§‹æˆã¯ä»¥ä¸‹ã®ç‰¹å¾´ã‚’æŒã¡ã¾ã™ï¼š

### âœ… åˆ©ç‚¹
- **ã‚³ã‚¹ãƒˆåŠ¹ç‡**: å˜ä¸€ã‚¤ãƒ³ãƒ•ãƒ©ã§è¤‡æ•°é¡§å®¢ã«å¯¾å¿œ
- **é‹ç”¨åŠ¹ç‡**: çµ±ä¸€ã•ã‚ŒãŸç®¡ç†ãƒ»ç›£è¦–
- **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£**: éœ€è¦ã«å¿œã˜ãŸæŸ”è»Ÿãªæ‹¡å¼µ
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: Row-Level Securityã«ã‚ˆã‚‹ç¢ºå®Ÿãªãƒ‡ãƒ¼ã‚¿åˆ†é›¢

### ğŸ”§ æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯
- **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰**: Nuxt 3 + Vue 3 + Pinia
- **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰**: Node.js + Prisma ORM
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: PostgreSQL (RLSå¯¾å¿œ)
- **ã‚­ãƒ£ãƒƒã‚·ãƒ¥**: Redis
- **ã‚¤ãƒ³ãƒ•ãƒ©**: Docker + Nginx

### ğŸ“ˆ æˆé•·æˆ¦ç•¥
- å°è¦æ¨¡ã‹ã‚‰é–‹å§‹ã—ã€éœ€è¦ã«å¿œã˜ã¦æ®µéšçš„ã«ã‚¹ã‚±ãƒ¼ãƒ«
- SuperAdminæ©Ÿèƒ½ã«ã‚ˆã‚‹æŸ”è»Ÿãªæ–™é‡‘è¨­å®š
- åŒ…æ‹¬çš„ãªç›£è¦–ãƒ»åˆ†æã«ã‚ˆã‚‹ç¶™ç¶šçš„æ”¹å–„

ã“ã®è¨­è¨ˆã«ã‚ˆã‚Šã€ãƒŸã‚¨ãƒ«ãƒœãƒ¼ãƒ‰ã¯åŠ¹ç‡çš„ã§å®‰å…¨ãªãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆSaaSã¨ã—ã¦é‹ç”¨å¯èƒ½ã§ã™ã€‚ 
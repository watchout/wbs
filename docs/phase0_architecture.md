# Phase 0 ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ: ç¾å ´WEEK

**ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ**: ãƒŸã‚¨ãƒ«ãƒœãƒ¼ãƒ‰ for ç¾å ´  
**ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«**: ç¾å ´WEEK  
**Phase**: 0  
**æœ€çµ‚æ›´æ–°**: 2025-12-07

---

## ğŸ“‹ ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã¤ã„ã¦

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ **Phase 0ï¼ˆç¾å ´WEEKï¼‰ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ** ã§ã™ã€‚

**å‚ç…§**:
- `docs/SSOT_GENBA_WEEK.md` - è¨­è¨ˆSSOT
- `docs/phase0_weak_current_spec.md` - è©³ç´°ä»•æ§˜

---

## ğŸ—ï¸ ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆå›³

### å…¨ä½“ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå±¤                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚   PC/Mac     â”‚  â”‚  ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ   â”‚  â”‚  ã‚µã‚¤ãƒãƒ¼ã‚¸   â”‚    â”‚
â”‚  â”‚  (ç®¡ç†ç”»é¢)   â”‚  â”‚  (ç¢ºèªç”¨)     â”‚  â”‚  (TVè¡¨ç¤º)     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚           â”‚                â”‚                â”‚              â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                          HTTPS                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Nginx (Reverse Proxy)                â”‚
â”‚  - SSL Termination                                          â”‚
â”‚  - Load Balancing                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Nuxt 3 Application (Docker)                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                 Frontend (SSR/SPA)                   â”‚   â”‚
â”‚  â”‚  â”œâ”€ pages/org/[slug]/weekly-board.vue              â”‚   â”‚
â”‚  â”‚  â”œâ”€ components/genba/WeeklyScheduleBoard.vue       â”‚   â”‚
â”‚  â”‚  â””â”€ composables/useWeeklyBoard.ts                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                 Backend (Server API)                 â”‚   â”‚
â”‚  â”‚  â”œâ”€ server/api/schedules/weekly-board.get.ts       â”‚   â”‚
â”‚  â”‚  â”œâ”€ server/utils/scheduleFormatter.ts              â”‚   â”‚
â”‚  â”‚  â””â”€ server/utils/auth.ts (requireAuth)             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                 Socket.IO Server                     â”‚   â”‚
â”‚  â”‚  â””â”€ server/plugins/socket.io.ts                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                PostgreSQL (Docker)                           â”‚
â”‚  â”œâ”€ Schedule (æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«)                                  â”‚
â”‚  â”œâ”€ User                                                     â”‚
â”‚  â”œâ”€ Organization                                             â”‚
â”‚  â”œâ”€ Department                                               â”‚
â”‚  â””â”€ Position                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼è©³ç´°

### 1. é€±é–“ãƒœãƒ¼ãƒ‰è¡¨ç¤ºãƒ•ãƒ­ãƒ¼

```
[ãƒ¦ãƒ¼ã‚¶ãƒ¼]
    â†“ (1) ãƒšãƒ¼ã‚¸ã‚¢ã‚¯ã‚»ã‚¹
    â†“ /org/succeed/weekly-board
    
[Nuxt SSR]
    â†“ (2) èªè¨¼ãƒã‚§ãƒƒã‚¯
    â†“ JWT Cookieæ¤œè¨¼
    â†“ organizationId å–å¾—
    
[weekly-board.vue]
    â†“ (3) ãƒ‡ãƒ¼ã‚¿å–å¾—
    â†“ GET /api/schedules/weekly-board?startDate=2025-01-13
    
[weekly-board.get.ts]
    â†“ (4) requireAuth() å®Ÿè¡Œ
    â†“ userId, organizationId å–å¾—
    â†“ (5) Prisma ã‚¯ã‚¨ãƒª
    â†“ Schedule.findMany({
    â†“   where: {
    â†“     organizationId: organizationId,  â† ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆå¢ƒç•Œ
    â†“     start: { gte: weekStart },
    â†“     end: { lte: weekEnd }
    â†“   }
    â†“ })
    
[PostgreSQL]
    â†“ (6) ãƒ‡ãƒ¼ã‚¿è¿”å´
    â†“ Schedule[]
    
[scheduleFormatter.ts]
    â†“ (7) è¡¨ç¤ºãƒ†ã‚­ã‚¹ãƒˆæ•´å½¢
    â†“ "9-18 â—¯â—¯ãƒ›ãƒ†ãƒ« æ–°é¤¨å·¥äº‹"
    
[weekly-board.get.ts]
    â†“ (8) ãƒ¬ã‚¹ãƒãƒ³ã‚¹è¿”å´
    â†“ WeeklyBoardResponse
    
[WeeklyScheduleBoard.vue]
    â†“ (9) ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    â†“ ç¤¾å“¡ Ã— æ›œæ—¥ãƒãƒˆãƒªã‚¯ã‚¹è¡¨ç¤º
    
[ãƒ¦ãƒ¼ã‚¶ãƒ¼]
    âœ… ç”»é¢è¡¨ç¤ºå®Œäº†
```

---

### 2. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ãƒ•ãƒ­ãƒ¼

```
[ç®¡ç†è€…]
    â†“ (1) ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¿½åŠ 
    â†“ POST /api/schedules
    
[schedules/index.post.ts]
    â†“ (2) Scheduleä½œæˆ
    â†“ prisma.schedule.create()
    â†“ (3) Socket.IO ã‚¤ãƒ™ãƒ³ãƒˆç™ºè¡Œ
    â†“ io.to(`org-${organizationId}`).emit('schedule:created', {...})
    
[Socket.IO Server]
    â†“ (4) åŒã˜çµ„ç¹”ã®å…¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«é…ä¿¡
    
[WeeklyScheduleBoard.vue (ã‚µã‚¤ãƒãƒ¼ã‚¸)]
    â†“ (5) on('schedule:created') å—ä¿¡
    â†“ (6) ãƒ‡ãƒ¼ã‚¿å†å–å¾—
    â†“ GET /api/schedules/weekly-board
    
[weekly-board.get.ts]
    â†“ (7) æœ€æ–°ãƒ‡ãƒ¼ã‚¿è¿”å´
    
[WeeklyScheduleBoard.vue]
    â†“ (8) ç”»é¢æ›´æ–°
    
[ã‚µã‚¤ãƒãƒ¼ã‚¸]
    âœ… ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åæ˜ å®Œäº†
```

---

## ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ

### 1. èªè¨¼ãƒ»èªå¯

#### JWT + Cookieæ–¹å¼

```typescript
// server/utils/auth.ts

export async function requireAuth(event: H3Event) {
  // (1) Cookie ã‹ã‚‰ JWT å–å¾—
  const token = getCookie(event, 'auth_token');
  
  if (!token) {
    throw createError({
      statusCode: 401,
      message: 'Unauthorized'
    });
  }
  
  // (2) JWTæ¤œè¨¼
  const payload = await verifyJWT(token);
  
  // (3) ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—
  const user = await prisma.user.findUnique({
    where: { id: payload.userId },
    include: { organization: true, position: true }
  });
  
  if (!user) {
    throw createError({
      statusCode: 401,
      message: 'User not found'
    });
  }
  
  // (4) ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«ä¿å­˜
  event.context.auth = {
    userId: user.id,
    organizationId: user.organizationId,
    role: user.position.level
  };
  
  return event.context.auth;
}
```

---

### 2. ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆå¢ƒç•Œ

#### åŸå‰‡

- âœ… **ã™ã¹ã¦ã®APIã§ `requireAuth()` å¿…é ˆ**
- âœ… **`organizationId` ã«ã‚ˆã‚‹ãƒ•ã‚£ãƒ«ã‚¿å¿…é ˆ**
- âŒ **`organizationId ?? 'default'` ã®ã‚ˆã†ãªãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç¦æ­¢**

#### å®Ÿè£…ä¾‹

```typescript
// server/api/schedules/weekly-board.get.ts

export default defineEventHandler(async (event) => {
  // (1) èªè¨¼å¿…é ˆ
  const auth = await requireAuth(event);
  
  // (2) ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å–å¾—
  const { startDate, department } = getQuery(event);
  
  // (3) Prisma ã‚¯ã‚¨ãƒªï¼ˆorganizationId ã§ãƒ•ã‚£ãƒ«ã‚¿ï¼‰
  const schedules = await prisma.schedule.findMany({
    where: {
      organizationId: auth.organizationId,  // â† å¿…é ˆ
      start: { gte: new Date(startDate) },
      end: { lte: new Date(weekEnd) },
      // department ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆã‚ã‚Œã°ï¼‰
      ...(department && {
        user: { department: { name: department } }
      })
    },
    include: {
      user: {
        include: { department: true }
      }
    }
  });
  
  // (4) æ•´å½¢ã—ã¦è¿”å´
  return formatWeeklyBoard(schedules);
});
```

---

### 3. SQL ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–

#### åŸå‰‡

- âŒ **ç”ŸSQLï¼ˆ`prisma.$queryRaw`ï¼‰ç¦æ­¢**
- âœ… **Prisma ORMã®ã¿ä½¿ç”¨**

#### ç†ç”±

- Prisma ã¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã•ã‚ŒãŸã‚¯ã‚¨ãƒªã‚’è‡ªå‹•ç”Ÿæˆ
- SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒªã‚¹ã‚¯ãŒã‚¼ãƒ­

---

## ğŸ“Š ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£è¨­è¨ˆ

### 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æœ€é©åŒ–

#### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­è¨ˆ

```sql
-- Schedule ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE INDEX idx_schedule_org_date 
ON "Schedule" (organization_id, start, end);

-- User ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE INDEX idx_user_org_dept 
ON "User" (organization_id, department_id);
```

#### ã‚¯ã‚¨ãƒªæœ€é©åŒ–

- âœ… `include` ã§ N+1 å•é¡Œã‚’å›é¿
- âœ… å¿…è¦ãªåˆ—ã®ã¿ `select` ã§å–å¾—

---

### 2. ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ï¼ˆPhase 1ä»¥é™ï¼‰

#### Rediså°å…¥ï¼ˆå°†æ¥ï¼‰

```typescript
// ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ä¾‹
const cacheKey = `weekly-board:${organizationId}:${startDate}:${department}`;

// ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ‰åŠ¹æœŸé™: 5åˆ†
const ttl = 300;
```

---

### 3. Socket.IO ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ï¼ˆPhase 1ä»¥é™ï¼‰

#### Redis Adapter å°å…¥

```typescript
// server/plugins/socket.io.ts

import { createAdapter } from '@socket.io/redis-adapter';
import { createClient } from 'redis';

const pubClient = createClient({ host: 'redis', port: 6379 });
const subClient = pubClient.duplicate();

io.adapter(createAdapter(pubClient, subClient));
```

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

### 1. ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ

#### å¯¾è±¡

- âœ… `server/utils/scheduleFormatter.ts`
- âœ… `composables/useWeeklyBoard.ts`

#### ä¾‹

```typescript
// server/utils/scheduleFormatter.test.ts

describe('formatScheduleForDisplay', () => {
  it('should format schedule with time and site name', () => {
    const schedule = {
      start: new Date('2025-01-15T09:00:00Z'),
      end: new Date('2025-01-15T18:00:00Z'),
      metadata: {
        siteName: 'â—¯â—¯ãƒ›ãƒ†ãƒ«',
        activityType: 'å·¥äº‹'
      }
    };
    
    const result = formatScheduleForDisplay(schedule);
    
    expect(result).toBe('9-18 â—¯â—¯ãƒ›ãƒ†ãƒ« å·¥äº‹');
  });
});
```

---

### 2. çµ±åˆãƒ†ã‚¹ãƒˆ

#### å¯¾è±¡

- âœ… `GET /api/schedules/weekly-board` ã®ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆå¢ƒç•Œ

#### ä¾‹

```typescript
// server/api/schedules/weekly-board.test.ts

describe('GET /api/schedules/weekly-board', () => {
  it('should return only schedules for authenticated organization', async () => {
    // ãƒ†ãƒŠãƒ³ãƒˆAã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³
    const tokenA = await loginAs(userA);
    
    // ãƒ†ãƒŠãƒ³ãƒˆBã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’äº‹å‰ä½œæˆ
    await createSchedule({ organizationId: 'org-b', ... });
    
    // APIå‘¼ã³å‡ºã—
    const response = await $fetch('/api/schedules/weekly-board', {
      query: { startDate: '2025-01-13' },
      headers: { Cookie: `auth_token=${tokenA}` }
    });
    
    // ãƒ†ãƒŠãƒ³ãƒˆAã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã¿è¿”å´ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    expect(response.employees.every(e => 
      e.schedules.every(s => s.organizationId === 'org-a')
    )).toBe(true);
    
    // ãƒ†ãƒŠãƒ³ãƒˆBã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒå«ã¾ã‚Œã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèª
    expect(response.employees.some(e => 
      e.schedules.some(s => s.organizationId === 'org-b')
    )).toBe(false);
  });
});
```

---

## ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤æ§‹æˆ

### 1. ã‚¤ãƒ³ãƒ•ãƒ©æ§‹æˆï¼ˆConoHa VPSï¼‰

```
ConoHa VPS (4GB RAM, 2vCPU)
â”œâ”€â”€ Docker Compose
â”‚   â”œâ”€â”€ nginx (Reverse Proxy)
â”‚   â”œâ”€â”€ nuxt-app (Nuxt 3 Application)
â”‚   â””â”€â”€ postgres (PostgreSQL 14)
â”œâ”€â”€ Terraform (IaC)
â””â”€â”€ GitHub Actions (CI/CD)
```

---

### 2. Docker Composeæ§‹æˆ

```yaml
# docker-compose.yml

version: '3.8'

services:
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./certs:/etc/nginx/certs
    depends_on:
      - nuxt-app

  nuxt-app:
    build: .
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://user:pass@postgres:5432/wbs
    ports:
      - "3000:3000"
    depends_on:
      - postgres

  postgres:
    image: postgres:14
    environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=pass
      - POSTGRES_DB=wbs
    volumes:
      - postgres-data:/var/lib/postgresql/data

volumes:
  postgres-data:
```

---

### 3. CI/CD ãƒ•ãƒ­ãƒ¼ï¼ˆGitHub Actionsï¼‰

```yaml
# .github/workflows/deploy.yml (å°†æ¥)

name: Deploy to Production

on:
  push:
    tags:
      - 'v*'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Build Docker Image
        run: docker build -t wbs-genba:${{ github.ref_name }} .
      
      - name: Deploy to VPS
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} \
          "cd /opt/wbs && \
           docker-compose pull && \
           docker-compose up -d"
```

---

## ğŸ“ˆ ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ãƒ»ãƒ­ã‚®ãƒ³ã‚°

### 1. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°

```typescript
// server/utils/logger.ts

export function logInfo(message: string, meta?: object) {
  console.log(JSON.stringify({
    level: 'info',
    timestamp: new Date().toISOString(),
    message,
    ...meta
  }));
}
```

---

### 2. ã‚¨ãƒ©ãƒ¼ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ï¼ˆPhase 1ä»¥é™ï¼‰

- Sentry å°å…¥
- ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã«è‡ªå‹•é€šçŸ¥

---

## ğŸ”— æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã¨ã®çµ±åˆ

### 1. æ—¢å­˜ãƒŸã‚¨ãƒ«ãƒœãƒ¼ãƒ‰åŸºç›¤ã¨ã®é–¢ä¿‚

#### å…±æœ‰éƒ¨åˆ†

- âœ… èªè¨¼ãƒ»èªå¯ï¼ˆJWT + Cookieï¼‰
- âœ… ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆï¼ˆorganizationIdï¼‰
- âœ… User / Organization / Department / Position ãƒ†ãƒ¼ãƒ–ãƒ«
- âœ… Prisma ORM

#### Phase 0 ã§è¿½åŠ ã™ã‚‹éƒ¨åˆ†

- âœ… `Schedule.metadata` ã®æ‹¡å¼µ
- âœ… é€±é–“ãƒœãƒ¼ãƒ‰ç”¨ APIï¼ˆ`/api/schedules/weekly-board`ï¼‰
- âœ… ç¾å ´WEEKç”¨ UI ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

---

### 2. å¤–éƒ¨ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é€£æºï¼ˆPhase 0 ã§ã¯æ‰‹å‹•ï¼‰

#### Google Calendar APIï¼ˆPhase 1ä»¥é™ï¼‰

```typescript
// server/utils/googleCalendar.ts

export async function syncGoogleCalendar(userId: string) {
  // OAuthèªè¨¼
  const auth = await getGoogleAuth(userId);
  
  // ã‚¤ãƒ™ãƒ³ãƒˆå–å¾—
  const events = await calendar.events.list({
    calendarId: 'primary',
    timeMin: startDate.toISOString(),
    timeMax: endDate.toISOString()
  });
  
  // Scheduleã«å¤‰æ›ã—ã¦ä¿å­˜
  for (const event of events.data.items) {
    await prisma.schedule.upsert({
      where: { externalId: event.id },
      create: {
        userId,
        organizationId,
        start: new Date(event.start.dateTime),
        end: new Date(event.end.dateTime),
        metadata: {
          siteName: extractSiteName(event.summary),
          activityType: extractActivityType(event.description)
        }
      },
      update: { ... }
    });
  }
}
```

---

## ğŸ”® Phase 1 ä»¥é™ã®æ‹¡å¼µè¨ˆç”»

### 1. å…¥å‡ºè·ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆç¾å ´STOCKï¼‰

#### æ–°ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆç·ç›£ä¿®æ‰¿èªå¾Œï¼‰

```prisma
model Shipment {
  id             String   @id @default(uuid())
  scheduleId     String
  organizationId String
  itemName       String
  quantity       Int
  type           String   // "å…¥è·" / "å‡ºè·"
  
  schedule       Schedule @relation(fields: [scheduleId], references: [id])
  organization   Organization @relation(fields: [organizationId], references: [id])
}
```

---

### 2. ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯ï¼ˆç¾å ´ALCOHOLï¼‰

#### æ–°ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆç·ç›£ä¿®æ‰¿èªå¾Œï¼‰

```prisma
model AlcoholCheck {
  id             String   @id @default(uuid())
  userId         String
  organizationId String
  vehicleId      String?
  result         String   // "åˆæ ¼" / "ä¸åˆæ ¼"
  checkedAt      DateTime @default(now())
  
  user           User @relation(fields: [userId], references: [id])
  organization   Organization @relation(fields: [organizationId], references: [id])
}
```

---

## ğŸ”— é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- `docs/SSOT_GENBA_WEEK.md` - è¨­è¨ˆSSOT
- `docs/phase0_weak_current_spec.md` - è©³ç´°ä»•æ§˜
- `docs/TEST_STRATEGY.md` - ãƒ†ã‚¹ãƒˆæˆ¦ç•¥
- `docs/QUALITY_MANAGEMENT_OVERVIEW.md` - å“è³ªç®¡ç†

---

**ã“ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¯ã€Phase 1 ä»¥é™ã®æ‹¡å¼µã‚’è¦‹æ®ãˆãŸè¨­è¨ˆã¨ãªã£ã¦ã„ã¾ã™ã€‚**


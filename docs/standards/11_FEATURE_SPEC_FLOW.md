# 11_FEATURE_SPEC_FLOW.md - 個別機能SSOT完成プロセス

> 個別機能をジャンル分けし、親タスク→小タスクに分解し、
> AIヒアリングで仕様を確定し、国際標準SSOTに落とし込み、
> 監査で品質を保証するプロセス

---

## 全体フロー

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  ① 概要ドキュメント完成（PRD + 機能カタログ）
        │
        ▼
  ② AIにより機能を共通機能 / 個別機能に切り分け
        │
        ├─→ 共通機能 → 既存フロー（Phase 2 A〜H）で処理
        │
        ▼
  ③ 個別機能をジャンル分け
        │
        ▼
  ④ ジャンルごとに親タスクを作成
        │
        ▼
  ⑤ 各親タスク内で小タスクを作成
        │
        ▼
  ⑥ 親タスクごとにAIが機能の内容を把握、SSOT作成開始
        │
        ▼
  ⑦ 確認点を全て漏れなくリストし、ヒアリング
     （推奨パターン・モデルケースを必ず提示）
        │
        ▼
  ⑧ SSOTフォーマット（IEEE/ISO準拠）に落とし込む
        │
        ▼
  ⑨ 既存ドキュメントとの矛盾・重複チェック
        │
        ▼
  ⑩ SSOT監査（ISO/IEEE準拠 品質スコア95点以上で合格）
        │
        ▼
  ⑪ 1親タスクのSSOT完成 ✅ → 次の親タスクへ

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## ② 共通機能 / 個別機能の切り分け

### 切り分け基準

| 基準 | 共通機能 | 個別機能 |
|------|---------|---------|
| 他プロジェクトでも使うか | Yes | No |
| 業界標準パターンがあるか | Yes | No |
| 独自ビジネスロジック | 少ない | 多い |
| 外部ライブラリで実現可能か | Yes | No |

**判定ルール: 上記4つのうち3つ以上Yesなら共通機能**

### AIへの指示

```
機能カタログ（SSOT-1）の全機能について、
以下の4基準で共通/個別を判定してください:

1. 他プロジェクトでも使えるか
2. 業界標準のパターンがあるか
3. 独自ビジネスロジックが少ないか
4. 外部ライブラリで主に実現できるか

3つ以上Yesなら共通機能、それ以外は個別機能です。

判定結果を以下の表で出力してください:

| 機能ID | 機能名 | 判定 | 理由 |
```

---

## ③ 個別機能のジャンル分け

### ジャンル分類の目的

```
問題:
  個別機能が10個あるとして、バラバラにヒアリングすると:
  - 関連する機能間の整合性が取れない
  - 同じことを何度も聞くことになる
  - 共通のデータモデルがバラバラに定義される

解決:
  関連する機能をジャンルでまとめ、
  親タスク単位でSSO化する
```

### ジャンル分類の基準

```
以下の観点で個別機能をグルーピングする:

1. 同じデータを扱う機能をまとめる
   例: 「レシピ作成」「レシピ検索」「レシピ共有」→ ジャンル: レシピ管理

2. 同じユーザーフローに属する機能をまとめる
   例: 「画像アップロード」「AI分析」「結果表示」→ ジャンル: 画像分析フロー

3. 同じ外部サービスに依存する機能をまとめる
   例: 「Stripe決済」「プラン変更」「請求書発行」→ ジャンル: 課金管理

4. 単独で完結する機能はそのままジャンル化
   例: 「AIレコメンド」→ ジャンル: レコメンドエンジン
```

### AIへの指示

```
個別機能として判定された機能を、
関連性に基づいてジャンル分けしてください。

グルーピングの基準:
- 同じデータを扱う機能
- 同じユーザーフローに属する機能
- 同じ外部サービスに依存する機能

以下の形式で出力してください:

ジャンルA: [ジャンル名]
  理由: [なぜこのグループか]
  含む機能:
  - FEAT-001: [機能名]
  - FEAT-002: [機能名]
  共通のデータ: [このジャンルで共有するデータ]

ジャンルB: [ジャンル名]
  ...
```

---

## ④ 親タスクの作成

### 親タスクの定義

```
親タスク = ジャンル1つ分のSSOT完成

親タスクには以下を定義:

┌─ 親タスク定義 ──────────────────────────────────┐
│                                                    │
│ 親タスクID: PT-001                                │
│ ジャンル名: [例: 画像分析フロー]                  │
│                                                    │
│ 含む機能:                                         │
│   - FEAT-001: 画像アップロード                    │
│   - FEAT-002: AI画像分析                          │
│   - FEAT-003: 分析結果表示                        │
│   - FEAT-004: 分析履歴                            │
│                                                    │
│ 共通データモデル: 画像、分析結果、栄養素データ    │
│ 依存する外部サービス: OpenAI Vision API           │
│                                                    │
│ 推定ヒアリング時間: 60-90分                       │
│ SSOT生成物:                                       │
│   - 機能仕様書 × 4本                             │
│   - SSOT-2 UI追記                                 │
│   - SSOT-3 API追記                                │
│   - SSOT-4 DB追記                                 │
│                                                    │
└────────────────────────────────────────────────────┘
```

---

## ⑤ 小タスクの作成

### 親タスク内の機能を小タスクに分解

```
親タスク PT-001: 画像分析フロー
  │
  ├── ST-001: 画像アップロード
  │     入力: 画像ファイル
  │     出力: 保存された画像ID
  │     依存: なし
  │
  ├── ST-002: AI画像分析
  │     入力: 画像ID
  │     出力: 分析結果データ
  │     依存: ST-001
  │
  ├── ST-003: 分析結果表示
  │     入力: 分析結果データ
  │     出力: UI画面
  │     依存: ST-002
  │
  └── ST-004: 分析履歴
        入力: ユーザーID
        出力: 過去の分析結果一覧
        依存: ST-002
```

### AIへの指示

```
親タスク [PT-XXX: ジャンル名] を小タスクに分解してください。

各小タスクについて:
- 小タスクID（ST-XXX）
- 機能名
- 入力と出力
- 他の小タスクへの依存
- ヒアリングの順序（依存関係に基づく）

依存関係のない小タスクから順にヒアリングを行います。
```

---

## ⑥ AIによる内容把握（親タスク単位）

### 親タスク全体の概要把握

```
親タスクのヒアリングを開始する前に、
AIがまず親タスク全体を理解するステップ。

質問（4問、固定）:
──────────────────────────────────

PT-1 「[ジャンル名]全体について説明してください。
      このジャンルの機能群で、ユーザーが最終的に
      達成したいことは何ですか？」

PT-2 「これらの機能を使う一連の流れを、
      ユーザーの操作ステップで教えてください。

      例:
      1. ○○画面を開く
      2. ○○を入力する
      3. ○○ボタンを押す
      4. 結果が表示される」

PT-3 「このジャンルで最も重要な機能はどれですか？
      逆に、後回しにできるものはどれですか？」

PT-4 「参考にしたいサービスはありますか？
      『○○の△△機能みたいなもの』のような
      イメージがあれば教えてください。」
```

### 概要把握後のAI確認

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 📋 親タスク PT-XXX: [ジャンル名] 概要確認
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

■ このジャンルの目的
  [AIが1-2文で要約]

■ ユーザーの操作フロー
  [ステップを整理]

■ 小タスクの関係
  ST-001 → ST-002 → ST-003
                  └→ ST-004

■ 優先順位
  最重要: [機能名]
  後回し可: [機能名]

この理解で合っていますか？
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## ⑦ 確認点の網羅的リスト + ヒアリング

### AIが確認点を動的生成する際の必須観点（12分類）

```
AIへの内部指示:
──────────────────────────────────

親タスクの概要と各小タスクの内容をもとに、
以下の12分類から該当する確認点を漏れなく洗い出し、
ヒアリング項目を生成してください。

【データ系】
 D1. データ項目・型・制約
 D2. データの取得元（入力/API/DB/計算）
 D3. データのバリデーションルール
 D4. データ量・増加速度
 D5. データの保持期間・アーカイブ

【処理系】
 P1. 処理の各ステップの詳細ロジック
 P2. 分岐条件（if A then X, if B then Y）
 P3. 外部サービス/APIの利用
 P4. 処理時間の許容範囲
 P5. 同期処理 / 非同期処理
 P6. バッチ処理 / リアルタイム処理
 P7. リトライ・冪等性

【UI/UX系】
 U1. 画面レイアウト・構成
 U2. 操作フロー（クリック数、遷移）
 U3. レスポンシブ対応
 U4. ローディング・プログレス表示
 U5. エラー時のUI表現
 U6. 空状態（データなし）の表示

【権限・セキュリティ系】
 S1. 誰がアクセスできるか
 S2. プランによる制限
 S3. レートリミット
 S4. 個人情報の取り扱い

【状態管理系】
 M1. 状態の種類（下書き/処理中/完了等）
 M2. 状態遷移ルール
 M3. 中断・再開の可否
 M4. 並行操作（同時編集）

【エラー・例外系】
 E1. 入力不正時の動作
 E2. 外部サービス障害時の動作
 E3. タイムアウト時の動作
 E4. データ不整合時の動作

生成ルール:
- 関連する分類のみ選択（全部聞かない）
- 各確認点に推奨パターンを必ず提示
- 選択式を優先
- 「おまかせ」選択肢を必ず含める
- 1回のヒアリングは15問以内
```

### ★ 推奨パターン・モデルケースの提示ルール

```
全ての質問で、以下を必ず含めること:

1. 推奨パターン（★マーク）
   理由付きで「こうするのが一般的」を示す

2. 具体的なモデルケース
   実際のサービスでの実装例を提示

3. 技術レベル別の推奨
   ユーザーの技術レベルに応じた選択肢

例:
──────────────────────────────────
「AI分析の結果をキャッシュしますか？

 a) キャッシュしない（毎回APIを呼ぶ）
 b) 同じ画像なら結果をキャッシュする ★推奨
    理由: API コスト削減 + 応答速度向上
    モデルケース: Google Lensは同一画像のキャッシュを活用
 c) 全結果を永続保存
 d) おまかせ」

「分析結果の表示形式は？

 a) テキストのみ
 b) テキスト + 簡易グラフ ★推奨
    理由: 視覚的にわかりやすく、実装コストも低い
    モデルケース: MyFitnessPalのカロリー表示
 c) インタラクティブなダッシュボード
    ※ 実装コスト高。MVPでは b) から始めて
      後から拡張するパターンが一般的
 d) おまかせ」
──────────────────────────────────
```

### 「ユーザーが答えられない」場合の対処

```
ユーザーが答えられない3パターンと対処:

1.「わからない」
   → 推奨パターンを説明し、「推奨でいいですか？」と確認
   → 「わからない」=「おまかせ」として推奨を採用

2.「質問の意味がわからない」
   → 技術用語を使わず、具体例で再質問
   → 「例えば、Instagramで写真をアップする時のように、
      複数枚を一度に選べるようにしますか？
      それとも1枚ずつですか？」

3.「まだ決められない」
   → 「後で変更できるので、まずは推奨で進めましょう」
   → SSOTに「TBD（要再検討）」として記録
   → 最終監査時にTBD項目がゼロであることを確認
```

---

## ⑧ SSOT フォーマットへの落とし込み

> 詳細: **12_SSOT_FORMAT.md**

### 準拠規格

```
IEEE/ISO/IEC 29148:2018 - 要件エンジニアリング
IEEE 830 - ソフトウェア要求仕様書
RFC 2119 - 要求レベル定義（MUST/SHOULD/MAY）
ISO 25010 - ソフトウェア品質特性
```

### SSOTの構成（全12セクション）

```
§1  文書情報（ID、バージョン、ステータス、最終更新）
§2  機能概要（目的、スコープ、ユーザーストーリー）
§3  機能要件（RFC 2119準拠: MUST/SHOULD/MAY）
§4  データ仕様（項目、型、制約、バリデーション）
§5  API仕様（エンドポイント、リクエスト/レスポンス型）
§6  UI仕様（画面構成、状態遷移、操作フロー）
§7  ビジネスルール（条件分岐、計算式、制約）
§8  非機能要件（性能、セキュリティ、可用性）
§9  エラーハンドリング（エラーケース、復旧手順）
§10 テストケース（正常系、異常系、境界値）
§11 依存関係・影響範囲（他機能、外部サービス）
§12 未決定事項・制約（TBD項目、前提条件）
```

---

## ⑨ 既存ドキュメントとの整合性チェック

### チェック対象

```
新規SSOTを以下の全ドキュメントと照合する:

1. SSOT-0 PRD
   - 機能のスコープがPRDの定義と一致するか
   - PRDの成功指標と矛盾しないか

2. SSOT-1 機能カタログ
   - 機能IDと名称が一致するか
   - 優先度と一致するか
   - 依存関係が正しいか

3. SSOT-2 UI/状態遷移
   - 画面定義が既存の画面一覧と一致するか
   - 状態遷移が既存定義と矛盾しないか
   - 同じ画面を複数SSOTが異なる定義をしていないか

4. SSOT-3 API規約
   - エンドポイントの命名規約に従っているか
   - リクエスト/レスポンス形式が規約通りか
   - 既存エンドポイントとの重複・衝突がないか

5. SSOT-4 データモデル
   - テーブル/カラム名が既存と一致するか
   - リレーションが既存のER図と矛盾しないか
   - 同じデータを複数テーブルで重複定義していないか

6. SSOT-5 横断的関心事
   - 認証・認可ルールに従っているか
   - エラーハンドリングが統一規約に従っているか
   - ログ出力が統一形式か

7. 同ジャンルの他SSOT
   - 共通データモデルが一致しているか
   - 小タスク間の入出力が整合しているか

8. 他ジャンルのSSOT（完成済みのもの）
   - 同じ機能が重複定義されていないか
   - 共有リソースの競合がないか
```

### AIへの指示

```
作成した [機能ID] のSSOTを、以下のドキュメントと照合し、
矛盾・重複・不整合を全てリストしてください。

照合対象:
[上記8つのドキュメントを列挙]

出力形式:
| # | 種別 | 対象ドキュメント | 該当箇所 | 問題内容 | 重大度 | 修正案 |
|---|------|----------------|---------|---------|--------|-------|

種別: 矛盾 / 重複 / 不整合 / 欠落
重大度: Critical / Major / Minor

Critical が1つでもあれば修正必須。
全てのCritical/Majorが解消されるまで⑩に進まない。
```

---

## ⑩ SSOT 監査

> 詳細: **13_SSOT_AUDIT.md**

### 監査基準（10カテゴリ・100点満点）

```
ISO/IEC 25010 品質特性 + IEEE 29148 要件品質をベースに構成

┌─ SSOT品質監査スコアカード ─────────────────────────────┐
│                                                          │
│  カテゴリ           配点   基準                          │
│  ─────────────────────────────────────────────────────  │
│  1. 完全性           15   全セクションが記載されているか  │
│  2. 一貫性           15   内部矛盾がないか               │
│  3. 明確性           10   曖昧な表現がないか             │
│  4. 検証可能性       10   テスト可能な記述か             │
│  5. 追跡可能性       10   PRD→機能→テストの追跡可能か   │
│  6. 実現可能性       10   技術的に実装可能か             │
│  7. RFC 2119準拠     10   MUST/SHOULD/MAYが適切か        │
│  8. テストカバレッジ  10   正常/異常/境界値が網羅か       │
│  9. 整合性           5    他SSOTとの整合                  │
│  10. 文書品質         5    フォーマット・可読性           │
│                                                          │
│  合計              100                                   │
│  合格ライン:        95点以上                             │
│                                                          │
└──────────────────────────────────────────────────────────┘
```

### 合格条件

```
95点以上: 合格 → SSOT完成 ✅
90-94点: 条件付き合格 → 指摘事項を修正後に再監査
89点以下: 不合格 → 該当セクションを作り直し

かつ以下の絶対条件:
- TBD項目がゼロ
- Critical指摘がゼロ
- ⑨の整合性チェックでCritical/Majorがゼロ
```

---

## 全体タイムライン（親タスク1つあたり）

| ステップ | 所要時間 | 内容 |
|---------|---------|------|
| ⑥ 概要把握 | 10-15分 | 親タスク全体の理解 |
| ⑦ ヒアリング | 30-60分 | 確認点リスト + 回答（小タスク全て） |
| ⑧ SSOT作成 | AI生成 | フォーマットに落とし込み |
| ⑨ 整合性チェック | AI実行 | 既存ドキュメントとの照合 |
| ⑩ 監査 | AI実行 | スコアリング + 修正 |
| **合計** | **1-2時間/親タスク** | |

---

## 変更履歴

| 日付 | 変更内容 | 変更者 |
|------|---------|-------|
| | 初版作成 | |

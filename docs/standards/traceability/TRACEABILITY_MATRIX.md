# TRACEABILITY_MATRIX.md - トレーサビリティマトリクス

> 要求 → 機能 → 画面 → API → データ → テスト の追跡可能性を確保

---

## 目的

1. **抜け漏れ検出**: 要求に対応する実装・テストがあるか確認
2. **影響分析**: 変更時に影響範囲を特定
3. **品質担保**: 全要求がテストされていることを保証

---

## トレーサビリティチェーン

```
┌──────────────┐
│  ユースケース  │  SSOT-0（PRD）
│   UC-xxx     │
└──────┬───────┘
       │
       ▼
┌──────────────┐
│    機能      │  SSOT-1 + features/*.md
│  FEAT-xxx    │
└──────┬───────┘
       │
       ├────────────┬────────────┬────────────┐
       ▼            ▼            ▼            ▼
┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐
│   画面   │ │   API    │ │  データ  │ │ ビジネス │
│ SCR-xxx  │ │ API-xxx  │ │ TBL-xxx  │ │ ロジック │
└────┬─────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘
     │            │            │            │
     └────────────┴────────────┴────────────┘
                        │
                        ▼
               ┌──────────────┐
               │   テスト     │
               │   TC-xxx     │
               └──────────────┘
```

---

## 1. ユースケース → 機能 マトリクス

| ユースケースID | ユースケース名 | 機能ID | 機能名 | 状態 |
|--------------|--------------|--------|-------|------|
| UC-001 | ユーザー認証 | AUTH-001 | ログイン | |
| UC-001 | ユーザー認証 | AUTH-002 | OAuth（Google） | |
| UC-001 | ユーザー認証 | AUTH-005 | ログアウト | |
| UC-002 | アカウント作成 | ACCT-001 | サインアップ | |
| UC-002 | アカウント作成 | AUTH-007 | メール認証 | |
| | | | | |

---

## 2. 機能 → 画面 マトリクス

| 機能ID | 機能名 | 画面ID | 画面名 | パス |
|--------|-------|--------|-------|------|
| AUTH-001 | ログイン | SCR-LOGIN | ログイン画面 | /login |
| AUTH-001 | ログイン | SCR-DASHBOARD | ダッシュボード | /app |
| AUTH-002 | OAuth（Google） | SCR-LOGIN | ログイン画面 | /login |
| AUTH-005 | ログアウト | SCR-LOGIN | ログイン画面 | /login |
| AUTH-006 | パスワードリセット | SCR-FORGOT-PW | パスワード忘れ | /forgot-password |
| AUTH-006 | パスワードリセット | SCR-RESET-PW | パスワードリセット | /reset-password |
| | | | | |

---

## 3. 機能 → API マトリクス

| 機能ID | 機能名 | API ID | メソッド | エンドポイント |
|--------|-------|--------|---------|--------------|
| AUTH-001 | ログイン | API-001 | POST | /api/v1/auth/login |
| AUTH-002 | OAuth（Google） | API-002 | GET | /api/v1/auth/google |
| AUTH-002 | OAuth（Google） | API-003 | GET | /api/v1/auth/google/callback |
| AUTH-005 | ログアウト | API-004 | POST | /api/v1/auth/logout |
| AUTH-006 | パスワードリセット | API-005 | POST | /api/v1/auth/forgot-password |
| AUTH-006 | パスワードリセット | API-006 | POST | /api/v1/auth/reset-password |
| AUTH-010 | セッション更新 | API-007 | POST | /api/v1/auth/refresh |
| | | | | |

---

## 4. 機能 → データ マトリクス

| 機能ID | 機能名 | テーブル | 操作 | カラム |
|--------|-------|---------|------|-------|
| AUTH-001 | ログイン | users | READ | email, password_hash, status |
| AUTH-001 | ログイン | users | UPDATE | last_login_at |
| AUTH-001 | ログイン | sessions | CREATE | * |
| AUTH-001 | ログイン | login_attempts | CREATE | * |
| AUTH-002 | OAuth | oauth_accounts | READ/CREATE | * |
| AUTH-005 | ログアウト | sessions | UPDATE | revoked_at |
| | | | | |

---

## 5. 機能 → テスト マトリクス

| 機能ID | 機能名 | テストID | テスト種別 | テストケース |
|--------|-------|---------|----------|-------------|
| AUTH-001 | ログイン | TC-AUTH-001-01 | Unit | 正しい認証情報でログイン成功 |
| AUTH-001 | ログイン | TC-AUTH-001-02 | Unit | 不正なパスワードでログイン失敗 |
| AUTH-001 | ログイン | TC-AUTH-001-03 | Unit | 存在しないメールでログイン失敗 |
| AUTH-001 | ログイン | TC-AUTH-001-04 | Unit | アカウントロック時にログイン失敗 |
| AUTH-001 | ログイン | TC-AUTH-001-05 | Integration | 5回失敗でアカウントロック |
| AUTH-001 | ログイン | TC-AUTH-001-06 | E2E | 正常ログインフロー |
| AUTH-001 | ログイン | TC-AUTH-001-07 | E2E | nextパラメータでリダイレクト |
| | | | | |

---

## 6. 受入条件 → テスト マトリクス

| 機能ID | 受入条件ID | 受入条件 | テストID | 検証結果 |
|--------|-----------|---------|---------|---------|
| AUTH-001 | AC-001 | 正しい認証情報でログイン成功 | TC-AUTH-001-01 | ☐ |
| AUTH-001 | AC-002 | ログイン成功後/appに遷移 | TC-AUTH-001-06 | ☐ |
| AUTH-001 | AC-003 | nextパラメータで指定URLに遷移 | TC-AUTH-001-07 | ☐ |
| AUTH-001 | AC-101 | 不正パスワードでエラー表示 | TC-AUTH-001-02 | ☐ |
| AUTH-001 | AC-102 | 存在しないメールで同じエラー | TC-AUTH-001-03 | ☐ |
| AUTH-001 | AC-201 | 5回失敗で30分ロック | TC-AUTH-001-05 | ☐ |
| | | | | |

---

## 7. 完全性チェック

### 7.1 要求カバレッジ

| 項目 | 総数 | カバー済 | カバレッジ |
|------|------|---------|----------|
| ユースケース | | | __% |
| 機能 | | | __% |
| 受入条件 | | | __% |

### 7.2 未対応項目

#### 実装なしの機能

| 機能ID | 機能名 | 理由 | 対応予定 |
|--------|-------|------|---------|
| | | | |

#### テストなしの受入条件

| 機能ID | 受入条件ID | 受入条件 | 理由 |
|--------|-----------|---------|------|
| | | | |

---

## 8. 変更影響分析

### 分析手順

```
1. 変更対象を特定（機能/画面/API/データ）
2. マトリクスで上流・下流を確認
3. 影響範囲を一覧化
4. 必要なテストを特定
```

### 分析テンプレート

```markdown
## 変更影響分析

### 変更内容
- 対象: {機能ID / API / テーブル}
- 変更種別: {追加 / 変更 / 削除}
- 変更内容: {詳細}

### 影響範囲

#### 上流影響（この変更が影響を受けるもの）
- ユースケース: 
- 機能: 

#### 下流影響（この変更が影響を与えるもの）
- 画面: 
- API: 
- テーブル: 
- テスト: 

### 必要なアクション
- [ ] ドキュメント更新: 
- [ ] コード修正: 
- [ ] テスト追加/修正: 
```

---

## 9. メンテナンスルール

### 更新タイミング

| イベント | 更新対象 |
|---------|---------|
| 新機能追加 | 全マトリクス |
| 機能変更 | 関連するマトリクス |
| API追加/変更 | 機能→API、受入条件→テスト |
| テーブル変更 | 機能→データ |
| テスト追加 | 機能→テスト、受入条件→テスト |

### 整合性チェック

定期的に以下を確認：

- [ ] 全機能に画面が紐づいている
- [ ] 全機能にAPIが紐づいている（該当する場合）
- [ ] 全機能にデータが紐づいている（該当する場合）
- [ ] 全受入条件にテストが紐づいている
- [ ] 孤立した画面/API/テーブルがない

---

## 変更履歴

| 日付 | 変更内容 | 変更者 |
|------|---------|-------|
| | 初版作成 | |

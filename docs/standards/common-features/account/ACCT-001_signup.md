# ACCT-001: サインアップ機能

> 🏷️ **種別**: 共通機能（カスタマイズレベル: 中）

---

## 🔧 カスタマイズポイント

この仕様書をプロジェクトで使用する際、以下の箇所をカスタマイズできます。

| セクション | カスタマイズ箇所 | 必須/任意 | デフォルト |
|-----------|----------------|----------|-----------|
| 3.3 | 入力フィールド | **必須** | name, email, password |
| 5.2 | リクエストフィールド | **必須** | 上記に対応 |
| 6.2 | usersテーブルのカラム | **必須** | 標準カラムのみ |
| 2.1 | パスワード要件 | 任意 | 8文字以上 |
| 3.2 | UIレイアウト | 任意 | 標準レイアウト |
| 7.2 | 追加のビジネスルール | 任意 | なし |

### よくあるカスタマイズ例

**フィールド追加**:
```diff
# 3.3 UI要素詳細に追加
+ | 電話番号 | input[type=tel] | 任意、E.164形式 | |
+ | 会社名 | input[type=text] | 任意、100文字以下 | |

# 5.2 リクエストに追加
+ "phone": "+819012345678",
+ "company": "株式会社Example",

# 6.2 usersテーブルに追加
+ | phone | VARCHAR(20) | YES | - | 電話番号 |
+ | company | VARCHAR(100) | YES | - | 会社名 |
```

**パスワード要件の強化**:
```diff
# 2.1 AC-003を変更
- | AC-003 | パスワードが8文字未満の場合、エラー |
+ | AC-003 | パスワードが12文字未満、または大文字・小文字・数字・記号を含まない場合、エラー |
```

**変更したら `CUSTOMIZATION_LOG.md` に記録してください。**

---

## メタ情報

| 項目 | 内容 |
|------|------|
| 機能ID | ACCT-001 |
| 機能名 | サインアップ機能 |
| カテゴリ | アカウント |
| 優先度 | P0 |
| ステータス | 共通機能（完成済み） |
| 依存機能 | なし |

---

## 1. 概要

### 1.1 機能の目的

新規ユーザーがアカウントを作成し、サービスを利用開始できるようにする機能。

### 1.2 ユーザーストーリー

```
As a 新規ユーザー,
I want to アカウントを作成したい,
so that サービスを利用できる.
```

### 1.3 スコープ

**In Scope**:
- ユーザー情報の入力・バリデーション
- アカウントの作成
- 確認メールの送信（AUTH-007と連携）
- サインアップ後の自動ログイン

**Out of Scope**:
- ソーシャルサインアップ（AUTH-002, AUTH-003で対応）
- 招待制サインアップ
- 管理者によるユーザー作成

---

## 2. 受入条件（Acceptance Criteria）

### 2.1 正常系

| # | 条件 | 検証方法 |
|---|------|---------|
| AC-001 | 有効な情報を入力してサインアップすると、アカウントが作成される | ユニットテスト |
| AC-002 | サインアップ成功後、確認メールが送信される | 統合テスト |
| AC-003 | サインアップ成功後、自動的にログイン状態になる | E2Eテスト |
| AC-004 | サインアップ成功後、ダッシュボード（/app）に遷移する | E2Eテスト |

### 2.2 異常系

| # | 条件 | 検証方法 |
|---|------|---------|
| AC-101 | 既に登録済みのメールアドレスの場合、「このメールアドレスは既に使用されています」エラー | ユニットテスト |
| AC-102 | メールアドレスが不正な形式の場合、「有効なメールアドレスを入力してください」エラー | ユニットテスト |
| AC-103 | パスワードが8文字未満の場合、「パスワードは8文字以上で入力してください」エラー | ユニットテスト |
| AC-104 | パスワードと確認用パスワードが一致しない場合、「パスワードが一致しません」エラー | ユニットテスト |
| AC-105 | 名前が空の場合、「名前を入力してください」エラー | ユニットテスト |
| AC-106 | 名前が100文字を超える場合、「名前は100文字以内で入力してください」エラー | ユニットテスト |
| AC-107 | 利用規約に同意していない場合、「利用規約への同意が必要です」エラー | ユニットテスト |

### 2.3 エッジケース

| # | 条件 | 検証方法 |
|---|------|---------|
| AC-201 | メール送信に失敗してもアカウントは作成される（後で再送可能） | 統合テスト |
| AC-202 | 同時に同じメールアドレスでサインアップしようとした場合、1つだけ成功する | 統合テスト |
| AC-203 | サインアップ処理中にネットワークエラーが発生した場合、適切なエラーメッセージを表示 | E2Eテスト |

---

## 3. UI仕様

### 3.1 画面一覧

| Screen ID | 画面名 | パス | 認証 |
|-----------|-------|------|------|
| SCR-SIGNUP | サインアップ画面 | /signup | 不要 |

### 3.2 画面レイアウト

```
┌─────────────────────────────────────────────────┐
│                    [ロゴ]                        │
│                                                 │
│             アカウントを作成                      │
│                                                 │
├─────────────────────────────────────────────────┤
│                                                 │
│   ┌───────────────────────────────────────┐    │
│   │  エラーメッセージバナー（エラー時のみ）  │    │
│   └───────────────────────────────────────┘    │
│                                                 │
│   名前 *                                        │
│   ┌───────────────────────────────────────┐    │
│   │ 山田 太郎                              │    │
│   └───────────────────────────────────────┘    │
│   [フィールドエラー]                            │
│                                                 │
│   メールアドレス *                               │
│   ┌───────────────────────────────────────┐    │
│   │ example@email.com                     │    │
│   └───────────────────────────────────────┘    │
│   [フィールドエラー]                            │
│                                                 │
│   パスワード *                                  │
│   ┌───────────────────────────────────────┐    │
│   │ ••••••••                          [👁] │    │
│   └───────────────────────────────────────┘    │
│   パスワードは8文字以上で入力してください         │
│   [フィールドエラー]                            │
│                                                 │
│   パスワード（確認） *                           │
│   ┌───────────────────────────────────────┐    │
│   │ ••••••••                          [👁] │    │
│   └───────────────────────────────────────┘    │
│   [フィールドエラー]                            │
│                                                 │
│   🔧 [追加フィールドをここに挿入]                │
│                                                 │
│   [✓] 利用規約とプライバシーポリシーに同意する    │
│   [フィールドエラー]                            │
│                                                 │
│   ┌───────────────────────────────────────┐    │
│   │           アカウントを作成             │    │
│   └───────────────────────────────────────┘    │
│                                                 │
│   ──────────── または ────────────             │
│                                                 │
│   [G] Googleで登録                              │
│                                                 │
│   すでにアカウントをお持ちの方 → ログイン         │
│                                                 │
└─────────────────────────────────────────────────┘
```

### 3.3 UI要素詳細

> 🔧 **カスタマイズポイント**: フィールドの追加・削除はここで行う

| 要素 | 種類 | バリデーション | 備考 |
|------|------|--------------|------|
| 名前 | input[type=text] | 必須、1-100文字 | |
| メールアドレス | input[type=email] | 必須、メール形式、最大255文字 | |
| パスワード | input[type=password] | 必須、8文字以上 | 表示トグルあり、強度インジケーター |
| パスワード（確認） | input[type=password] | 必須、パスワードと一致 | 表示トグルあり |
| 利用規約同意 | checkbox | 必須 | リンク付き |
| 登録ボタン | button[type=submit] | - | プライマリカラー |

### 3.4 パスワード強度インジケーター

| 強度 | 条件 | 表示 |
|------|------|------|
| 弱 | 8文字以上のみ | 赤バー 33% |
| 中 | 大文字 or 数字を含む | 黄バー 66% |
| 強 | 大文字 + 数字 + 記号を含む | 緑バー 100% |

### 3.5 状態別表示

| 状態 | 表示 |
|------|------|
| 初期 | フォーム表示 |
| 入力中 | リアルタイムバリデーション |
| バリデーションエラー | フィールド下にエラー、枠を赤色 |
| 送信中 | ボタン無効 + スピナー |
| 成功 | /app へリダイレクト |

---

## 4. 状態遷移

### 4.1 遷移図

```
┌─────────────┐
│  S0: 未認証  │
└──────┬──────┘
       │
  submit_signup
       │
┌──────▼──────┐
│   処理中     │
└──────┬──────┘
       │
  ┌────┴────┐
  │         │
success   failure
  │         │
  ▼         ▼
┌─────┐  ┌────────┐
│ S1  │  │エラー表示│
│→/app│  │→フォーム│
└─────┘  └────────┘
```

### 4.2 遷移ルール

| 現在の状態 | イベント | 次の状態 | アクション |
|-----------|---------|---------|-----------|
| S0 | ページアクセス | S0 | フォーム表示 |
| S0 | submit（成功） | S1 | アカウント作成 + 自動ログイン + /app遷移 |
| S0 | submit（失敗） | S0 | エラー表示 |
| S1 | ページアクセス | S1 | /app へリダイレクト |

---

## 5. API仕様

### 5.1 エンドポイント

| メソッド | パス | 説明 | 認証 |
|---------|------|------|------|
| POST | /api/v1/auth/signup | サインアップ | 不要 |

### 5.2 POST /api/v1/auth/signup

> 🔧 **カスタマイズポイント**: フィールド追加時はここを変更

**リクエスト**:

```json
{
  "name": "山田 太郎",
  "email": "user@example.com",
  "password": "password123",
  "password_confirmation": "password123",
  "terms_accepted": true
}
```

| フィールド | 型 | 必須 | バリデーション |
|-----------|-----|------|--------------|
| name | string | ✅ | 1-100文字 |
| email | string | ✅ | メール形式、最大255文字、未登録 |
| password | string | ✅ | 8文字以上、128文字以下 |
| password_confirmation | string | ✅ | passwordと一致 |
| terms_accepted | boolean | ✅ | true |

**レスポンス（成功）**: `201 Created`

```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIs...",
  "refresh_token": "eyJhbGciOiJIUzI1NiIs...",
  "token_type": "Bearer",
  "expires_in": 3600,
  "user": {
    "id": "usr_abc123def456",
    "email": "user@example.com",
    "name": "山田 太郎",
    "role": "user",
    "avatar_url": null,
    "email_verified": false
  }
}
```

**レスポンス（エラー）**:

| HTTPステータス | エラーコード | 条件 | メッセージ |
|--------------|-------------|------|-----------|
| 400 | VAL_001 | バリデーションエラー | "Validation failed" |
| 409 | RES_002 | メール重複 | "Email already registered" |
| 429 | RATE_001 | レート制限 | "Too many requests" |

**バリデーションエラー詳細**:

```json
{
  "error": {
    "code": "VAL_001",
    "message": "Validation failed",
    "details": {
      "fields": {
        "email": ["このメールアドレスは既に使用されています"],
        "password": ["パスワードは8文字以上で入力してください"],
        "password_confirmation": ["パスワードが一致しません"]
      }
    }
  }
}
```

---

## 6. データモデル

### 6.1 関連テーブル

| テーブル | 操作 | 内容 |
|---------|------|------|
| users | INSERT | 新規ユーザー作成 |
| sessions | INSERT | セッション作成（自動ログイン） |
| email_verifications | INSERT | 確認トークン作成 |

### 6.2 usersテーブル（新規レコード）

> 🔧 **カスタマイズポイント**: フィールド追加時はここにカラム追加

| カラム | 値 |
|--------|-----|
| id | 新規UUID（usr_xxx） |
| email | 入力値 |
| password_hash | bcrypt(password) |
| name | 入力値 |
| role | 'user' |
| status | 'active' |
| email_verified_at | NULL |
| created_at | NOW() |
| updated_at | NOW() |

### 6.3 email_verificationsテーブル（新規レコード）

| カラム | 値 |
|--------|-----|
| id | 新規UUID |
| user_id | 作成したユーザーID |
| token | ランダムトークン（ハッシュ化して保存） |
| expires_at | NOW() + 24時間 |
| created_at | NOW() |

---

## 7. ビジネスロジック

### 7.1 処理フロー

```
1. 入力バリデーション
   ├─ 必須チェック
   ├─ 形式チェック（メール、パスワード長）
   ├─ パスワード一致チェック
   ├─ 利用規約同意チェック
   └─ 失敗 → VAL_001

2. メール重複チェック
   └─ 重複 → RES_002

3. ユーザー作成
   ├─ パスワードをbcryptでハッシュ化（cost=12）
   └─ usersテーブルにINSERT

4. 確認メール準備
   ├─ 確認トークン生成
   ├─ email_verificationsテーブルにINSERT
   └─ メール送信キューに追加（非同期）

5. セッション作成（自動ログイン）
   ├─ sessionsテーブルにINSERT
   └─ JWT生成

6. レスポンス返却
   └─ 201 Created + トークン + ユーザー情報
```

### 7.2 追加のビジネスルール（任意）

> 🔧 **カスタマイズポイント**: プロジェクト固有のルールをここに追加

```
# 例: 招待コード必須の場合
4.5. 招待コード検証
    ├─ 招待コードが無効 → VAL_001（fields.invitation_code）
    └─ 有効 → 5へ

# 例: ドメイン制限の場合
2.5. ドメインチェック
    ├─ 許可ドメイン以外 → VAL_001（fields.email: "このドメインは登録できません"）
    └─ 許可ドメイン → 3へ
```

### 7.3 セキュリティ要件

| 要件 | 実装 |
|------|------|
| パスワードハッシュ | bcrypt（cost=12） |
| レート制限 | 同一IP: 5回/時間 |
| 確認トークン | crypto.randomBytes(32).toString('hex') |
| トークン保存 | ハッシュ化して保存 |

---

## 8. エラーハンドリング

### 8.1 フロントエンド

| エラー種別 | 表示方法 | メッセージ |
|-----------|---------|-----------|
| フィールドエラー | フィールド直下 | APIから返されたメッセージ |
| メール重複 | フォーム上部バナー | 「このメールアドレスは既に登録されています」 |
| レート制限 | フォーム上部バナー | 「しばらく時間をおいて再試行してください」 |
| ネットワークエラー | フォーム上部バナー | 「通信エラーが発生しました」 |

### 8.2 バックエンド

| エラー種別 | ログレベル | ログ内容 |
|-----------|-----------|---------|
| バリデーションエラー | DEBUG | リクエスト内容（パスワード除く） |
| メール重複 | INFO | email(masked) |
| メール送信失敗 | WARN | user_id, error |
| サーバーエラー | ERROR | スタックトレース |

---

## 9. テスト仕様

### 9.1 ユニットテスト

| テストID | テストケース | 期待結果 |
|----------|-------------|---------|
| TC-001 | 有効な情報でサインアップ | 201 + ユーザー作成 |
| TC-002 | メール重複 | 409 + RES_002 |
| TC-003 | 不正なメール形式 | 400 + VAL_001 |
| TC-004 | パスワード短すぎ | 400 + VAL_001 |
| TC-005 | パスワード不一致 | 400 + VAL_001 |
| TC-006 | 利用規約未同意 | 400 + VAL_001 |
| TC-007 | 名前が空 | 400 + VAL_001 |

### 9.2 統合テスト

| テストID | テストケース | 期待結果 |
|----------|-------------|---------|
| TC-101 | サインアップ→メール送信 | メールキューに追加 |
| TC-102 | 同時サインアップ（同一メール） | 1つだけ成功 |
| TC-103 | メール送信失敗 | ユーザーは作成される |

### 9.3 E2Eテスト

| テストID | テストケース | 期待結果 |
|----------|-------------|---------|
| TC-201 | 正常サインアップフロー | /app に遷移 |
| TC-202 | バリデーションエラー表示 | エラーメッセージ表示 |
| TC-203 | ログイン済みでアクセス | /app にリダイレクト |

---

## 10. 非機能要件

| 指標 | 目標値 |
|------|-------|
| API応答時間（p95） | < 1s（bcrypt含む） |
| ページ読み込み（LCP） | < 2.5秒 |

---

## 11. 依存関係

### 11.1 前提となる機能

なし

### 11.2 この機能に依存する機能

| 機能ID | 機能名 | 依存内容 |
|--------|-------|---------|
| AUTH-001 | ログイン | users テーブル |
| AUTH-007 | メール認証 | email_verifications テーブル |
| ACCT-002 | プロフィール表示 | users テーブル |

---

## 12. 実装メモ（AI向け）

### 12.1 実装順序

```
1. DBマイグレーション（必要に応じてカラム追加）
2. バックエンドAPI（POST /api/v1/auth/signup）
3. フロントエンドフォーム
4. テスト
5. メール送信連携（AUTH-007）
```

### 12.2 カスタマイズ確認

実装前に以下を確認：
- [ ] 追加フィールドがあるか（CUSTOMIZATION_LOG.md）
- [ ] パスワード要件に変更があるか
- [ ] 追加のビジネスルールがあるか

### 12.3 注意事項

- ⚠️ パスワードは絶対にログに出力しない
- ⚠️ メール送信は非同期で行う（APIレスポンスを遅延させない）
- ⚠️ bcryptのcostは12を使用（レスポンス時間に影響）
- ⚠️ 確認トークンはハッシュ化して保存

---

## 変更履歴

| 日付 | バージョン | 変更内容 | 変更者 |
|------|----------|---------|-------|
| | v1.0 | 共通機能として作成 | |

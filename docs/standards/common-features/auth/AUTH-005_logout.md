# AUTH-005: ログアウト機能

> 🏷️ **種別**: 共通機能（カスタマイズレベル: ほぼなし）

---

## 🔧 カスタマイズポイント

この仕様書をプロジェクトで使用する際、以下の箇所のみカスタマイズが必要です。

| セクション | カスタマイズ箇所 | 必須/任意 | 例 |
|-----------|----------------|----------|-----|
| 3.2 | ログアウト確認ダイアログのテキスト | 任意 | ブランドに合わせた文言 |
| 5.2 | APIベースURL | 必須 | /api/v1 → /api/v2 |
| - | ほぼ変更不要 | - | - |

**変更したら `CUSTOMIZATION_LOG.md` に記録してください。**

---

## メタ情報

| 項目 | 内容 |
|------|------|
| 機能ID | AUTH-005 |
| 機能名 | ログアウト機能 |
| カテゴリ | 認証・認可 |
| 優先度 | P0 |
| ステータス | 共通機能（完成済み） |
| 依存機能 | AUTH-001（ログイン） |

---

## 1. 概要

### 1.1 機能の目的

ユーザーが現在のセッションを終了し、ログアウト状態に戻る機能。

### 1.2 ユーザーストーリー

```
As a ログイン済みユーザー,
I want to ログアウトしたい,
so that セッションを安全に終了できる.
```

### 1.3 スコープ

**In Scope**:
- 現在のセッションの無効化
- トークンの破棄
- ログイン画面へのリダイレクト

**Out of Scope**:
- 全デバイスからのログアウト（AUTH-009で対応）
- ログアウト確認のメール通知

---

## 2. 受入条件（Acceptance Criteria）

### 2.1 正常系

| # | 条件 | 検証方法 |
|---|------|---------|
| AC-001 | ログアウトボタンをクリックすると、セッションが無効化される | 統合テスト |
| AC-002 | ログアウト後、ログイン画面（/login）にリダイレクトされる | E2Eテスト |
| AC-003 | ログアウト後、「ログアウトしました」のメッセージが表示される | E2Eテスト |
| AC-004 | ログアウト後、Protectedページにアクセスするとログイン画面にリダイレクトされる | E2Eテスト |

### 2.2 異常系

| # | 条件 | 検証方法 |
|---|------|---------|
| AC-101 | ネットワークエラー時でもローカルのトークンは削除される | ユニットテスト |
| AC-102 | すでにログアウト済みの状態でログアウトAPIを呼んでも200を返す（冪等性） | ユニットテスト |

### 2.3 エッジケース

| # | 条件 | 検証方法 |
|---|------|---------|
| AC-201 | 複数タブで開いている場合、他のタブも自動的にログアウト状態になる | E2Eテスト |
| AC-202 | ログアウト中に別のAPIリクエストが401を返しても、正常にログアウト処理が完了する | 統合テスト |

---

## 3. UI仕様

### 3.1 ログアウトボタンの配置

| 配置場所 | 要素 | 備考 |
|---------|------|------|
| ヘッダー（デスクトップ） | ユーザーメニュー内 | ドロップダウンの最下部 |
| サイドバー（モバイル） | メニュー最下部 | アイコン + テキスト |
| 設定画面 | アカウントセクション | ボタン形式 |

### 3.2 ログアウト確認（任意）

```
┌─────────────────────────────────────────┐
│                                         │
│   ログアウトしますか？                    │
│                                         │
│   [キャンセル]        [ログアウト]       │
│                                         │
└─────────────────────────────────────────┘
```

> 🔧 **カスタマイズポイント**: 確認ダイアログの要否、テキストを変更可能

### 3.3 状態別表示

| 状態 | 表示 |
|------|------|
| 初期 | ログアウトボタン有効 |
| 処理中 | ボタン無効 + スピナー |
| 完了 | ログイン画面へ遷移 + メッセージ |

---

## 4. 状態遷移

### 4.1 遷移図

```
┌─────────────┐
│  S1: 認証済み │
└──────┬──────┘
       │
  click_logout
       │
┌──────▼──────┐
│   処理中     │
└──────┬──────┘
       │
  ┌────┴────┐
  │         │
success   error
  │         │
  ▼         ▼
┌─────┐  ┌─────┐
│ S0  │  │ S0  │  ← エラーでもS0に遷移（ローカルトークン削除済み）
│遷移 │  │遷移 │
└─────┘  └─────┘
```

### 4.2 遷移ルール

| 現在の状態 | イベント | 次の状態 | アクション |
|-----------|---------|---------|-----------|
| S1 | click_logout | 処理中 | API呼び出し + ローカルトークン削除 |
| 処理中 | success | S0 | /login?reason=logout へ遷移 |
| 処理中 | error | S0 | /login?reason=logout へ遷移（エラーでも遷移） |

---

## 5. API仕様

### 5.1 エンドポイント

| メソッド | パス | 説明 | 認証 |
|---------|------|------|------|
| POST | /api/v1/auth/logout | ログアウト | 必要 |

### 5.2 POST /api/v1/auth/logout

**リクエスト**: ボディなし

**リクエストヘッダー**:
```
Authorization: Bearer {access_token}
```

**レスポンス（成功）**: `204 No Content`

**レスポンス（エラー）**:

| HTTPステータス | エラーコード | 条件 | メッセージ |
|--------------|-------------|------|-----------|
| 401 | AUTH_003 | トークン無効 | "Invalid token" |

> **注意**: 401エラーでもフロントエンドはローカルトークンを削除してログイン画面へ遷移する

---

## 6. データモデル

### 6.1 関連テーブル

| テーブル | 操作 | 内容 |
|---------|------|------|
| sessions | UPDATE | revoked_at = NOW() |

### 6.2 データ操作

```sql
UPDATE sessions 
SET revoked_at = NOW() 
WHERE id = :session_id 
  AND user_id = :user_id 
  AND revoked_at IS NULL;
```

---

## 7. ビジネスロジック

### 7.1 処理フロー

```
1. フロントエンド
   a. ローカルストレージ/Cookieのトークンを即座に削除
   b. ログアウトAPIを呼び出し
   c. 結果に関わらず /login?reason=logout へ遷移

2. バックエンド
   a. トークンからセッションIDを取得
   b. sessionsテーブルの該当レコードを無効化（revoked_at = NOW()）
   c. 204 No Content を返却
```

### 7.2 セキュリティ要件

| 要件 | 実装 |
|------|------|
| トークンの即時無効化 | フロントでローカル削除 + バックでDB無効化 |
| CSRF対策 | POSTメソッド + Bearerトークン認証 |

---

## 8. エラーハンドリング

### 8.1 フロントエンド

| エラー種別 | 処理 |
|-----------|------|
| ネットワークエラー | ローカルトークン削除済みなので、そのまま /login へ遷移 |
| 401エラー | すでにログアウト済みとみなし、/login へ遷移 |
| 500エラー | ローカルトークン削除済みなので、そのまま /login へ遷移 |

### 8.2 バックエンド

| エラー種別 | HTTPステータス | ログレベル |
|-----------|--------------|-----------|
| トークン無効 | 401 | DEBUG |
| セッションなし | 204（成功扱い） | DEBUG |
| サーバーエラー | 500 | ERROR |

---

## 9. テスト仕様

### 9.1 ユニットテスト

| テストID | テストケース | 期待結果 |
|----------|-------------|---------|
| TC-001 | 有効なトークンでログアウト | 204 + セッション無効化 |
| TC-002 | 無効なトークンでログアウト | 401 |
| TC-003 | すでに無効化されたセッション | 204（冪等性） |

### 9.2 E2Eテスト

| テストID | テストケース | 期待結果 |
|----------|-------------|---------|
| TC-101 | ログアウトフロー | /login へ遷移 + メッセージ表示 |
| TC-102 | ログアウト後にProtectedアクセス | /login へリダイレクト |

---

## 10. 非機能要件

| 指標 | 目標値 |
|------|-------|
| API応答時間（p95） | < 200ms |

---

## 11. 依存関係

### 11.1 前提となる機能

| 機能ID | 機能名 |
|--------|-------|
| AUTH-001 | ログイン |

### 11.2 この機能に依存する機能

なし

---

## 12. 実装メモ（AI向け）

### 12.1 実装順序

```
1. バックエンドAPI（POST /api/v1/auth/logout）
2. フロントエンドのログアウト処理
3. ヘッダー/サイドバーへのログアウトボタン配置
4. テスト
```

### 12.2 注意事項

- ⚠️ フロントエンドは**APIの結果を待たずに**ローカルトークンを削除する
- ⚠️ ネットワークエラーでもユーザーはログアウトできる状態にする
- ⚠️ 複数タブ対応は `storage` イベントまたは Broadcast Channel API を使用

---

## 変更履歴

| 日付 | バージョン | 変更内容 | 変更者 |
|------|----------|---------|-------|
| | v1.0 | 共通機能として作成 | |

# AUTH-001: ログイン機能

## メタ情報

| 項目 | 内容 |
|------|------|
| 機能ID | AUTH-001 |
| 機能名 | ログイン機能 |
| カテゴリ | 認証・認可 |
| 優先度 | P0 |
| ステータス | Approved |
| 作成者 | |
| 作成日 | 2024-01-15 |
| 最終更新日 | 2024-01-15 |
| レビュアー | |
| 承認者 | |

---

## 1. 概要

### 1.1 機能の目的（1-2文）

ユーザーがメールアドレスとパスワードを使用してシステムにログインし、認証済みセッションを確立する機能。

### 1.2 ユーザーストーリー

```
As a 登録済みユーザー,
I want to メールアドレスとパスワードでログインしたい,
so that 自分のアカウントにアクセスしてサービスを利用できる.
```

### 1.3 スコープ

**In Scope（この機能でやること）**:
- メール/パスワード認証
- セッション作成
- ログイン後のリダイレクト
- ログイン失敗時のエラー表示
- アカウントロック機能

**Out of Scope（この機能ではやらないこと）**:
- OAuth認証（AUTH-002, AUTH-003で対応）
- パスワードリセット（AUTH-006で対応）
- 多要素認証（AUTH-008で対応）

---

## 2. 受入条件（Acceptance Criteria）

### 2.1 正常系

| # | 条件 | 検証方法 |
|---|------|---------|
| AC-001 | ユーザーが正しいメール/パスワードを入力したとき、ログインに成功する | ユニットテスト |
| AC-002 | ログイン成功後、ダッシュボード（/app）に遷移する | E2Eテスト |
| AC-003 | nextパラメータがある場合、指定されたURLに遷移する | E2Eテスト |
| AC-004 | remember_meにチェックした場合、セッションが30日間維持される | 統合テスト |
| AC-005 | remember_meにチェックしない場合、セッションが24時間で期限切れになる | 統合テスト |

### 2.2 異常系

| # | 条件 | 検証方法 |
|---|------|---------|
| AC-101 | パスワードが間違っている場合、エラーメッセージ「メールアドレスまたはパスワードが正しくありません」を表示 | ユニットテスト |
| AC-102 | 存在しないメールアドレスの場合、同じエラーメッセージを表示（情報漏洩防止） | ユニットテスト |
| AC-103 | アカウントがロックされている場合、「アカウントがロックされています。{X}分後に再試行してください」を表示 | ユニットテスト |
| AC-104 | アカウントが無効化されている場合、「アカウントが無効化されています」を表示 | ユニットテスト |
| AC-105 | メールアドレスが空の場合、「メールアドレスを入力してください」を表示 | ユニットテスト |
| AC-106 | パスワードが空の場合、「パスワードを入力してください」を表示 | ユニットテスト |
| AC-107 | メールアドレスが不正な形式の場合、「有効なメールアドレスを入力してください」を表示 | ユニットテスト |

### 2.3 エッジケース

| # | 条件 | 検証方法 |
|---|------|---------|
| AC-201 | ログイン5回失敗でアカウントを30分ロック | 統合テスト |
| AC-202 | ロック後30分経過でロック解除 | 統合テスト |
| AC-203 | 同時セッション数が3を超えた場合、最古のセッションを自動的に無効化 | 統合テスト |
| AC-204 | すでにログイン済みの状態で/loginにアクセスした場合、/appにリダイレクト | E2Eテスト |
| AC-205 | nextパラメータに外部URLが指定された場合、無視して/appにリダイレクト（オープンリダイレクト防止） | E2Eテスト |

---

## 3. UI仕様

### 3.1 画面一覧

| Screen ID | 画面名 | パス | 認証 |
|-----------|-------|------|------|
| SCR-LOGIN | ログイン画面 | /login | 不要 |

### 3.2 画面レイアウト

```
┌─────────────────────────────────────────────────┐
│                    [ロゴ]                        │
│                                                 │
├─────────────────────────────────────────────────┤
│                                                 │
│   ┌───────────────────────────────────────┐    │
│   │  エラーメッセージバナー（エラー時のみ）  │    │
│   └───────────────────────────────────────┘    │
│                                                 │
│   メールアドレス                                 │
│   ┌───────────────────────────────────────┐    │
│   │ example@email.com                     │    │
│   └───────────────────────────────────────┘    │
│   [フィールドエラー]                            │
│                                                 │
│   パスワード                                    │
│   ┌───────────────────────────────────────┐    │
│   │ ••••••••                          [👁] │    │
│   └───────────────────────────────────────┘    │
│   [フィールドエラー]                            │
│                                                 │
│   [✓] ログイン状態を保持する                    │
│                                                 │
│   ┌───────────────────────────────────────┐    │
│   │              ログイン                  │    │
│   └───────────────────────────────────────┘    │
│                                                 │
│   パスワードをお忘れですか？                     │
│                                                 │
│   ──────────── または ────────────             │
│                                                 │
│   ┌───────────────────────────────────────┐    │
│   │    [G] Googleでログイン               │    │
│   └───────────────────────────────────────┘    │
│                                                 │
│   アカウントをお持ちでない方 → 新規登録          │
│                                                 │
└─────────────────────────────────────────────────┘
```

### 3.3 UI要素詳細

| 要素 | 種類 | バリデーション | 備考 |
|------|------|--------------|------|
| ロゴ | image | - | クリックで / へ遷移 |
| エラーバナー | div | - | 赤背景、左にアイコン、右に閉じるボタン |
| メールアドレス | input[type=email] | 必須、メール形式 | プレースホルダー: "example@email.com" |
| パスワード | input[type=password] | 必須 | 表示/非表示トグルあり |
| 表示トグル | button | - | 目のアイコン、クリックで表示/非表示切替 |
| ログイン状態を保持 | checkbox | - | チェック時: 30日間セッション維持 |
| ログインボタン | button[type=submit] | - | プライマリカラー、幅100% |
| パスワード忘れリンク | link | - | → /forgot-password |
| Googleログインボタン | button | - | Googleブランドガイドライン準拠 |
| 新規登録リンク | link | - | → /signup |

### 3.4 状態別表示

| 状態 | 表示内容 |
|------|---------|
| 初期表示 | フォーム表示、エラーバナー非表示 |
| 入力中 | リアルタイムバリデーション（フィールド離脱時） |
| バリデーションエラー | フィールド下に赤字でエラーメッセージ、フィールド枠を赤色に |
| 送信中 | ボタン無効化、テキストを「ログイン中...」に、スピナー表示 |
| サーバーエラー | フォーム上部にエラーバナー表示 |
| ログイン成功 | 即座にリダイレクト（UIフィードバックなし） |

### 3.5 レスポンシブ対応

| ブレークポイント | 対応 |
|----------------|------|
| モバイル（< 640px） | フォーム幅100%、左右padding: 16px |
| タブレット（640-1024px） | フォーム幅80%、中央配置 |
| デスクトップ（> 1024px） | フォーム幅400px固定、中央配置 |

---

## 4. 状態遷移

### 4.1 認証状態（参照: SSOT-2）

この機能で扱う認証状態:
- S0: LOGGED_OUT（未ログイン）
- S1: LOGGED_IN（ログイン済み）

### 4.2 この機能の状態遷移

```
                    ┌─────────────┐
        ┌───────────│  S0: 未認証  │───────────┐
        │           └──────┬──────┘           │
        │                  │                  │
  already_logged_in   submit_login      validation_error
        │                  │                  │
        │           ┌──────▼──────┐           │
        │           │   処理中     │           │
        │           └──────┬──────┘           │
        │                  │                  │
        │   ┌──────────────┼──────────────┐   │
        │   │              │              │   │
        │ success      failure      locked/disabled
        │   │              │              │   │
        │   ▼              ▼              ▼   │
        │ ┌────┐      ┌────────┐    ┌────────┐│
        │ │ S1 │      │エラー表示│    │エラー表示││
        │ │遷移│      │→S0に戻る│    │        ││
        │ └────┘      └────────┘    └────────┘│
        │                                     │
        └───────────────┬─────────────────────┘
                        │
                        ▼
                  ┌───────────┐
                  │  /app へ   │
                  │ リダイレクト│
                  └───────────┘
```

### 4.3 遷移ルール

| 現在の状態 | イベント | 次の状態 | アクション |
|-----------|---------|---------|-----------|
| S0 | ページアクセス | S0 | フォーム表示 |
| S0 | 入力 | S0 | リアルタイムバリデーション |
| S0 | submit（バリデーションエラー） | S0 | フィールドエラー表示 |
| S0 | submit（バリデーション成功） | 処理中 | API呼び出し、ボタン無効化 |
| 処理中 | login_success | S1 | nextパラメータまたは/appへ遷移 |
| 処理中 | login_failure | S0 | エラーバナー表示、フォーム有効化 |
| 処理中 | account_locked | S0 | ロックメッセージ表示 |
| 処理中 | account_disabled | S0 | 無効化メッセージ表示 |
| 処理中 | network_error | S0 | ネットワークエラー表示、リトライ可能 |
| S1 | ページアクセス | S1 | /appへリダイレクト |

---

## 5. API仕様

### 5.1 エンドポイント一覧

| メソッド | パス | 説明 | 認証 |
|---------|------|------|------|
| POST | /api/v1/auth/login | ログイン | 不要 |

### 5.2 POST /api/v1/auth/login

**リクエスト**:

```json
{
  "email": "user@example.com",
  "password": "password123",
  "remember_me": true
}
```

| フィールド | 型 | 必須 | バリデーション | 備考 |
|-----------|-----|------|--------------|------|
| email | string | ✅ | メール形式、最大255文字 | |
| password | string | ✅ | 1文字以上、128文字以下 | |
| remember_me | boolean | - | - | デフォルト: false |

**レスポンス（成功）**: `200 OK`

```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "Bearer",
  "expires_in": 3600,
  "user": {
    "id": "usr_abc123def456",
    "email": "user@example.com",
    "name": "John Doe",
    "role": "user",
    "avatar_url": null
  }
}
```

**レスポンス（エラー）**:

| HTTPステータス | エラーコード | 条件 | メッセージ |
|--------------|-------------|------|-----------|
| 400 | VAL_001 | バリデーションエラー | "Validation failed" |
| 401 | AUTH_001 | 認証失敗（パスワード不正または存在しないメール） | "Invalid credentials" |
| 401 | AUTH_005 | アカウント無効化 | "Account disabled" |
| 423 | AUTH_004 | アカウントロック | "Account locked. Try again in {minutes} minutes" |
| 429 | RATE_001 | レート制限 | "Too many requests. Try again later" |
| 500 | SYS_001 | サーバーエラー | "Internal server error" |

**バリデーションエラー時（400）**:

```json
{
  "error": {
    "code": "VAL_001",
    "message": "Validation failed",
    "details": {
      "fields": {
        "email": ["メールアドレスを入力してください"],
        "password": ["パスワードを入力してください"]
      }
    }
  }
}
```

---

## 6. データモデル

### 6.1 関連テーブル

| テーブル | 用途 | 参照 |
|---------|------|------|
| users | ユーザー情報 | SSOT-4 |
| sessions | セッション管理 | SSOT-4 |
| login_attempts | ログイン試行記録 | 下記 |

### 6.2 新規テーブル: login_attempts

| カラム | 型 | NULL | デフォルト | 説明 |
|--------|-----|------|----------|------|
| id | VARCHAR(36) | NO | - | 主キー（lat_xxx） |
| email | VARCHAR(255) | NO | - | 試行したメールアドレス |
| ip_address | VARCHAR(45) | NO | - | IPアドレス |
| user_agent | VARCHAR(500) | YES | - | ブラウザ情報 |
| success | BOOLEAN | NO | - | 成功/失敗 |
| failure_reason | VARCHAR(50) | YES | - | 失敗理由 |
| created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | 試行日時 |

**failure_reason の値**:
- `invalid_password` - パスワード不正
- `user_not_found` - ユーザーなし
- `account_locked` - アカウントロック中
- `account_disabled` - アカウント無効化

**インデックス**:
- `idx_login_attempts_email_created` (email, created_at DESC)
- `idx_login_attempts_ip_created` (ip_address, created_at DESC)

**データ保持**: 90日経過後に自動削除

### 6.3 データ操作

| 操作 | テーブル | 条件/内容 |
|------|---------|----------|
| SELECT | users | WHERE email = :email AND deleted_at IS NULL |
| SELECT | login_attempts | WHERE email = :email AND created_at > NOW() - 30min AND success = false |
| INSERT | sessions | 新規セッション作成 |
| INSERT | login_attempts | ログイン試行記録 |
| UPDATE | users | SET last_login_at = NOW() WHERE id = :user_id |
| UPDATE | sessions | SET revoked_at = NOW() WHERE user_id = :user_id（最古セッション無効化時） |

---

## 7. ビジネスロジック

### 7.1 処理フロー

```
1. 入力バリデーション
   ├─ email が空 → VAL_001（fields.email: "メールアドレスを入力してください"）
   ├─ email が不正形式 → VAL_001（fields.email: "有効なメールアドレスを入力してください"）
   ├─ password が空 → VAL_001（fields.password: "パスワードを入力してください"）
   └─ OK → 2へ

2. レート制限チェック（同一IP: 10回/分）
   ├─ 超過 → RATE_001
   └─ OK → 3へ

3. アカウントロック確認
   ├─ 過去30分で5回以上失敗 → AUTH_004（残り時間を計算）
   └─ ロックなし → 4へ

4. ユーザー検索
   ├─ 見つからない → login_attempts記録（user_not_found）→ AUTH_001
   └─ 見つかった → 5へ

5. アカウント状態確認
   ├─ status = 'disabled' → login_attempts記録（account_disabled）→ AUTH_005
   └─ status = 'active' → 6へ

6. パスワード検証（bcrypt.compare）
   ├─ 不一致 → login_attempts記録（invalid_password）→ AUTH_001
   └─ 一致 → 7へ

7. セッション数確認
   ├─ 3以上 → 最古のセッションを無効化（revoked_at = NOW()）
   └─ 3未満 → そのまま

8. セッション作成
   ├─ remember_me = true → 有効期限30日
   └─ remember_me = false → 有効期限24時間

9. ログイン成功処理
   ├─ login_attempts記録（success = true）
   ├─ users.last_login_at更新
   └─ トークン返却
```

### 7.2 セキュリティ要件

| 要件 | 実装 |
|------|------|
| パスワード検証 | bcrypt.compare（タイミング攻撃対策済み） |
| パスワード保存 | bcrypt（cost=12） |
| 情報漏洩防止 | メール存在有無を漏らさない（同じエラーメッセージ） |
| ブルートフォース対策 | レート制限 + アカウントロック |
| セッションID | UUID v4（推測不可能） |
| トークン有効期限 | アクセス: 1時間、リフレッシュ: 24時間/30日 |
| オープンリダイレクト防止 | nextパラメータのホスト検証 |

---

## 8. エラーハンドリング

### 8.1 フロントエンド

| エラー種別 | 表示方法 | メッセージ |
|-----------|---------|-----------|
| フィールドバリデーション | フィールド直下（赤字） | APIから返されたメッセージ |
| 認証エラー | フォーム上部バナー（赤） | 「メールアドレスまたはパスワードが正しくありません」 |
| アカウントロック | フォーム上部バナー（赤） | 「アカウントがロックされています。{X}分後に再試行してください」 |
| アカウント無効 | フォーム上部バナー（赤） | 「アカウントが無効化されています。サポートにお問い合わせください」 |
| レート制限 | フォーム上部バナー（黄） | 「しばらく時間をおいて再試行してください」 |
| ネットワークエラー | フォーム上部バナー（赤） | 「通信エラーが発生しました。再試行してください」 |
| サーバーエラー | フォーム上部バナー（赤） | 「システムエラーが発生しました。しばらく経ってから再試行してください」 |

### 8.2 バックエンド

| エラー種別 | HTTPステータス | ログレベル | ログ内容 |
|-----------|--------------|-----------|---------|
| バリデーションエラー | 400 | DEBUG | リクエスト内容（パスワード除く） |
| 認証失敗 | 401 | INFO | email(masked), ip, user_agent, failure_reason |
| アカウントロック | 423 | WARN | email(masked), ip, lock_until |
| アカウント無効 | 401 | INFO | email(masked), user_id |
| レート制限 | 429 | WARN | ip, request_count |
| サーバーエラー | 500 | ERROR | スタックトレース |

---

## 9. テスト仕様

### 9.1 ユニットテスト

| テストID | テストケース | 入力 | 期待結果 |
|----------|-------------|------|---------|
| TC-001 | 正常ログイン | 正しいemail/password | 200 + トークン返却 |
| TC-002 | パスワード不正 | 正しいemail + 不正password | 401 + AUTH_001 |
| TC-003 | メール不存在 | 存在しないemail | 401 + AUTH_001（同じエラー） |
| TC-004 | email空 | email="" | 400 + VAL_001 |
| TC-005 | email形式不正 | email="invalid" | 400 + VAL_001 |
| TC-006 | password空 | password="" | 400 + VAL_001 |
| TC-007 | アカウント無効 | disabled状態のユーザー | 401 + AUTH_005 |
| TC-008 | remember_me=true | remember_me=true | 30日有効のトークン |
| TC-009 | remember_me=false | remember_me=false | 24時間有効のトークン |

### 9.2 統合テスト

| テストID | テストケース | 手順 | 期待結果 |
|----------|-------------|------|---------|
| TC-101 | アカウントロック | 5回連続失敗 | 6回目で423 + AUTH_004 |
| TC-102 | ロック解除 | ロック後30分経過 | ログイン可能 |
| TC-103 | 同時セッション制限 | 4台目でログイン | 最古セッション無効化 |
| TC-104 | ログイン試行記録 | ログイン試行 | login_attemptsにレコード作成 |
| TC-105 | last_login_at更新 | ログイン成功 | users.last_login_at更新 |

### 9.3 E2Eテスト

| テストID | テストケース | 手順 | 期待結果 |
|----------|-------------|------|---------|
| TC-201 | 正常ログインフロー | /login → 入力 → 送信 | /appに遷移 |
| TC-202 | nextパラメータ | /login?next=/settings → ログイン | /settingsに遷移 |
| TC-203 | 外部URLのnext | /login?next=https://evil.com → ログイン | /appに遷移（外部URL無視） |
| TC-204 | ログイン済みでアクセス | ログイン状態で/login | /appにリダイレクト |
| TC-205 | エラー表示 | 不正パスワード入力 | エラーバナー表示 |
| TC-206 | パスワード表示切替 | 目アイコンクリック | パスワード表示/非表示 |
| TC-207 | ローディング状態 | ログインボタンクリック | ボタン無効化 + スピナー |

---

## 10. 非機能要件

### 10.1 パフォーマンス

| 指標 | 目標値 |
|------|-------|
| API応答時間（p95） | < 500ms |
| ページ読み込み（LCP） | < 2.5秒 |

### 10.2 可用性

| 指標 | 目標値 |
|------|-------|
| 稼働率 | 99.9% |

### 10.3 セキュリティ

| 項目 | 対応 |
|------|------|
| HTTPS | 必須 |
| CSRF | トークン検証 |
| XSS | 入力サニタイズ |
| ブルートフォース | レート制限 + アカウントロック |
| タイミング攻撃 | bcrypt.compare使用 |

---

## 11. 依存関係

### 11.1 前提となる機能

| 機能ID | 機能名 | 依存内容 |
|--------|-------|---------|
| - | - | （この機能は依存なし） |

### 11.2 この機能に依存する機能

| 機能ID | 機能名 | 依存内容 |
|--------|-------|---------|
| AUTH-005 | ログアウト | セッション管理 |
| AUTH-006 | パスワードリセット | users テーブル |
| AUTH-009 | セッション管理 | sessions テーブル |
| AUTH-010 | セッション更新 | sessions テーブル |
| 全Protected機能 | - | 認証状態 |

---

## 12. 実装メモ（AI向け）

### 12.1 実装順序

```
1. DBマイグレーション
   - login_attempts テーブル作成

2. バックエンドAPI
   - POST /api/v1/auth/login
   - バリデーション
   - ユーザー検索
   - パスワード検証
   - セッション作成
   - ログイン試行記録

3. フロントエンド
   - LoginForm コンポーネント
   - /login ページ
   - 状態管理（ローディング、エラー）
   - リダイレクト処理

4. テスト
   - ユニットテスト
   - 統合テスト
   - E2Eテスト
```

### 12.2 参照すべきファイル

| 種類 | ファイル | 参照内容 |
|------|---------|---------|
| 認証共通 | SSOT-5_CROSS_CUTTING.md | JWT構造、セッション管理ルール |
| API共通 | SSOT-3_API_CONTRACT.md | エラーレスポンス形式 |
| DB共通 | SSOT-4_DATA_MODEL.md | users, sessions テーブル定義 |
| UI共通 | SSOT-2_UI_STATE.md | 認証状態定義、ルートガード |

### 12.3 注意事項

- ⚠️ パスワードは絶対にログに出力しない
- ⚠️ メールアドレスはログ出力時にマスク（u***@example.com）
- ⚠️ エラーメッセージでメールの存在有無を漏らさない
- ⚠️ bcryptのcostは12を使用
- ⚠️ nextパラメータは同一オリジンのみ許可

---

## 変更履歴

| 日付 | バージョン | 変更内容 | 変更者 |
|------|----------|---------|-------|
| 2024-01-15 | v1.0 | 初版作成 | |

---

## 承認

| 役割 | 名前 | 日付 | 承認 |
|------|------|------|------|
| 設計者 | | | ☐ |
| テックリード | | | ☐ |
| プロダクトオーナー | | | ☐ |

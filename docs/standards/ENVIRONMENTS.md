# ENVIRONMENTS.md - 環境構成定義書

> 各環境（開発・ステージング・本番）の構成と設定差分を定義

---

## 基本情報

| 項目 | 内容 |
|------|------|
| プロジェクト名 | |
| 最終更新日 | YYYY-MM-DD |
| 管理者 | |

---

## 1. 環境一覧

| 環境 | 略称 | 用途 | URL |
|------|------|------|-----|
| 開発 | dev | 開発者のローカル開発 | http://localhost:3000 |
| 検証 | stg | QA・受入テスト | https://stg.example.com |
| 本番 | prod | エンドユーザー向け | https://example.com |

### 環境フロー

```
開発（dev） → 検証（stg） → 本番（prod）
    ↑            ↑            ↑
  開発者        QA/PO        全ユーザー
```

---

## 2. 各環境の詳細

### 2.1 開発環境（dev）

| 項目 | 設定 |
|------|------|
| **用途** | ローカル開発・デバッグ |
| **アクセス** | 開発者のみ |
| **データ** | ダミーデータ・シードデータ |
| **外部サービス** | モック or サンドボックス |
| **ログレベル** | DEBUG |
| **デバッグツール** | 有効 |

**特記事項**:
- ホットリロード有効
- エラー詳細表示
- DBは Docker or ローカル

---

### 2.2 検証環境（stg）

| 項目 | 設定 |
|------|------|
| **用途** | QA・受入テスト・デモ |
| **アクセス** | 開発チーム・PO・関係者 |
| **データ** | 本番に近いテストデータ |
| **外部サービス** | サンドボックス |
| **ログレベル** | INFO |
| **デバッグツール** | 無効 |

**特記事項**:
- 本番と同じインフラ構成
- 認証付き（Basic認証 or IP制限）
- PRマージ時に自動デプロイ（任意）

---

### 2.3 本番環境（prod）

| 項目 | 設定 |
|------|------|
| **用途** | エンドユーザー向けサービス提供 |
| **アクセス** | 全ユーザー |
| **データ** | 実データ |
| **外部サービス** | 本番 |
| **ログレベル** | INFO / WARN |
| **デバッグツール** | 無効 |

**特記事項**:
- 高可用性構成
- 監視・アラート有効
- バックアップ有効
- CDN有効

---

## 3. インフラ構成

### 3.1 構成図

```
┌─────────────────────────────────────────────────────────────┐
│                         CDN                                 │
│                    (Cloudflare等)                           │
└─────────────────────────┬───────────────────────────────────┘
                          │
┌─────────────────────────▼───────────────────────────────────┐
│                    Load Balancer                            │
│                      (任意)                                 │
└─────────────────────────┬───────────────────────────────────┘
                          │
┌─────────────────────────▼───────────────────────────────────┐
│                   Application Server                        │
│                    (Vercel / AWS等)                         │
└───────────────┬─────────────────────────┬───────────────────┘
                │                         │
┌───────────────▼───────────┐ ┌───────────▼───────────────────┐
│        Database           │ │         Cache                 │
│     (PostgreSQL等)        │ │        (Redis等)              │
└───────────────────────────┘ └───────────────────────────────┘
```

### 3.2 環境別インフラ

| コンポーネント | dev | stg | prod |
|--------------|-----|-----|------|
| ホスティング | localhost | Vercel Preview | Vercel Production |
| データベース | Docker (PostgreSQL) | Supabase (Free) | Supabase (Pro) |
| キャッシュ | Docker (Redis) | Upstash (Free) | Upstash (Pro) |
| ストレージ | ローカル | S3 (dev bucket) | S3 (prod bucket) |
| CDN | なし | なし | Cloudflare |

---

## 4. 環境変数

### 4.1 共通（全環境）

| 変数名 | 説明 | 例 |
|--------|------|-----|
| `NEXTAUTH_SECRET` | 認証シークレット | ランダム文字列 |
| `NEXTAUTH_URL` | 認証コールバックURL | 環境別URL |

### 4.2 環境別設定

| 変数名 | dev | stg | prod |
|--------|-----|-----|------|
| `NODE_ENV` | development | production | production |
| `APP_ENV` | development | staging | production |
| `DATABASE_URL` | localhost:5432 | stg-db.xxx | prod-db.xxx |
| `REDIS_URL` | localhost:6379 | stg-redis.xxx | prod-redis.xxx |
| `LOG_LEVEL` | debug | info | info |
| `ENABLE_DEBUG` | true | false | false |

### 4.3 外部サービスAPI

| サービス | dev | stg | prod |
|---------|-----|-----|------|
| Stripe | テストキー | テストキー | 本番キー |
| SendGrid | サンドボックス | サンドボックス | 本番 |
| Google OAuth | localhost許可 | stg URL許可 | prod URL許可 |

---

## 5. アクセス制御

### 5.1 環境別アクセス権限

| 環境 | 開発者 | QA | PO | 一般ユーザー |
|------|-------|-----|-----|-------------|
| dev | ✅ | - | - | - |
| stg | ✅ | ✅ | ✅ | - |
| prod | ✅（読み取り） | - | ✅ | ✅ |

### 5.2 アクセス制限方法

| 環境 | 方法 |
|------|------|
| stg | Basic認証 / IP制限 / VPN |
| prod | 公開（認証が必要な機能は認証必須） |

### 5.3 認証情報（stg）

```
# Basic認証（例）
Username: staging
Password: {STAGING_PASSWORD}

# IP制限（例）
許可IP: xxx.xxx.xxx.xxx（オフィス）
```

---

## 6. データ管理

### 6.1 データ方針

| 環境 | データソース | 個人情報 |
|------|-------------|---------|
| dev | シードデータ | ダミー |
| stg | テストデータ | マスク済み or ダミー |
| prod | 実データ | 実データ |

### 6.2 データ同期

| 方向 | 許可 | 手順 |
|------|------|------|
| prod → stg | ⚠️ 条件付き | 個人情報マスク後にコピー |
| prod → dev | ❌ 禁止 | - |
| stg → prod | ❌ 禁止 | - |
| dev → stg | ✅ 許可 | シードデータのみ |

### 6.3 バックアップ

| 環境 | 頻度 | 保持期間 |
|------|------|---------|
| dev | なし | - |
| stg | 日次 | 7日 |
| prod | 日次 + 週次 | 日次30日 / 週次1年 |

---

## 7. デプロイフロー

### 7.1 環境別デプロイ

| 環境 | トリガー | 方法 |
|------|---------|------|
| dev | ローカル | `pnpm dev` |
| stg | PRマージ（develop） or 手動 | CI/CD自動 |
| prod | リリースタグ or 手動承認 | CI/CD（承認後） |

### 7.2 フロー図

```
feature branch
      │
      │ PR作成
      ▼
   develop ────────────→ stg環境（自動デプロイ）
      │
      │ リリースPR
      ▼
    main ──────────────→ prod環境（承認後デプロイ）
```

---

## 8. 監視・ログ

### 8.1 環境別設定

| 項目 | dev | stg | prod |
|------|-----|-----|------|
| エラー監視 | コンソール | Sentry | Sentry |
| ログ収集 | コンソール | CloudWatch | CloudWatch |
| APM | なし | なし | Datadog |
| アラート | なし | Slack | Slack + PagerDuty |

### 8.2 ログレベル

| レベル | dev | stg | prod |
|-------|-----|-----|------|
| DEBUG | ✅ | ❌ | ❌ |
| INFO | ✅ | ✅ | ✅ |
| WARN | ✅ | ✅ | ✅ |
| ERROR | ✅ | ✅ | ✅ |

---

## 9. セキュリティ

### 9.1 環境別セキュリティ

| 項目 | dev | stg | prod |
|------|-----|-----|------|
| HTTPS | ❌ (localhost) | ✅ | ✅ |
| CSP | 緩い | 本番同等 | 厳格 |
| レート制限 | なし | 緩い | 厳格 |
| WAF | なし | なし | あり |

### 9.2 シークレット管理

| 環境 | 管理方法 |
|------|---------|
| dev | .env.local（gitignore） |
| stg | Vercel Environment Variables / AWS Secrets Manager |
| prod | Vercel Environment Variables / AWS Secrets Manager |

---

## 10. トラブルシューティング

### 10.1 環境別の確認方法

| 確認項目 | dev | stg | prod |
|---------|-----|-----|------|
| ログ確認 | コンソール | Vercel Logs / CloudWatch | Vercel Logs / CloudWatch |
| DB確認 | TablePlus | Supabase Dashboard | 踏み台経由（承認必要） |
| 環境変数 | .env.local | Vercel Dashboard | Vercel Dashboard |

### 10.2 よくある問題

| 問題 | 原因 | 解決策 |
|------|------|-------|
| stgで動くがprodで動かない | 環境変数の差異 | 環境変数を比較 |
| API呼び出し失敗 | CORS / 認証 | 環境別設定を確認 |
| DB接続エラー | 接続文字列 / IP制限 | 接続情報を確認 |

---

## 11. 環境構築チェックリスト

### 新環境追加時

- [ ] インフラをプロビジョニング
- [ ] 環境変数を設定
- [ ] データベースをセットアップ
- [ ] マイグレーションを実行
- [ ] アクセス制限を設定
- [ ] 監視を設定
- [ ] デプロイパイプラインを設定
- [ ] 動作確認

---

## 変更履歴

| 日付 | 変更内容 | 変更者 |
|------|---------|-------|
| | 初版作成 | |

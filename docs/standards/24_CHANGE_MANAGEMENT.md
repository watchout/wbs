# 24_CHANGE_MANAGEMENT.md - 保守・変更管理

> リリース後のバグ修正・機能追加がSSOTを起点にして正しく管理される体制

---

## なぜ必要か

```
v1リリース後に起こること:
  - ユーザーからバグ報告が来る
  - 新しい機能の要望が来る
  - 既存機能の仕様変更が必要になる
  - 外部サービスのAPI変更に対応が必要になる

これらを「SSOTを無視してコードだけ修正」すると:
  → SSOTと実装が乖離する
  → 次の機能開発でSSOTを参照しても嘘が書いてある
  → チームの信頼が崩壊する

原則: 全ての変更はSSOTから始まり、SSOTに反映される
```

---

## 変更の種類と対応フロー

### 種類1: バグ修正

```
バグ報告
    │
    ▼
① バグの分類
   - SSOTの仕様通りだがユーザーの期待と異なる → 仕様変更として扱う
   - SSOTの仕様と実装が異なる → 実装バグ
   - SSOTに定義がないケース → 仕様漏れ
    │
    ▼
② SSOTの確認・更新
   - 実装バグ: SSOTは正しい → SSOTの変更不要
   - 仕様漏れ: SSOTに定義を追加 → SSOT更新 → 再監査
    │
    ▼
③ 影響分析
   - この修正が他のSSOT/機能に影響するか確認
   - 影響がある場合、関連SSOTも更新
    │
    ▼
④ 修正タスク作成
   - 通常の実装フローに従う（15→16→実装→17→18→19）
   - ブランチ: fix/FEAT-XXX-[説明]
    │
    ▼
⑤ 修正完了
   - SSOTの §1 変更履歴に記録
   - リリースノートに追記
```

### 種類2: 機能追加（新機能）

```
機能要望
    │
    ▼
① 既存SSOTへの影響分析
   - 新機能が既存機能に影響するか
   - 既存のデータモデル/APIに変更が必要か
    │
    ▼
② 通常の開発フロー
   - 11（ヒアリング）→ 12（SSOT作成）→ 13（監査）
   - 14（タスク分解）→ 15-19（実装）→ 22（検証）
    │
    ▼
③ 影響を受ける既存SSOTの更新
   - 依存関係が追加される場合 → 既存SSOTの §11 更新
   - データモデルが変更される場合 → SSOT-4 更新
   - APIが変更される場合 → SSOT-3 更新
    │
    ▼
④ 影響を受ける既存機能の回帰テスト
   - 変更した既存SSOTの機能が壊れていないか確認
   - 回帰テストの実行
```

### 種類3: 仕様変更

```
仕様変更の要求
    │
    ▼
① 変更の影響範囲を特定
   - 対象SSOTの特定
   - 対象SSOTに依存する他のSSOTを特定
   - 影響を受けるコード・テスト・UIを特定
    │
    ▼
② SSOTの更新
   - 対象SSOTの該当セクションを変更
   - 変更内容をユーザーに確認（21 AI中断プロトコル）
   - 変更理由をADRに記録
    │
    ▼
③ 関連SSOTの整合性チェック
   - 11 §⑨ の整合性チェックを再実行
   - 矛盾があれば関連SSOTも更新
    │
    ▼
④ 変更されたSSOTの再監査
   - 13 SSOT監査を再実行
   - 95点以上で合格
    │
    ▼
⑤ 修正タスクの作成と実装
   - 変更部分のみタスク化
   - 通常の実装フロー（15-19）に従う
    │
    ▼
⑥ 回帰テスト
   - 変更に影響される全機能の回帰テスト
   - 22 機能完了検証を再実行
```

---

## SSOT変更時の影響分析

### 影響分析テンプレート

```markdown
# SSOT変更 影響分析

## 変更内容
| 項目 | 内容 |
|------|------|
| 対象SSOT | [FEAT-XXX] |
| 変更セクション | §X |
| 変更概要 | [何をどう変えるか] |
| 変更理由 | [なぜ変える必要があるか] |

## 影響を受けるドキュメント

| ドキュメント | 影響箇所 | 影響度 | 対応 |
|-------------|---------|-------|------|
| SSOT-3 API | エンドポイント定義 | Major | 更新必要 |
| SSOT-4 DATA | テーブル定義 | Major | 更新必要 |
| FEAT-YYY SSOT | §11 依存関係 | Minor | 確認のみ |

## 影響を受けるコード

| ファイル | 影響内容 | 修正要否 |
|---------|---------|---------|
| src/api/xxx.ts | レスポンス型変更 | 修正必要 |
| src/ui/xxx.tsx | 表示項目追加 | 修正必要 |
| tests/xxx.test.ts | テストケース追加 | 修正必要 |

## 影響を受けるテスト

| テスト | 影響 | 対応 |
|--------|------|------|
| 単体テスト | ケース追加 | 追加必要 |
| E2Eテスト | フロー変更 | 修正必要 |
| ビジュアルテスト | 基準画像更新 | 更新必要 |

## リスク
[この変更に伴うリスクがあれば記載]
```

---

## 変更ログの管理

```
全てのSSO変更は以下に記録する:

1. SSOTの §1 変更履歴
   | ver | 日付 | 変更内容 | 理由 |

2. ADR（Architecture Decision Record）
   重大な仕様変更は adr/ に記録

3. Git コミットメッセージ
   docs(FEAT-XXX): §7 BR-005 を変更 - [理由]

4. リリースノート
   変更がリリースに含まれる場合
```

---

## 定期レビュー

```
月次でSSOTの健全性を確認:

チェック項目:
  □ SSOTと実装の乖離がないか
  □ TBD項目が残存していないか
  □ 古くなった仕様がないか
  □ 依存する外部サービスに変更がないか
  □ セキュリティアップデートが必要な依存がないか

発見した問題 → 変更管理フローに載せて対応
```

---

## 変更履歴

| 日付 | 変更内容 | 変更者 |
|------|---------|-------|
| | 初版作成 | |

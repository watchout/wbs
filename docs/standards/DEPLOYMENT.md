# DEPLOYMENT.md - ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †æ›¸

> ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ãƒ­ãƒ¼ã€æ‰‹é †ã€ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ–¹æ³•ã‚’å®šç¾©

---

## åŸºæœ¬æƒ…å ±

| é …ç›® | å†…å®¹ |
|------|------|
| ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå | |
| ãƒ‡ãƒ—ãƒ­ã‚¤æ–¹å¼ | è‡ªå‹•ï¼ˆCI/CDï¼‰ / æ‰‹å‹• |
| ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚° | Vercel / AWS / GCP |
| æœ€çµ‚æ›´æ–°æ—¥ | YYYY-MM-DD |

---

## 1. ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ãƒ­ãƒ¼

### 1.1 å…¨ä½“ãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   develop   â”‚â”€â”€â”€â”€â–¶â”‚   staging   â”‚â”€â”€â”€â”€â–¶â”‚ production  â”‚
â”‚   branch    â”‚     â”‚   ç’°å¢ƒ      â”‚     â”‚   ç’°å¢ƒ      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                  â”‚                   â”‚
       â”‚                  â”‚                   â”‚
  PRãƒãƒ¼ã‚¸ã§           è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤        æ‰¿èªå¾Œãƒ‡ãƒ—ãƒ­ã‚¤
  è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
```

### 1.2 ç’°å¢ƒåˆ¥ãƒˆãƒªã‚¬ãƒ¼

| ç’°å¢ƒ | ãƒˆãƒªã‚¬ãƒ¼ | æ‰¿èª | è‡ªå‹•/æ‰‹å‹• |
|------|---------|------|----------|
| Preview | PRä½œæˆæ™‚ | ä¸è¦ | è‡ªå‹• |
| Staging | develop ãƒãƒ¼ã‚¸ | ä¸è¦ | è‡ªå‹• |
| Production | main ãƒãƒ¼ã‚¸ | å¿…è¦ | æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼ |

---

## 2. è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆCI/CDï¼‰

### 2.1 GitHub Actionsè¨­å®š

```yaml
# .github/workflows/deploy.yml
name: Deploy

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # ãƒ†ã‚¹ãƒˆãƒ»ãƒ“ãƒ«ãƒ‰
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
      
      - run: pnpm install
      - run: pnpm lint
      - run: pnpm type-check
      - run: pnpm test
      - run: pnpm build

  # Staging ãƒ‡ãƒ—ãƒ­ã‚¤
  deploy-staging:
    needs: build
    if: github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - uses: actions/checkout@v4
      - name: Deploy to Staging
        run: |
          # Vercel CLI or ãã®ä»–ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚³ãƒãƒ³ãƒ‰
          vercel --prod --token=${{ secrets.VERCEL_TOKEN }}

  # Production ãƒ‡ãƒ—ãƒ­ã‚¤
  deploy-production:
    needs: build
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: production  # æ‰¿èªå¿…è¦
    steps:
      - uses: actions/checkout@v4
      - name: Deploy to Production
        run: |
          vercel --prod --token=${{ secrets.VERCEL_TOKEN }}
```

### 2.2 Vercelè¨­å®š

```json
// vercel.json
{
  "buildCommand": "pnpm build",
  "outputDirectory": ".next",
  "framework": "nextjs",
  "regions": ["hnd1"],
  "env": {
    "DATABASE_URL": "@database_url",
    "NEXTAUTH_SECRET": "@nextauth_secret"
  }
}
```

---

## 3. æ‰‹å‹•ãƒ‡ãƒ—ãƒ­ã‚¤

### 3.1 Staging

```bash
# 1. developãƒ–ãƒ©ãƒ³ãƒã«åˆ‡ã‚Šæ›¿ãˆ
git checkout develop
git pull origin develop

# 2. ãƒ“ãƒ«ãƒ‰ç¢ºèª
pnpm build

# 3. ãƒ‡ãƒ—ãƒ­ã‚¤
vercel --prod

# ã¾ãŸã¯
pnpm deploy:staging
```

### 3.2 Production

```bash
# 1. mainãƒ–ãƒ©ãƒ³ãƒã«åˆ‡ã‚Šæ›¿ãˆ
git checkout main
git pull origin main

# 2. ãƒ“ãƒ«ãƒ‰ç¢ºèª
pnpm build

# 3. ãƒ‡ãƒ—ãƒ­ã‚¤å‰ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆå®Ÿè¡Œ
# ï¼ˆä¸‹è¨˜ã€Œãƒ‡ãƒ—ãƒ­ã‚¤å‰ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã€å‚ç…§ï¼‰

# 4. ãƒ‡ãƒ—ãƒ­ã‚¤
vercel --prod

# ã¾ãŸã¯
pnpm deploy:production

# 5. ã‚¹ãƒ¢ãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
pnpm test:smoke

# 6. é€šçŸ¥
# Slackã«é€šçŸ¥ï¼ˆè‡ªå‹•åŒ–æ¨å¥¨ï¼‰
```

---

## 4. ãƒ‡ãƒ—ãƒ­ã‚¤å‰ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### 4.1 ã‚³ãƒ¼ãƒ‰å“è³ª

| # | ç¢ºèªé …ç›® | ç¢ºèª |
|---|---------|------|
| 1 | å…¨ãƒ†ã‚¹ãƒˆãŒé€šéã—ã¦ã„ã‚‹ | â˜ |
| 2 | lint ã‚¨ãƒ©ãƒ¼ãŒãªã„ | â˜ |
| 3 | å‹ãƒã‚§ãƒƒã‚¯ãŒé€šéã—ã¦ã„ã‚‹ | â˜ |
| 4 | ãƒ“ãƒ«ãƒ‰ãŒæˆåŠŸã™ã‚‹ | â˜ |
| 5 | PRãŒãƒ¬ãƒ“ãƒ¥ãƒ¼æ‰¿èªã•ã‚Œã¦ã„ã‚‹ | â˜ |

### 4.2 æ©Ÿèƒ½ç¢ºèª

| # | ç¢ºèªé …ç›® | ç¢ºèª |
|---|---------|------|
| 6 | Staging ã§å‹•ä½œç¢ºèªæ¸ˆã¿ | â˜ |
| 7 | æ–°æ©Ÿèƒ½ã®å—å…¥ãƒ†ã‚¹ãƒˆå®Œäº† | â˜ |
| 8 | æ—¢å­˜æ©Ÿèƒ½ã®ãƒªã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ãªã— | â˜ |

### 4.3 ã‚¤ãƒ³ãƒ•ãƒ©ãƒ»è¨­å®š

| # | ç¢ºèªé …ç›® | ç¢ºèª |
|---|---------|------|
| 9 | ç’°å¢ƒå¤‰æ•°ã®è¿½åŠ /å¤‰æ›´ã‚’æœ¬ç•ªã«åæ˜ æ¸ˆã¿ | â˜ |
| 10 | DBãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®æº–å‚™å®Œäº† | â˜ |
| 11 | å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã®è¨­å®šå¤‰æ›´å®Œäº† | â˜ |

### 4.4 é‹ç”¨æº–å‚™

| # | ç¢ºèªé …ç›® | ç¢ºèª |
|---|---------|------|
| 12 | ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †ã‚’ç¢ºèªæ¸ˆã¿ | â˜ |
| 13 | ç›£è¦–ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’é–‹ã„ã¦ã„ã‚‹ | â˜ |
| 14 | é–¢ä¿‚è€…ã«é€šçŸ¥æ¸ˆã¿ | â˜ |

---

## 5. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

### 5.1 ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ‰‹é †

```bash
# 1. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆï¼ˆé–‹ç™ºæ™‚ï¼‰
pnpm db:migrate:create --name add_user_phone

# 2. ãƒ­ãƒ¼ã‚«ãƒ«ã§é©ç”¨ãƒ»ç¢ºèª
pnpm db:migrate

# 3. Staging ã§é©ç”¨
DATABASE_URL=$STAGING_DATABASE_URL pnpm db:migrate

# 4. Production ã§é©ç”¨ï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤å‰ or ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­ï¼‰
DATABASE_URL=$PRODUCTION_DATABASE_URL pnpm db:migrate
```

### 5.2 ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ³¨æ„äº‹é …

| çŠ¶æ³ | å¯¾å¿œ |
|------|------|
| ã‚«ãƒ©ãƒ è¿½åŠ  | NULLè¨±å¯ or ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š |
| ã‚«ãƒ©ãƒ å‰Šé™¤ | 2æ®µéšï¼ˆä½¿ç”¨åœæ­¢â†’æ¬¡ãƒªãƒªãƒ¼ã‚¹ã§å‰Šé™¤ï¼‰ |
| ã‚«ãƒ©ãƒ åå¤‰æ›´ | éæ¨å¥¨ï¼ˆæ–°è¦è¿½åŠ â†’ãƒ‡ãƒ¼ã‚¿ç§»è¡Œâ†’æ—§å‰Šé™¤ï¼‰ |
| ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¿½åŠ  | CONCURRENTLY ã‚ªãƒ—ã‚·ãƒ§ãƒ³ä½¿ç”¨ |

### 5.3 ç ´å£Šçš„å¤‰æ›´

```bash
# æœ¬ç•ªé©ç”¨å‰ã«å¿…ãšãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
pg_dump -h $HOST -U $USER -d $DB > backup_$(date +%Y%m%d_%H%M%S).sql
```

---

## 6. ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯

### 6.1 ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯

**Vercel ã®å ´åˆ**:

```bash
# 1. éå»ã®ãƒ‡ãƒ—ãƒ­ã‚¤ä¸€è¦§ã‚’ç¢ºèª
vercel ls

# 2. ç‰¹å®šã®ãƒ‡ãƒ—ãƒ­ã‚¤ã«ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
vercel rollback [deployment-url]

# ã¾ãŸã¯ Vercel Dashboard ã‹ã‚‰
# Deployments â†’ å¯¾è±¡ãƒ‡ãƒ—ãƒ­ã‚¤ â†’ ... â†’ Promote to Production
```

**Git ãƒ™ãƒ¼ã‚¹ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯**:

```bash
# 1. å•é¡Œã®ã‚³ãƒŸãƒƒãƒˆã‚’ç‰¹å®š
git log --oneline

# 2. revert ã‚³ãƒŸãƒƒãƒˆä½œæˆ
git revert <commit-hash>

# 3. ãƒ—ãƒƒã‚·ãƒ¥ â†’ è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
git push origin main
```

### 6.2 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯

```bash
# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’1ã¤æˆ»ã™
pnpm db:migrate:rollback

# ç‰¹å®šãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¾ã§æˆ»ã™
pnpm db:migrate:rollback --to <version>

# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒï¼ˆæœ€çµ‚æ‰‹æ®µï¼‰
psql -h $HOST -U $USER -d $DB < backup_YYYYMMDD_HHMMSS.sql
```

### 6.3 ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯åˆ¤æ–­åŸºæº–

| çŠ¶æ³ | åˆ¤æ–­ |
|------|------|
| ä¸»è¦æ©Ÿèƒ½ãŒå‹•ä½œã—ãªã„ | å³åº§ã«ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ |
| ã‚¨ãƒ©ãƒ¼ç‡ãŒæ€¥å¢— | å³åº§ã«ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ |
| ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å¤§å¹…åŠ£åŒ– | ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’æ¤œè¨ |
| è»½å¾®ãªãƒã‚° | ãƒ›ãƒƒãƒˆãƒ•ã‚£ãƒƒã‚¯ã‚¹ã§å¯¾å¿œ |

---

## 7. ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œç¢ºèª

### 7.1 ã‚¹ãƒ¢ãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆ

```bash
# è‡ªå‹•ã‚¹ãƒ¢ãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆ
pnpm test:smoke

# ã¾ãŸã¯æ‰‹å‹•ç¢ºèª
```

| # | ç¢ºèªé …ç›® | ç¢ºèª |
|---|---------|------|
| 1 | ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ | â˜ |
| 2 | ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹ | â˜ |
| 3 | ä¸»è¦æ©Ÿèƒ½ãŒå‹•ä½œã™ã‚‹ | â˜ |
| 4 | APIãŒå¿œç­”ã™ã‚‹ | â˜ |
| 5 | ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ãŒæ€¥å¢—ã—ã¦ã„ãªã„ | â˜ |

### 7.2 ç›£è¦–ç¢ºèªï¼ˆ15åˆ†é–“ï¼‰

| # | ç¢ºèªé …ç›® | ç¢ºèª |
|---|---------|------|
| 1 | ã‚¨ãƒ©ãƒ¼ç‡ãŒæ­£å¸¸ç¯„å›²å†… | â˜ |
| 2 | ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ ãŒæ­£å¸¸ | â˜ |
| 3 | CPU/ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡ãŒæ­£å¸¸ | â˜ |
| 4 | ã‚¢ãƒ©ãƒ¼ãƒˆãŒç™ºç”Ÿã—ã¦ã„ãªã„ | â˜ |

---

## 8. é€šçŸ¥

### 8.1 ãƒ‡ãƒ—ãƒ­ã‚¤é€šçŸ¥

```bash
# Slacké€šçŸ¥ï¼ˆGitHub Actionså†…ï¼‰
- name: Notify Slack
  uses: slackapi/slack-github-action@v1
  with:
    payload: |
      {
        "text": "ğŸš€ Deployed to Production",
        "blocks": [
          {
            "type": "section",
            "text": {
              "type": "mrkdwn",
              "text": "*Deployment Complete*\nâ€¢ Environment: Production\nâ€¢ Version: ${{ github.sha }}\nâ€¢ By: ${{ github.actor }}"
            }
          }
        ]
      }
  env:
    SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
```

### 8.2 é€šçŸ¥ã‚¿ã‚¤ãƒŸãƒ³ã‚°

| ã‚¤ãƒ™ãƒ³ãƒˆ | é€šçŸ¥å…ˆ | å†…å®¹ |
|---------|-------|------|
| ãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹ | #deployments | é–‹å§‹é€šçŸ¥ |
| ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº† | #deployments | å®Œäº†é€šçŸ¥ + URL |
| ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•— | #deployments + æ‹…å½“è€… | ã‚¨ãƒ©ãƒ¼å†…å®¹ |
| ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ | #deployments + #general | ç†ç”± + å½±éŸ¿ç¯„å›² |

---

## 9. ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### 9.1 ã‚ˆãã‚ã‚‹å•é¡Œ

| å•é¡Œ | åŸå›  | è§£æ±ºç­– |
|------|------|-------|
| ãƒ“ãƒ«ãƒ‰å¤±æ•— | ä¾å­˜é–¢ä¿‚ | `pnpm install` å†å®Ÿè¡Œã€lockfileç¢ºèª |
| ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œ500ã‚¨ãƒ©ãƒ¼ | ç’°å¢ƒå¤‰æ•°ä¸è¶³ | ç’°å¢ƒå¤‰æ•°ã‚’ç¢ºèªãƒ»è¿½åŠ  |
| DBã‚¨ãƒ©ãƒ¼ | ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æœªé©ç”¨ | ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ |
| é™çš„ãƒ•ã‚¡ã‚¤ãƒ«404 | ã‚­ãƒ£ãƒƒã‚·ãƒ¥ | CDNã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‘ãƒ¼ã‚¸ |

### 9.2 ç·Šæ€¥é€£çµ¡å…ˆ

| å½¹å‰² | æ‹…å½“è€… | é€£çµ¡å…ˆ |
|------|-------|-------|
| ã‚¤ãƒ³ãƒ•ãƒ©æ‹…å½“ | | |
| ãƒ†ãƒƒã‚¯ãƒªãƒ¼ãƒ‰ | | |
| ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã‚ªãƒ¼ãƒŠãƒ¼ | | |

---

## 10. ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆ

### 10.1 ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

```markdown
# Release v1.2.0 - YYYY-MM-DD

## ğŸš€ æ–°æ©Ÿèƒ½
- æ©Ÿèƒ½A ã‚’è¿½åŠ  (#123)
- æ©Ÿèƒ½B ã‚’è¿½åŠ  (#124)

## ğŸ› ãƒã‚°ä¿®æ­£
- â—‹â—‹ã®å•é¡Œã‚’ä¿®æ­£ (#125)

## ğŸ”§ æ”¹å–„
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ (#126)

## âš ï¸ ç ´å£Šçš„å¤‰æ›´
- ãªã—

## ğŸ“ ç§»è¡Œæ‰‹é †
- ç‰¹ã«ãªã—
```

---

## å¤‰æ›´å±¥æ­´

| æ—¥ä»˜ | å¤‰æ›´å†…å®¹ | å¤‰æ›´è€… |
|------|---------|-------|
| | åˆç‰ˆä½œæˆ | |

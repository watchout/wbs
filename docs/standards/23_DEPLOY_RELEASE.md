# 23_DEPLOY_RELEASE.md - デプロイ・リリースフロー

> mainマージからプロダクション稼働までの完全な手順

---

## デプロイ環境

```
┌──────────┐     ┌──────────┐     ┌──────────┐
│   Dev    │ ──→ │ Staging  │ ──→ │Production│
│ ローカル  │     │ 検証環境  │     │ 本番環境  │
└──────────┘     └──────────┘     └──────────┘
  自動           mainマージで      手動承認後
  各開発者       自動デプロイ       デプロイ
```

---

## デプロイフロー

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  main マージ（CI全グリーン済み）
      │
      ▼
  ① Staging 自動デプロイ
     - DBマイグレーション実行
     - アプリケーションデプロイ
     - 環境変数の確認
      │
      ▼
  ② Staging スモークテスト
     - 主要画面にアクセスできるか
     - ログインできるか
     - 主要APIが応答するか
     - 新機能の基本動作確認
      │
      ├── 全パス → ③へ
      └── 失敗 → 原因調査 → 修正PR → ①から
      │
      ▼
  ③ リリース判定
     - 全機能の完了検証が合格か（22）
     - 未解決のCriticalバグがないか
     - リリースノート作成済みか
      │
      ├── 承認 → ④へ
      └── 未承認 → 不足タスクを完了 → 再判定
      │
      ▼
  ④ Production デプロイ（手動承認）
     - DBマイグレーション実行
     - アプリケーションデプロイ
     - 環境変数の確認
      │
      ▼
  ⑤ Production スモークテスト
     - 主要画面にアクセスできるか
     - ログインできるか
     - 主要APIが応答するか
     - 新機能の基本動作確認
      │
      ├── 全パス → ⑥へ
      └── 失敗 → ロールバック判定
      │
      ▼
  ⑥ モニタリング開始
     - エラーレートの監視（急増していないか）
     - レスポンスタイムの監視
     - リソース使用率の監視
     - 30分間異常なしを確認
      │
      ▼
  ✅ リリース完了

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## Staging スモークテスト項目

```markdown
## スモークテストチェックリスト

### 基本動作
- [ ] トップページが表示される
- [ ] ログインができる
- [ ] ログアウトができる
- [ ] 新規登録ができる

### 今回のリリース対象機能
- [ ] [機能A] の主要フローが動作する
- [ ] [機能B] の主要フローが動作する

### 既存機能の回帰確認
- [ ] [既存機能1] が壊れていない
- [ ] [既存機能2] が壊れていない

### インフラ
- [ ] DBマイグレーションが成功している
- [ ] 環境変数が正しく設定されている
- [ ] 外部サービス連携が動作する
- [ ] コンソールにエラーが出ていない
```

---

## ロールバック手順

```
Production デプロイ後に問題が発生した場合:

  重大度の判定:
  ─────────────────────────────────
  Critical: サービス停止・データ損失
    → 即座にロールバック

  Major: 主要機能の障害
    → 30分以内に修正可能か判断
    → 不可能ならロールバック

  Minor: 軽微なUI崩れ等
    → 通常のバグ修正フローで対応
    → ロールバック不要

  ロールバック手順:
  ─────────────────────────────────
  1. 前バージョンにデプロイを戻す
  2. DBマイグレーションのロールバック（必要な場合）
  3. スモークテスト実施
  4. モニタリングで正常性確認
  5. 原因調査 → 修正 → 再デプロイ
```

---

## リリースノートテンプレート

```markdown
# Release v[X.Y.Z] - [YYYY-MM-DD]

## 新機能
- [FEAT-XXX] [機能名]: [1-2文の説明]
- [FEAT-YYY] [機能名]: [1-2文の説明]

## 改善
- [FEAT-ZZZ] [内容]: [1-2文の説明]

## バグ修正
- [BUG-XXX] [内容]: [1-2文の説明]

## 破壊的変更
- [あれば記載。なければ「なし」]

## 既知の問題
- [あれば記載。なければ「なし」]
```

---

## バージョニング

```
Semantic Versioning (semver) 準拠:

  v[MAJOR].[MINOR].[PATCH]

  MAJOR: 破壊的変更（後方互換性のないAPI変更等）
  MINOR: 新機能追加（後方互換性あり）
  PATCH: バグ修正（後方互換性あり）

  例:
  v1.0.0 → 初回リリース
  v1.1.0 → 新機能追加
  v1.1.1 → バグ修正
  v2.0.0 → 破壊的変更を含むアップデート
```

---

## 変更履歴

| 日付 | 変更内容 | 変更者 |
|------|---------|-------|
| | 初版作成 | |

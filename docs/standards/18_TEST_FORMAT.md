# 18_TEST_FORMAT.md - テスト実施フォーマット

> SSOTのテストケースを実行可能なテストコードに変換し、全パスを保証する

---

## 条件付きTDD（Test-Driven Development）

### TDD強制条件

以下の条件を**すべて**満たす場合、TDD（テストファースト）を**強制**する:

| 条件 | 値 |
|------|-----|
| プロジェクトタイプ | `api` または `cli` |
| SSOT層 | `CORE` または `CONTRACT` |

**TDD強制フロー**:
```
SSOT
  ↓
テスト作成（RED: 失敗するテストを先に書く）
  ↓
実装（GREEN: テストがパスする最小限のコードを書く）
  ↓
リファクタリング（REFACTOR: コードを整理）
  ↓
コード監査（17_CODE_AUDIT.md）
  ↓
CI/PR
```

### TDD任意条件

以下の**いずれか**に該当する場合、TDDは**任意**（後付けテストOK）:

| 条件 |
|------|
| プロジェクトタイプが `app`, `lp`, `hp` |
| SSOT層が `DETAIL` |
| UI/フロントエンド実装 |

**後付けテストフロー**:
```
SSOT
  ↓
実装
  ↓
コード監査（17_CODE_AUDIT.md）
  ↓
テスト作成
  ↓
テスト監査（このドキュメント）
  ↓
ビジュアルテスト（UIの場合、20_VISUAL_TEST.md）
  ↓
CI/PR
```

### TDD判定フローチャート

```
タスク開始
    │
    ├─ プロジェクトタイプは api or cli ?
    │       │
    │       ├─ YES → SSOT層は CORE or CONTRACT ?
    │       │           │
    │       │           ├─ YES → ■ TDD強制
    │       │           └─ NO  → □ TDD任意
    │       │
    │       └─ NO  → □ TDD任意
    │
    └─ UI/フロントエンドか？
            │
            └─ YES → □ TDD任意（ビジュアルテスト優先）
```

---

## 準拠規格

| 規格 | 適用 |
|------|------|
| IEEE 829:2008 | テストドキュメントの構造 |
| ISTQB Foundation | テストレベル・テスト技法の分類 |
| ISO/IEC 25010 | 品質特性に基づくテスト観点 |

---

## テストの全体構造

```
SSOTの §10 テストケース
    │
    ├── 正常系テスト（TC-N-XXX）
    ├── 異常系テスト（TC-E-XXX）
    └── 境界値テスト（TC-B-XXX）
    │
    ▼
テストレベル別に実装:

  Level 1: 単体テスト（Unit Test）
  ──────────────────────────────
  対象: 個々の関数・モジュール
  ツール: Vitest / Jest
  実行: ローカル + CI
  カバレッジ目標: 80%以上

  Level 2: 統合テスト（Integration Test）
  ──────────────────────────────
  対象: API エンドポイント（DB含む）
  ツール: Vitest + Supertest / テスト用DB
  実行: ローカル + CI
  カバレッジ: 全エンドポイント

  Level 3: E2Eテスト（End-to-End Test）
  ──────────────────────────────
  対象: ユーザー操作フロー全体
  ツール: Playwright / Cypress
  実行: CI（Staging環境）
  カバレッジ: 主要フロー
```

---

## テストコード生成プロンプト

### 単体テスト

```markdown
# [FEAT-XXX-TEST-UNIT] 単体テスト生成

## §1 ロール
あなたは [テスティングフレームワーク] に精通した
シニアQAエンジニアです。
以下の原則に従ってテストを書いてください:
- テストは仕様（SSOT）に基づく（実装に基づかない）
- 1テスト1アサーション を原則とする
- テスト名は日本語で内容がわかるようにする
- Arrange-Act-Assert パターンを使う

## §2 コンテキスト

### テストケース（SSOTの§10 原文）
[SSOTの§10を全文貼り付け]

### テスト対象コード
[実装済みのソースコード全文]

### テスティング設定
[vitest.config.ts / jest.config.ts の内容]

## §3 タスク

### 実装するテスト
以下のテストケースを全て実装してください:

正常系:
- TC-N-001: [テスト名]
- TC-N-002: [テスト名]

異常系:
- TC-E-001: [テスト名]
- TC-E-002: [テスト名]

境界値:
- TC-B-001: [テスト名]
- TC-B-002: [テスト名]

### ファイル構成
[テストファイルのパス]

## §4 制約
- SSOTの §10 に定義された全テストケースを漏れなく実装
- テストケースIDをテスト名に含める
- モックは最小限（外部APIのみモック、DB はテスト用DBを使用）
- テストデータはファクトリ関数で生成
- テスト間の独立性を保つ（順序依存しない）

## §5 アウトプット
完全なテストファイルを出力してください。
省略・TODO・コメントアウトは不可。

## §6 受け入れ基準
- [ ] SSOTの §10 の全テストケースが実装されている
- [ ] 全テストが独立して実行可能
- [ ] テスト名から何をテストしているか明確
- [ ] 全テストがパスする

## §7 禁止事項
- テストケースの省略
- it.skip / xit / xdescribe
- ハードコードされた本番データ
- テスト間の暗黙的な順序依存
- 実装の内部構造に依存したテスト
```

### 統合テスト

```markdown
# [FEAT-XXX-TEST-INT] 統合テスト生成

## §1 ロール
あなたはAPIテストに精通したシニアQAエンジニアです。

## §2 コンテキスト

### API仕様（SSOTの§5 原文）
[SSOTの§5を全文貼り付け]

### エラーケース（SSOTの§9 原文）
[SSOTの§9を全文貼り付け]

### テストケース（SSOTの§10 原文）
[SSOTの§10を全文貼り付け]

### 実装済みコード
[Route Handler / API実装の全文]

## §3 タスク
以下の全エンドポイントの統合テストを実装:

| メソッド | パス | テスト内容 |
|---------|------|----------|
| POST | /api/v1/xxx | 作成の正常系・異常系 |
| GET | /api/v1/xxx/:id | 取得の正常系・404 |
| ... | ... | ... |

各エンドポイントについて:
- 正常系（成功レスポンス）
- バリデーションエラー（400）
- 認証エラー（401）
- 認可エラー（403）
- 存在しないリソース（404）
- サーバーエラーのハンドリング

## §4 制約
- 実際のDB（テスト用）を使用
- テスト前にDBをクリーン → シードデータ投入
- 各テスト後にトランザクションロールバック
- 外部APIのみモック
```

### E2Eテスト

```markdown
# [FEAT-XXX-TEST-E2E] E2Eテスト生成

## §1 ロール
あなたは Playwright に精通したシニアQAエンジニアです。

## §2 コンテキスト

### ユーザーフロー（SSOTの§2.4 原文）
[SSOTの§2.4 ユーザーフローを全文貼り付け]

### UI仕様（SSOTの§6 原文）
[SSOTの§6を全文貼り付け]

### テストケース（SSOTの§10 正常系）
[SSOTの§10 正常系を全文貼り付け]

## §3 タスク
ユーザーの操作フローを再現するE2Eテスト:

1. [ページアクセス]
2. [入力操作]
3. [ボタンクリック]
4. [結果確認]
5. [次の画面遷移確認]

## §4 制約
- Page Object Model パターンを使用
- テストデータはAPI経由でセットアップ
- スクリーンショットを各ステップで取得
- タイムアウトは適切に設定（デフォルト30秒）
- CI環境でのヘッドレス実行を前提
```

---

## テスト実行と合格基準

### テスト実行フロー

```
  テストコード完成
      │
      ▼
  ① ローカル実行
     - 全テストを実行
     - パス/失敗を確認
      │
      ├── 全パス → ②へ
      └── 失敗あり → 原因分析 → 修正 → 再実行
      │
      ▼
  ② カバレッジ確認
     - カバレッジレポート生成
     - 目標値を確認
      │
      ├── 目標達成 → ③へ
      └── 未達 → テスト追加 → 再実行
      │
      ▼
  ③ テスト品質チェック
     - スコアリング
      │
      ├── 100点 → 合格 ✅ → CI/PRへ
      └── 99点以下 → 修正 → 再チェック
```

### テスト品質スコアカード（100点満点）

```
┌─ テスト品質スコアカード ─────────────────────────────────────────────┐
│                                                                       │
│  #   カテゴリ             配点   評価基準                             │
│  ─────────────────────────────────────────────────────────────────── │
│  1   SSOT網羅性           30    §10の全テストケースが実装されているか │
│  2   テスト実行結果       25    全テストがパスするか                  │
│  3   カバレッジ           15    ステートメントカバレッジ80%以上       │
│  4   テスト品質           15    独立性・再現性・命名の適切さ         │
│  5   エッジケース         10    境界値・空データ・大量データのテスト  │
│  6   テスト保守性         5     可読性・DRY・ファクトリ使用          │
│                                                                       │
│  合計                    100                                          │
│  合格ライン              100点（満点必須）                            │
│                                                                       │
└───────────────────────────────────────────────────────────────────────┘
```

### カテゴリ別基準

```
1. SSOT網羅性（30点）
   SSOTの §10 の全テストケースと照合:
   - TC-N-001 → test('TC-N-001: ...') ✅
   - TC-N-002 → test('TC-N-002: ...') ✅
   - TC-E-001 → 未実装 ❌ → -5点
   未実装テストケース: -5点/件

2. テスト実行結果（25点）
   全テストパス: 25点
   1件でも失敗: 0点（全額減点。失敗するテストは存在してはならない）

3. カバレッジ（15点）
   90%以上: 15点
   80-89%: 10点
   70-79%: 5点
   70%未満: 0点

4. テスト品質（15点）
   - テスト間の独立性: 5点
   - テスト名の明確さ（日本語で内容がわかる）: 5点
   - Arrange-Act-Assert パターン: 5点

5. エッジケース（10点）
   - 境界値テスト: 4点
   - 空データテスト: 3点
   - エラーケーステスト: 3点

6. テスト保守性（5点）
   - ファクトリ関数の使用: 2点
   - ヘルパー関数の適切な抽出: 2点
   - テストデータの管理: 1点
```

---

## テスト監査レポートテンプレート

```markdown
# テスト品質監査レポート

## 対象
| 項目 | 内容 |
|------|------|
| タスクID | [FEAT-XXX-TEST] |
| テストファイル | [ファイル一覧] |
| 監査日 | [YYYY-MM-DD] |

## SSOT網羅性チェック

| テストケースID | テスト名 | 実装 | パス |
|---------------|---------|------|------|
| TC-N-001 | [名前] | ✅/❌ | ✅/❌ |
| TC-N-002 | [名前] | ✅/❌ | ✅/❌ |
| TC-E-001 | [名前] | ✅/❌ | ✅/❌ |
| TC-B-001 | [名前] | ✅/❌ | ✅/❌ |

## テスト実行結果
- 合計: X件
- パス: X件
- 失敗: X件
- スキップ: X件（0件であること）

## カバレッジ
- ステートメント: XX%
- ブランチ: XX%
- 関数: XX%
- 行: XX%

## スコア

| # | カテゴリ | 配点 | 得点 | 減点理由 |
|---|---------|------|------|---------|
| 1 | SSOT網羅性 | 30 | /30 | |
| 2 | テスト実行結果 | 25 | /25 | |
| 3 | カバレッジ | 15 | /15 | |
| 4 | テスト品質 | 15 | /15 | |
| 5 | エッジケース | 10 | /10 | |
| 6 | テスト保守性 | 5 | /5 | |
| **合計** | | **100** | **/100** | |
```

---

## 変更履歴

| 日付 | 変更内容 | 変更者 |
|------|---------|-------|
| | 条件付きTDD導入（api/cli + CORE/CONTRACT で強制） | |
| | 初版作成 | |

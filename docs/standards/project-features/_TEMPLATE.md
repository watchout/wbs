# 機能仕様テンプレート

> AIが実装時に参照する「完全な仕様書」のフォーマット
> このテンプレートの全セクションが埋まって初めて「L3（実装可能）」レベル

---

# {FEATURE_ID}: {機能名}

## メタ情報

| 項目 | 内容 |
|------|------|
| 機能ID | {AUTH-001} |
| 機能名 | {ログイン機能} |
| カテゴリ | {認証・認可} |
| 優先度 | {P0 / P1 / P2 / P3} |
| ステータス | {Draft / Review / Approved / Implemented} |
| 作成者 | |
| 作成日 | YYYY-MM-DD |
| 最終更新日 | YYYY-MM-DD |
| レビュアー | |
| 承認者 | |

---

## 1. 概要

### 1.1 機能の目的（1-2文）

{この機能が何を実現するか、なぜ必要かを簡潔に}

### 1.2 ユーザーストーリー

```
As a {ユーザータイプ},
I want to {やりたいこと},
so that {得られる価値}.
```

### 1.3 スコープ

**In Scope（この機能でやること）**:
- 
- 
- 

**Out of Scope（この機能ではやらないこと）**:
- 
- 

---

## 2. 受入条件（Acceptance Criteria）

> ✅ 全ての受入条件が検証可能（テスト可能）であること

### 2.1 正常系

| # | 条件 | 検証方法 |
|---|------|---------|
| AC-001 | {ユーザーが正しいメール/パスワードを入力したとき、ログインに成功する} | {ユニットテスト / E2Eテスト} |
| AC-002 | {ログイン成功後、ダッシュボード（/app）に遷移する} | {E2Eテスト} |
| AC-003 | {nextパラメータがある場合、指定されたURLに遷移する} | {E2Eテスト} |

### 2.2 異常系

| # | 条件 | 検証方法 |
|---|------|---------|
| AC-101 | {パスワードが間違っている場合、エラーメッセージ「メールアドレスまたはパスワードが正しくありません」を表示} | {ユニットテスト} |
| AC-102 | {存在しないメールアドレスの場合、同じエラーメッセージを表示（情報漏洩防止）} | {ユニットテスト} |
| AC-103 | {アカウントがロックされている場合、「アカウントがロックされています」を表示} | {ユニットテスト} |

### 2.3 エッジケース

| # | 条件 | 検証方法 |
|---|------|---------|
| AC-201 | {ログイン5回失敗でアカウントを30分ロック} | {統合テスト} |
| AC-202 | {セッション有効期限切れ後にログイン画面にリダイレクト} | {E2Eテスト} |
| AC-203 | {同時ログインは最大3デバイスまで、超過時は最古セッションを無効化} | {統合テスト} |

---

## 3. UI仕様

### 3.1 画面一覧

| Screen ID | 画面名 | パス | 認証 |
|-----------|-------|------|------|
| SCR-LOGIN | ログイン画面 | /login | 不要 |

### 3.2 画面レイアウト

```
┌─────────────────────────────────────────┐
│              ロゴ                        │
├─────────────────────────────────────────┤
│                                         │
│  ┌─────────────────────────────────┐   │
│  │ メールアドレス                    │   │
│  └─────────────────────────────────┘   │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │ パスワード              [👁]     │   │
│  └─────────────────────────────────┘   │
│                                         │
│  [ ] ログイン状態を保持する              │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │         ログイン                 │   │
│  └─────────────────────────────────┘   │
│                                         │
│  パスワードをお忘れですか？              │
│                                         │
│  ────────── または ──────────          │
│                                         │
│  [G] Googleでログイン                   │
│                                         │
│  アカウントをお持ちでない方 → 新規登録    │
│                                         │
└─────────────────────────────────────────┘
```

### 3.3 UI要素詳細

| 要素 | 種類 | バリデーション | 備考 |
|------|------|--------------|------|
| メールアドレス | input[type=email] | 必須、メール形式 | プレースホルダー: "example@email.com" |
| パスワード | input[type=password] | 必須、8文字以上 | 表示/非表示トグルあり |
| ログイン状態を保持 | checkbox | - | チェック時: 30日間セッション維持 |
| ログインボタン | button | - | 送信中は「ログイン中...」+ スピナー |
| パスワード忘れリンク | link | - | → /forgot-password |
| Googleログインボタン | button | - | OAuth 2.0フロー開始 |
| 新規登録リンク | link | - | → /signup |

### 3.4 状態別表示

| 状態 | 表示内容 |
|------|---------|
| 初期表示 | フォーム表示 |
| バリデーションエラー | フィールド下に赤字でエラーメッセージ |
| 送信中 | ボタン無効化 + スピナー |
| サーバーエラー | フォーム上部にエラーバナー |
| ログイン成功 | リダイレクト（UIフィードバックなし） |

### 3.5 レスポンシブ対応

| ブレークポイント | 対応 |
|----------------|------|
| モバイル（< 640px） | フォーム幅100%、余白調整 |
| タブレット（640-1024px） | フォーム幅80%、中央配置 |
| デスクトップ（> 1024px） | フォーム幅400px固定、中央配置 |

---

## 4. 状態遷移

### 4.1 認証状態（参照: SSOT-2）

この機能で扱う認証状態:
- S0: LOGGED_OUT（未ログイン）
- S1: LOGGED_IN（ログイン済み）

### 4.2 この機能の状態遷移

```
                    ┌─────────────┐
                    │  S0: 未認証  │
                    └──────┬──────┘
                           │
                    submit_login
                           │
                    ┌──────▼──────┐
                    │   処理中     │
                    └──────┬──────┘
                           │
            ┌──────────────┼──────────────┐
            │              │              │
     login_success    login_failure   account_locked
            │              │              │
     ┌──────▼──────┐ ┌─────▼─────┐ ┌─────▼─────┐
     │ S1: 認証済み │ │ エラー表示 │ │ ロック表示 │
     │ → リダイレクト│ │ → S0に戻る│ │           │
     └─────────────┘ └───────────┘ └───────────┘
```

### 4.3 遷移ルール

| 現在の状態 | イベント | 次の状態 | アクション |
|-----------|---------|---------|-----------|
| S0 | ページアクセス | S0 | フォーム表示 |
| S0 | submit_login | 処理中 | API呼び出し |
| 処理中 | login_success | S1 | nextパラメータまたは/appへ遷移 |
| 処理中 | login_failure | S0 | エラーメッセージ表示 |
| 処理中 | account_locked | S0 | ロックメッセージ表示 |
| S1 | ページアクセス | S1 | /appへリダイレクト（既にログイン済み） |

---

## 5. API仕様

### 5.1 エンドポイント一覧

| メソッド | パス | 説明 | 認証 |
|---------|------|------|------|
| POST | /api/v1/auth/login | ログイン | 不要 |

### 5.2 POST /api/v1/auth/login

**リクエスト**:

```json
{
  "email": "user@example.com",
  "password": "password123",
  "remember_me": true
}
```

| フィールド | 型 | 必須 | バリデーション |
|-----------|-----|------|--------------|
| email | string | ✅ | メール形式、最大255文字 |
| password | string | ✅ | 8文字以上、128文字以下 |
| remember_me | boolean | - | デフォルト: false |

**レスポンス（成功）**: `200 OK`

```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIs...",
  "refresh_token": "eyJhbGciOiJIUzI1NiIs...",
  "token_type": "Bearer",
  "expires_in": 3600,
  "user": {
    "id": "usr_abc123",
    "email": "user@example.com",
    "name": "John Doe",
    "role": "user",
    "avatar_url": null
  }
}
```

**レスポンス（エラー）**:

| HTTPステータス | エラーコード | 条件 | メッセージ |
|--------------|-------------|------|-----------|
| 400 | VAL_001 | バリデーションエラー | "Validation failed" |
| 401 | AUTH_001 | 認証失敗 | "Invalid credentials" |
| 423 | AUTH_004 | アカウントロック | "Account locked. Try again in {minutes} minutes" |
| 429 | RATE_001 | レート制限 | "Too many attempts. Try again later" |

**エラーレスポンス形式**（参照: SSOT-3）:

```json
{
  "error": {
    "code": "AUTH_001",
    "message": "Invalid credentials",
    "details": null
  }
}
```

**バリデーションエラー時**:

```json
{
  "error": {
    "code": "VAL_001",
    "message": "Validation failed",
    "details": {
      "fields": {
        "email": ["Invalid email format"],
        "password": ["Must be at least 8 characters"]
      }
    }
  }
}
```

---

## 6. データモデル

### 6.1 関連テーブル

| テーブル | 用途 | 参照 |
|---------|------|------|
| users | ユーザー情報 | SSOT-4 |
| sessions | セッション管理 | SSOT-4 |
| login_attempts | ログイン試行記録 | 下記参照 |

### 6.2 新規/変更テーブル

#### login_attempts（新規）

| カラム | 型 | NULL | 説明 |
|--------|-----|------|------|
| id | VARCHAR(36) | NO | 主キー |
| email | VARCHAR(255) | NO | 試行したメールアドレス |
| ip_address | VARCHAR(45) | NO | IPアドレス |
| success | BOOLEAN | NO | 成功/失敗 |
| failure_reason | VARCHAR(50) | YES | 失敗理由（invalid_password, account_locked等） |
| created_at | TIMESTAMP | NO | 試行日時 |

**インデックス**:
- `idx_login_attempts_email_created` (email, created_at)
- `idx_login_attempts_ip_created` (ip_address, created_at)

### 6.3 データ操作

| 操作 | テーブル | 内容 |
|------|---------|------|
| READ | users | メールアドレスでユーザー検索 |
| READ | login_attempts | 過去30分の失敗回数カウント |
| CREATE | sessions | 新規セッション作成 |
| CREATE | login_attempts | ログイン試行記録 |
| UPDATE | users | last_login_at更新 |

---

## 7. ビジネスロジック

### 7.1 処理フロー

```
1. 入力バリデーション
   ├─ 失敗 → VAL_001エラー
   └─ 成功 → 2へ

2. アカウントロック確認（過去30分で5回失敗）
   ├─ ロック中 → AUTH_004エラー
   └─ ロックなし → 3へ

3. ユーザー検索（メールアドレス）
   ├─ 見つからない → login_attempts記録 → AUTH_001エラー
   └─ 見つかった → 4へ

4. パスワード検証（bcrypt）
   ├─ 不一致 → login_attempts記録 → AUTH_001エラー
   └─ 一致 → 5へ

5. アカウント状態確認
   ├─ inactive/suspended → AUTH_005エラー
   └─ active → 6へ

6. セッション作成
   ├─ remember_me=true → 30日間有効
   └─ remember_me=false → 24時間有効

7. 同時セッション数確認
   ├─ 3以上 → 最古のセッションを無効化
   └─ 3未満 → そのまま

8. レスポンス返却
   ├─ login_attempts記録（成功）
   ├─ users.last_login_at更新
   └─ トークン返却
```

### 7.2 セキュリティ要件

| 要件 | 実装 |
|------|------|
| パスワード保存 | bcrypt（cost=12） |
| レート制限 | 同一IP: 10回/分、同一メール: 5回/30分 |
| アカウントロック | 5回失敗で30分ロック |
| 情報漏洩防止 | メール存在有無を漏らさない（同じエラーメッセージ） |
| セッションID | UUID v4（推測不可能） |
| トークン有効期限 | アクセス: 1時間、リフレッシュ: 30日 |

---

## 8. エラーハンドリング

### 8.1 フロントエンド

| エラー種別 | 表示方法 | メッセージ |
|-----------|---------|-----------|
| バリデーションエラー | フィールド下 | APIから返されたメッセージ |
| 認証エラー | フォーム上部バナー | 「メールアドレスまたはパスワードが正しくありません」 |
| アカウントロック | フォーム上部バナー | 「アカウントがロックされています。{minutes}分後に再試行してください」 |
| ネットワークエラー | フォーム上部バナー | 「通信エラーが発生しました。再試行してください」 |
| サーバーエラー | フォーム上部バナー | 「システムエラーが発生しました。しばらく経ってから再試行してください」 |

### 8.2 バックエンド

| エラー種別 | HTTPステータス | ログレベル | ログ内容 |
|-----------|--------------|-----------|---------|
| バリデーションエラー | 400 | DEBUG | リクエスト内容（パスワード除く） |
| 認証失敗 | 401 | INFO | email(masked), ip, user_agent |
| アカウントロック | 423 | WARN | email(masked), ip, lock_until |
| レート制限 | 429 | WARN | ip, endpoint, count |
| サーバーエラー | 500 | ERROR | スタックトレース |

---

## 9. テスト仕様

### 9.1 ユニットテスト

| テストケース | 入力 | 期待結果 |
|-------------|------|---------|
| 正常ログイン | 正しいemail/password | 200 + トークン返却 |
| パスワード不正 | 正しいemail + 不正password | 401 + AUTH_001 |
| メール不正 | 存在しないemail | 401 + AUTH_001（同じエラー） |
| バリデーション（email空） | email="" | 400 + VAL_001 |
| バリデーション（email形式不正） | email="invalid" | 400 + VAL_001 |
| バリデーション（password短い） | password="1234567" | 400 + VAL_001 |
| アカウントロック | 5回失敗後 | 423 + AUTH_004 |
| ロック解除 | 30分経過後 | 200（成功時） |

### 9.2 統合テスト

| テストケース | 手順 | 期待結果 |
|-------------|------|---------|
| ログイン→セッション作成 | ログイン成功 | sessionsテーブルにレコード作成 |
| 同時セッション制限 | 4台目でログイン | 最古セッション無効化 |
| ログイン試行記録 | ログイン試行 | login_attemptsにレコード作成 |

### 9.3 E2Eテスト

| テストケース | 手順 | 期待結果 |
|-------------|------|---------|
| 正常ログインフロー | /login → 入力 → 送信 | /appに遷移 |
| nextパラメータ | /login?next=/settings → ログイン | /settingsに遷移 |
| エラー表示 | 不正パスワード入力 | エラーメッセージ表示 |
| パスワード表示切替 | 目アイコンクリック | パスワード表示/非表示 |

---

## 10. 非機能要件

### 10.1 パフォーマンス

| 指標 | 目標値 |
|------|-------|
| API応答時間 | < 500ms（p95） |
| ページ読み込み | < 2秒（LCP） |

### 10.2 可用性

| 指標 | 目標値 |
|------|-------|
| 稼働率 | 99.9% |

### 10.3 セキュリティ

| 項目 | 対応 |
|------|------|
| HTTPS | 必須 |
| CSRF | トークン検証 |
| XSS | 入力サニタイズ |
| ブルートフォース | レート制限 + アカウントロック |

---

## 11. 依存関係

### 11.1 前提となる機能

| 機能ID | 機能名 | 依存内容 |
|--------|-------|---------|
| - | - | （この機能は依存なし） |

### 11.2 この機能に依存する機能

| 機能ID | 機能名 | 依存内容 |
|--------|-------|---------|
| AUTH-005 | ログアウト | セッション管理 |
| AUTH-009 | セッション管理 | sessions テーブル |

---

## 12. 実装メモ（AI向け）

### 12.1 実装順序

```
1. DBマイグレーション（login_attemptsテーブル作成）
2. バックエンドAPI（/api/v1/auth/login）
3. フロントエンドコンポーネント（LoginForm）
4. フロントエンドページ（/login）
5. ユニットテスト
6. 統合テスト
```

### 12.2 参照すべきファイル

| 種類 | ファイル | 参照内容 |
|------|---------|---------|
| 認証共通 | SSOT-5_CROSS_CUTTING.md | 認証方式、トークン管理 |
| API共通 | SSOT-3_API_CONTRACT.md | エラーレスポンス形式 |
| DB共通 | SSOT-4_DATA_MODEL.md | users, sessions テーブル定義 |
| UI共通 | SSOT-2_UI_STATE.md | 認証状態定義 |

### 12.3 注意事項

- パスワードは絶対にログに出力しない
- メールアドレスはログ出力時にマスク（u***@example.com）
- エラーメッセージでメールの存在有無を漏らさない
- bcryptのcostは12を使用

---

## 変更履歴

| 日付 | バージョン | 変更内容 | 変更者 |
|------|----------|---------|-------|
| | v1.0 | 初版作成 | |

---

## 承認

| 役割 | 名前 | 日付 | 承認 |
|------|------|------|------|
| 設計者 | | | ☐ |
| テックリード | | | ☐ |
| プロダクトオーナー | | | ☐ |

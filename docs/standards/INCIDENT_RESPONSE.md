# INCIDENT_RESPONSE.md - 障害対応手順書

> 障害発生時の対応フロー、エスカレーション、ポストモーテム

---

## 基本情報

| 項目 | 内容 |
|------|------|
| プロジェクト名 | |
| 最終更新日 | YYYY-MM-DD |
| 緊急連絡先 | #incident-response (Slack) |

---

## 1. 障害レベル定義

| レベル | 名称 | 定義 | 対応時間 | 例 |
|-------|------|------|---------|-----|
| SEV1 | Critical | サービス全停止、データ損失 | 即座 | 全ユーザーがアクセス不可 |
| SEV2 | Major | 主要機能停止、一部ユーザー影響 | 15分以内 | ログインできない |
| SEV3 | Minor | 機能制限あり、回避策あり | 1時間以内 | 一部機能が遅い |
| SEV4 | Low | 軽微な問題、ユーザー影響小 | 4時間以内 | UIの表示崩れ |

---

## 2. 障害対応フロー

### 2.1 全体フロー

```
┌─────────────┐
│ 障害検知    │ ← アラート or ユーザー報告
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 初動対応    │ ← 状況確認・レベル判定
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 体制構築    │ ← インシデントコマンダー任命
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 調査・復旧  │ ← 原因特定・対処実行
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 収束確認    │ ← 正常性確認・監視継続
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 振り返り    │ ← ポストモーテム
└─────────────┘
```

### 2.2 タイムライン目安（SEV1の場合）

| 経過時間 | アクション |
|---------|-----------|
| 0分 | 障害検知・初動開始 |
| 5分 | レベル判定・エスカレーション |
| 10分 | インシデントコマンダー任命・体制構築 |
| 15分 | 第一報（Slack/ステータスページ） |
| 30分以内 | 原因特定 or 暫定対処 |
| 随時 | 30分ごとに状況更新 |
| 復旧後 | 収束宣言・監視継続 |
| 1-3日後 | ポストモーテム実施 |

---

## 3. 役割分担

### 3.1 インシデント対応チーム

| 役割 | 責任 | 担当者 |
|------|------|-------|
| **インシデントコマンダー (IC)** | 全体指揮、意思決定 | |
| **コミュニケーション担当** | 社内外への連絡 | |
| **テクニカルリード** | 技術調査・復旧作業 | |
| **記録係** | タイムライン記録 | |

### 3.2 役割の決め方

| SEVレベル | インシデントコマンダー |
|----------|---------------------|
| SEV1 | テックリード or CTO |
| SEV2 | 当番 or シニアエンジニア |
| SEV3 | 発見者 or 当番 |
| SEV4 | 発見者 |

---

## 4. 初動対応

### 4.1 最初の5分でやること

```bash
# 1. 状況確認
- [ ] どの機能が影響を受けているか
- [ ] いつから発生しているか
- [ ] どの程度のユーザーが影響を受けているか

# 2. レベル判定
- [ ] SEV1-4のどれに該当するか

# 3. 連絡
- [ ] #incident-response に報告
- [ ] 必要に応じてエスカレーション
```

### 4.2 初報テンプレート

```markdown
🚨 **インシデント発生**

**概要**: [何が起きているか]
**検知時刻**: YYYY-MM-DD HH:MM JST
**影響範囲**: [影響を受けている機能・ユーザー]
**暫定レベル**: SEV[1-4]

**現在の状況**: 調査中
**対応者**: @xxx

---
スレッドで更新します
```

---

## 5. 調査・復旧

### 5.1 調査チェックリスト

| # | 確認項目 | 確認方法 |
|---|---------|---------|
| 1 | 直近のデプロイ | デプロイ履歴確認 |
| 2 | エラーログ | Sentry / CloudWatch |
| 3 | インフラ状態 | CloudWatch / Datadog |
| 4 | DB状態 | 接続数、クエリ、レプリケーション |
| 5 | 外部サービス | ステータスページ確認 |
| 6 | 設定変更 | 環境変数、インフラ設定 |

### 5.2 よくある原因と対処

| 原因 | 症状 | 対処 |
|------|------|------|
| デプロイ失敗 | デプロイ直後にエラー急増 | ロールバック |
| DB接続枯渇 | タイムアウトエラー多発 | 接続プール調整・再起動 |
| メモリリーク | 時間とともに悪化 | 再起動・調査 |
| 外部API障害 | 特定機能のみエラー | フォールバック・待機 |
| DDoS/高負荷 | リクエスト数急増 | スケール・レート制限 |
| 証明書期限切れ | HTTPS接続エラー | 証明書更新 |

### 5.3 復旧アクション

```bash
# ロールバック
vercel rollback [deployment-url]

# サービス再起動（該当する場合）
# ECS / Kubernetes / etc.

# スケールアウト
# インスタンス追加

# DB接続リセット
# 接続プールリセット

# キャッシュクリア
# Redis flush / CDN purge
```

---

## 6. コミュニケーション

### 6.1 社内連絡

**更新頻度**:
- SEV1: 15分ごと
- SEV2: 30分ごと
- SEV3/4: 状況変化時

**更新テンプレート**:

```markdown
📢 **インシデント更新** (HH:MM)

**状況**: [調査中/復旧作業中/監視中/収束]
**進捗**: [やったこと]
**次のアクション**: [予定]
**ETA**: [見込み時間、わかれば]
```

### 6.2 社外連絡（必要な場合）

**ステータスページ更新**:

```markdown
[Investigating] YYYY-MM-DD HH:MM JST
現在、[機能名]において問題が発生しており、調査を行っております。

[Update] YYYY-MM-DD HH:MM JST
原因を特定し、復旧作業を行っております。

[Resolved] YYYY-MM-DD HH:MM JST
問題は解消いたしました。ご不便をおかけし申し訳ございませんでした。
```

### 6.3 収束宣言

```markdown
✅ **インシデント収束**

**収束時刻**: YYYY-MM-DD HH:MM JST
**影響時間**: X時間Y分
**原因**: [簡潔な原因]
**対処**: [実施した対処]

ポストモーテムは[日付]に実施予定です。
```

---

## 7. ポストモーテム

### 7.1 実施タイミング

| SEVレベル | ポストモーテム |
|----------|--------------|
| SEV1 | 必須（3日以内） |
| SEV2 | 必須（1週間以内） |
| SEV3 | 推奨 |
| SEV4 | 任意 |

### 7.2 ポストモーテムテンプレート

```markdown
# ポストモーテム: [インシデント名]

## 概要
| 項目 | 内容 |
|------|------|
| 発生日時 | YYYY-MM-DD HH:MM - HH:MM JST |
| 影響時間 | X時間Y分 |
| 影響範囲 | [影響を受けたユーザー/機能] |
| SEVレベル | SEV[1-4] |
| インシデントコマンダー | @xxx |

## タイムライン

| 時刻 | イベント |
|------|---------|
| HH:MM | 障害検知 |
| HH:MM | 調査開始 |
| HH:MM | 原因特定 |
| HH:MM | 復旧作業開始 |
| HH:MM | 復旧確認 |
| HH:MM | 収束宣言 |

## 根本原因
[技術的な原因を詳細に記述]

## 影響
- ユーザー影響: [具体的な影響]
- ビジネス影響: [売上、信頼性など]

## 対応内容
[実施した対応を時系列で記述]

## うまくいったこと
- 
- 

## 改善が必要なこと
- 
- 

## アクションアイテム

| # | アクション | 担当 | 期限 | 優先度 |
|---|-----------|------|------|-------|
| 1 | | | | |
| 2 | | | | |
| 3 | | | | |

## 再発防止策
[同じ問題が起きないようにするための対策]

## 学び
[今回の障害から学んだこと]
```

### 7.3 ポストモーテムの原則

- **非難しない（Blameless）**: 個人を責めず、システム・プロセスの改善に焦点
- **事実ベース**: 推測ではなく、ログ・データに基づく
- **アクション重視**: 具体的な改善アクションを決める
- **共有**: チーム全体で学びを共有

---

## 8. 緊急連絡先

### 8.1 社内

| 役割 | 担当者 | 連絡先 |
|------|-------|-------|
| テックリード | | Slack: @ / 電話: |
| CTO | | Slack: @ / 電話: |
| インフラ担当 | | Slack: @ / 電話: |
| プロダクトオーナー | | Slack: @ / 電話: |

### 8.2 外部

| サービス | サポート連絡先 | 備考 |
|---------|--------------|------|
| AWS | | |
| Vercel | | |
| Supabase | | |
| Stripe | | |

---

## 9. ランブック（よくある障害の対応手順）

### 9.1 サービス全停止

```bash
1. Vercelステータス確認: https://www.vercel-status.com/
2. 直近のデプロイ確認
3. ロールバック実行: vercel rollback
4. DBステータス確認
5. 外部サービスステータス確認
```

### 9.2 DB接続エラー

```bash
1. DB接続数確認
2. 接続プール設定確認
3. DB再起動（必要な場合）
4. アプリ再起動（必要な場合）
```

### 9.3 高負荷

```bash
1. リクエスト数・パターン確認
2. 不正アクセスの有無確認
3. スケールアウト実行
4. レート制限強化（必要な場合）
```

---

## 変更履歴

| 日付 | 変更内容 | 変更者 |
|------|---------|-------|
| | 初版作成 | |

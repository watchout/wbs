# SSOT 12セクション形式

> Version: 3.0
> 対象: [DETAIL] 層の機能仕様書

---

## 概要

DETAIL層の機能仕様書は、以下の12セクション形式で記述する。
この形式により、AIエージェントが仕様を正確に理解し、実装できる。

---

## 12セクション構成

```markdown
# 機能名 [DETAIL]

> 機能ID: FEAT-XXX
> ステータス: Draft | Review | Approved | Implemented
> 最終更新: YYYY-MM-DD
> 関連: SSOT-1 の機能ID

---

## 1. 概要 (Overview)
機能の目的と背景を1-3文で説明。

## 2. ユーザーストーリー (User Stories)
- As a [役割], I want [機能], so that [価値]
- 受入条件を箇条書きで列挙

## 3. 画面仕様 (UI Specification)
- 画面レイアウト（図またはASCII）
- コンポーネント一覧
- 状態遷移

## 4. API仕様 (API Specification)
- エンドポイント定義
- リクエスト/レスポンス形式
- エラーコード

## 5. データモデル (Data Model)
- 関連エンティティ
- フィールド定義
- 制約条件

## 6. ビジネスロジック (Business Logic)
- 処理フロー
- 計算ルール
- バリデーション

## 7. エラーハンドリング (Error Handling)
- エラーケース一覧
- ユーザーへの表示メッセージ
- リカバリー方法

## 8. セキュリティ (Security)
- 認証・認可要件
- データ保護
- 監査ログ

## 9. パフォーマンス (Performance)
- 応答時間目標
- スケーラビリティ考慮
- キャッシュ戦略

## 10. テストケース (Test Cases)
- 正常系テスト
- 異常系テスト
- 境界値テスト

## 11. 実装メモ (Implementation Notes)
- 技術的な注意点
- 依存関係
- マイグレーション手順

## 12. 未決事項 (Open Issues)
- TBD 項目
- 要確認事項
- 将来の拡張
```

---

## セクション詳細ガイド

### 1. 概要 (Overview)

**必須項目:**
- 機能の目的（1文）
- 背景・動機（1-2文）
- スコープ（対象/対象外）

**例:**
```markdown
## 1. 概要

スケジュール登録機能は、現場作業員の週間スケジュールをデジタルで管理するための機能である。
従来のホワイトボード運用を置き換え、リアルタイムな情報共有を実現する。

**スコープ:**
- 対象: 週間スケジュールの CRUD 操作
- 対象外: 月間/年間ビュー、外部カレンダー連携
```

---

### 2. ユーザーストーリー (User Stories)

**形式:**
```markdown
### US-001: [ストーリータイトル]
**As a** [役割]
**I want** [機能]
**So that** [価値]

**受入条件:**
- [ ] AC-001: [条件1]
- [ ] AC-002: [条件2]
```

**例:**
```markdown
### US-001: スケジュール登録
**As a** 現場リーダー
**I want** 部下のスケジュールを登録できる
**So that** 週間の作業計画を事前に共有できる

**受入条件:**
- [ ] AC-001: 日付、時間、現場名を入力できる
- [ ] AC-002: 登録後、サイネージにリアルタイム反映される
- [ ] AC-003: 同一時間帯の重複はエラーになる
```

---

### 3. 画面仕様 (UI Specification)

**必須項目:**
- 画面レイアウト（Mermaid/ASCII図）
- コンポーネントツリー
- 状態一覧（loading, error, empty, data）
- インタラクション（クリック、入力、遷移）

**例:**
```markdown
## 3. 画面仕様

### 3.1 レイアウト
┌─────────────────────────────┐
│ [Header]                    │
├─────────────────────────────┤
│ [週選択] ◀ 2/3〜2/9 ▶       │
├─────────────────────────────┤
│ 月 火 水 木 金 土 日        │
│ ┌──┐┌──┐┌──┐┌──┐...        │
│ │予│││予│││  │...         │
│ └──┘└──┘└──┘└──┘...        │
├─────────────────────────────┤
│ [+ 新規登録]                │
└─────────────────────────────┘

### 3.2 状態
| 状態 | 表示内容 |
|------|----------|
| loading | スケルトンUI |
| error | エラーメッセージ + 再試行ボタン |
| empty | 「スケジュールがありません」 |
| data | スケジュール一覧 |
```

---

### 4. API仕様 (API Specification)

**必須項目:**
- HTTPメソッド、パス
- リクエストヘッダー/ボディ
- レスポンス形式
- エラーレスポンス

**例:**
```markdown
## 4. API仕様

### POST /api/schedules

**リクエスト:**
```json
{
  "userId": "uuid",
  "date": "2026-02-05",
  "startTime": "09:00",
  "endTime": "17:00",
  "genbaName": "現場A"
}
```

**レスポンス (201):**
```json
{
  "id": "uuid",
  "createdAt": "2026-02-05T10:00:00Z"
}
```

**エラー:**
| コード | 条件 |
|--------|------|
| 400 | バリデーションエラー |
| 401 | 未認証 |
| 403 | 権限不足 |
| 409 | 時間帯重複 |
```

---

### 5. データモデル (Data Model)

**必須項目:**
- エンティティ名
- フィールド定義（型、制約）
- リレーション

**例:**
```markdown
## 5. データモデル

### Schedule エンティティ

| フィールド | 型 | 制約 | 説明 |
|-----------|-----|------|------|
| id | UUID | PK | 主キー |
| userId | UUID | FK → User | 担当者 |
| organizationId | UUID | FK | テナントID |
| date | Date | NOT NULL | 日付 |
| startTime | Time | NOT NULL | 開始時刻 |
| endTime | Time | NOT NULL | 終了時刻 |
| genbaName | String | NOT NULL | 現場名 |

**制約:**
- startTime < endTime
- 同一 userId/date で時間帯重複禁止
```

---

### 6. ビジネスロジック (Business Logic)

**必須項目:**
- 処理フロー（シーケンス図推奨）
- 計算ルール
- バリデーションルール

---

### 7. エラーハンドリング (Error Handling)

**必須項目:**
- エラーケース一覧
- ユーザー向けメッセージ
- 技術的対応

---

### 8. セキュリティ (Security)

**必須項目:**
- 認証要件（requireAuth 等）
- 認可ルール（ロール別アクセス）
- データ保護（organizationId スコープ）

---

### 9. パフォーマンス (Performance)

**必須項目:**
- 応答時間目標（例: 200ms以内）
- N+1 クエリ対策
- インデックス設計

---

### 10. テストケース (Test Cases)

**形式:**
```markdown
### TC-001: [テスト名]
- **前提条件:** ...
- **操作:** ...
- **期待結果:** ...
- **優先度:** P0 | P1 | P2
```

---

### 11. 実装メモ (Implementation Notes)

**内容:**
- 使用するライブラリ
- 既存コードとの統合ポイント
- マイグレーション手順

---

### 12. 未決事項 (Open Issues)

**形式:**
```markdown
| ID | 内容 | ステータス | 期限 |
|----|------|-----------|------|
| OI-001 | 祝日の扱い | TBD | 2026-02-15 |
```

---

## 止まらないルール適用

DETAIL層では以下のルールが適用される：

| セクション | TBD許容 | 備考 |
|-----------|---------|------|
| 1. 概要 | × | 必須 |
| 2. ユーザーストーリー | × | 受入条件は必須 |
| 3. 画面仕様 | △ | 主要UIは必須、細部はTBD可 |
| 4. API仕様 | × | エンドポイントは必須 |
| 5. データモデル | × | スキーマは必須 |
| 6. ビジネスロジック | △ | 主要フローは必須 |
| 7. エラーハンドリング | ○ | 実装時に追加可 |
| 8. セキュリティ | △ | 認証/認可は必須 |
| 9. パフォーマンス | ○ | 実装後に計測 |
| 10. テストケース | △ | P0は必須、P1/P2は後回し可 |
| 11. 実装メモ | ○ | 実装時に追記 |
| 12. 未決事項 | ○ | ここに集約 |

---

## テンプレート

新規機能仕様を作成する際は以下のテンプレートを使用：

```markdown
# [機能名] [DETAIL]

> 機能ID: FEAT-XXX
> ステータス: Draft
> 最終更新: YYYY-MM-DD
> 関連: SSOT-1 #XXX

---

## 1. 概要

[機能の目的と背景を記載]

---

## 2. ユーザーストーリー

### US-001: [ストーリータイトル]
**As a** [役割]
**I want** [機能]
**So that** [価値]

**受入条件:**
- [ ] AC-001: [条件]

---

## 3. 画面仕様

TBD

---

## 4. API仕様

TBD

---

## 5. データモデル

TBD

---

## 6. ビジネスロジック

TBD

---

## 7. エラーハンドリング

TBD

---

## 8. セキュリティ

- 認証: requireAuth() 必須
- 認可: [ロール要件]
- スコープ: organizationId 必須

---

## 9. パフォーマンス

TBD

---

## 10. テストケース

TBD

---

## 11. 実装メモ

TBD

---

## 12. 未決事項

| ID | 内容 | ステータス | 期限 |
|----|------|-----------|------|
```

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|----------|
| 2026-02-05 | 3.0 | WBS プロジェクトへ導入 |

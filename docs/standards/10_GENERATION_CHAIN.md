# 10_GENERATION_CHAIN.md - 仕様書生成チェーン

> ディスカバリーの回答から開発開始まで、AIが段階的にドキュメントを生成するプロセス

---

## このドキュメントの目的

```
問題:
  テンプレートは50以上ある。でも空っぽの箱。
  AIに「全部埋めて」と言っても品質が出ない。

解決:
  ドキュメントを正しい順序で、1つずつ、
  前のドキュメントをインプットにして生成する。
  各ステップでユーザーが確認・修正してから次へ進む。
```

---

## 全体像

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  Step 0         Step 1          Step 2          Step 3         Step 4
  ──────        ──────         ──────         ──────        ──────
  Discovery     Business        Product         Technical      Ready
  (対話)         (事業設計)      (プロダクト設計)  (技術設計)     (開発開始)

  アイデアを  →  誰に何を    →  何をどう    →  どう作るか →  開発開始
  引き出す      なぜ売るか      作るか        を決める

  [Claude.ai]   [Claude.ai]    [Claude.ai     [Claude Code]  [Claude Code]
                               + Claude Code]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

 生成する資料:

  Step 0         Step 1           Step 2           Step 3        Step 4
  ────────      ────────        ────────         ────────     ────────
  (対話記録)     IDEA_CANVAS      PRD              API_CONTRACT  CLAUDE.md
                USER_PERSONA     FEATURE_CATALOG   DATA_MODEL
                COMPETITOR       UI_STATE          CROSS_CUTTING プロジェクト
                VALUE_PROP       (機能仕様書)      TECH_STACK    初期化
                                                   各種規約

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## ゲート条件（各 Step の完了条件）

```
■ LLM がステップを飛ばす問題への対策

  LLM は「効率化」のつもりで以下をやりがち:
  - 複数ドキュメントを一括生成
  - ヒアリングを省略して推測で埋める
  - 確認を取らずに次の Step に進む

  これを防ぐため、各 Step にゲート条件を設定する。
  ゲート条件を満たさない限り、次の Step に進んではならない。
```

### Gate 0→1: Discovery 完了ゲート

```
完了条件:
  □ Stage 1-5（タイプによりスキップあり）が全て実施済み
  □ 各Stage の回答がテキストとして記録されている
  □ ユーザーが「Discovery 完了」と承認している

代替条件（既存資料がある場合）:
  □ 既存資料が読み込まれ、カテゴリ分類表が作成済み
  □ 不足情報が特定され、ヒアリングで補完済み
  □ ユーザーが「資料確認完了」と承認している
```

### Gate 1→2: Business 完了ゲート

```
完了条件（全て必須）:
  □ docs/idea/IDEA_CANVAS.md が存在し、[要確認] がゼロ
  □ docs/idea/USER_PERSONA.md が存在し、[要確認] がゼロ
  □ docs/idea/COMPETITOR_ANALYSIS.md が存在し、[要確認] がゼロ
  □ docs/idea/VALUE_PROPOSITION.md が存在し、[要確認] がゼロ
  □ 各ドキュメントがユーザー承認済み

生成ルール:
  - 1ドキュメントずつ生成 → 表示 → 確認 → 次へ
  - 前のドキュメントをインプットにして次を生成
  - 4ドキュメント同時生成は禁止
```

### Gate 2→3: Product 完了ゲート

```
完了条件（全て必須）:
  □ docs/requirements/SSOT-0_PRD.md が存在し、ユーザー承認済み
  □ docs/requirements/SSOT-1_FEATURE_CATALOG.md が存在し、P0リスト承認済み
  □ P0 機能の全 SSOT が docs/design/features/ に存在
  □ 各 SSOT が Freeze 2（CONTRACT層）まで確定
  □ 各 SSOT がユーザー承認済み

生成ルール:
  - PRD → FEATURE_CATALOG → 各機能SSOT の順で生成
  - 各機能 SSOT は 11_FEATURE_SPEC_FLOW.md に従いヒアリングを実施
  - ヒアリングは1問ずつ。5問まとめて聞くのは禁止
  - 1機能のSSOT完成 → ユーザー承認 → 次の機能へ

最重要:
  P0機能の詳細ヒアリング（11_FEATURE_SPEC_FLOW.md）を
  スキップして一括生成することは絶対に禁止。
  ヒアリングなしの機能仕様書は手戻りの最大原因。
```

### Gate 3→4: Technical 完了ゲート

```
完了条件（全て必須）:
  □ docs/standards/TECH_STACK.md が存在し、ユーザー承認済み
  □ docs/design/core/SSOT-3_API_CONTRACT.md が存在し、ユーザー承認済み
  □ docs/design/core/SSOT-4_DATA_MODEL.md が存在し、ユーザー承認済み
  □ docs/design/core/SSOT-5_CROSS_CUTTING.md が存在し、ユーザー承認済み
  □ CLAUDE.md の {{}} が全て確定値で埋まっている

生成ルール:
  - 1ドキュメントずつ生成 → 表示 → 確認 → 次へ
  - TECH_STACK は選択肢を提示してユーザーが選ぶ
```

## Freeze 単位の進行

### 基本概念

```
従来: 全セクション（§1-§12）を埋めないと次に進めない
問題: 不確定な詳細に時間をかけ、開発が始められない

改善: Freeze単位で段階的に確定し、確定した層から実装を開始できる

  Freeze 1 → Freeze 2 → Freeze 3 → Freeze 4
  Domain     Contract    Exception   Non-functional
  (CORE層)   (CONTRACT層) (DETAIL層)  (DETAIL層)
```

### Freeze 定義

```
Freeze 1: Domain / Scope（用語・対象・境界）
────────────────────────────────────────────
  確定対象:
  - §2.1 目的
  - §2.2 スコープ（含む/含まない）
  - §2.3 ユーザーストーリー
  - §2.4 主要ユーザーフロー
  - 用語定義
  - 権限モデル（誰が何をできるか）

  完了条件:
  □ 「この機能が何をするか」が1文で説明できる
  □ スコープの境界が明確（含まない物が列挙されている）
  □ ユーザーストーリーが具体的
  □ ユーザーが「これで合っている」と確認

  次に進める条件:
  → Freeze 1 完了で Step 2-B（FEATURE_CATALOG）に進める
  → 実装はまだ不可


Freeze 2: UI / API / Event（画面・入出力の契約）
────────────────────────────────────────────
  確定対象:
  - §4.1 データ項目一覧（主要テーブル）
  - §5 API仕様（エンドポイント、型）
  - §6.1 画面一覧
  - §6.4 状態遷移図
  - §3 機能要件（MUST要件）
  - §3-H 受け入れテスト（Gherkin）

  完了条件:
  □ API契約が型レベルで定義済み
  □ 画面遷移が定義済み
  □ 全MUST要件にテストケースが存在
  □ 受け入れテストがGherkin形式で記述済み

  次に進める条件:
  → Freeze 2 完了で DB/API/UI の実装を開始可能
  → DETAIL層（エラー文言等）は未確定でも可


Freeze 3: Error / Permission / Log（例外・権限・監査）
────────────────────────────────────────────
  確定対象:
  - §7 ビジネスルール（例外ルール含む）
  - §9 エラーハンドリング（全ケース）
  - §3-E 入出力例（5ケース以上）
  - §3-F 境界値
  - §3-G 例外時の戻り
  - §4.2 バリデーションルール

  完了条件:
  □ 全例外ケースが列挙されている
  □ 各例外にエラーコード・メッセージが定義
  □ 境界値が全項目で定義
  □ バリデーションルールが具体的

  次に進める条件:
  → Freeze 3 完了でテスト・監査を実行可能


Freeze 4: Non-functional（性能・運用・セキュリティ）
────────────────────────────────────────────
  確定対象:
  - §8 非機能要件（性能、セキュリティ、可用性、保守性）
  - §11 依存関係・影響範囲
  - §4.3 データライフサイクル
  - UI文言の最終確定

  完了条件:
  □ 性能目標が数値で定義
  □ セキュリティ要件が具体的
  □ 依存関係が全て明示
  □ SSOT監査（13_SSOT_AUDIT.md）で95点合格

  次に進める条件:
  → Freeze 4 完了でリリース準備可能
```

### Freeze と生成チェーンの対応

```
Step 0: Discovery
  ↓
Step 1: Business
  ↓
Step 2: Product
  ├── Freeze 1（Domain/Scope）← ここまでで機能の輪郭が確定
  ├── Freeze 2（UI/API/Event）← ここで契約が確定、実装開始可能
  ↓
Step 3: Technical
  ├── Freeze 3（Error/Permission/Log）← テスト・監査が実行可能に
  ├── Freeze 4（Non-functional）← リリース準備完了
  ↓
Step 4: 開発開始

重要:
  Freeze 2 完了時点で実装を開始してよい。
  Freeze 3, 4 は実装と並行して進められる。
  ただし Freeze 3 未完了の機能はリリース不可。
```

### Freeze 状態の表示

```
各SSOTの冒頭にFreeze状態を表示する:

> Freeze 状態:
> ■■□□ Freeze 1: Domain ✅ | Freeze 2: Contract ✅ | Freeze 3: Exception ⬜ | Freeze 4: NFR ⬜
> 実装可能: Yes（Freeze 2 完了）

ステータス記号:
  ✅ = 完了（Frozen）
  🔄 = 進行中
  ⬜ = 未着手
```

---

## Step 0: ディスカバリー

> 詳細: 08_DISCOVERY_FLOW.md

| 項目 | 内容 |
|------|------|
| ツール | Claude.ai |
| 時間 | 30-60分 |
| インプット | ユーザーの「こんなの作りたい」+ 知識データ（存在する場合） |
| アウトプット | Stage 1-5 の回答記録 + 全体サマリー |

**事前確認**: docs/knowledge/ が存在する場合、関連する知識データを読み込んでからヒアリングを開始（08_DISCOVERY_FLOW.md Stage 0 参照）

**完了条件**: 全体サマリーをユーザーが確認し「OK」と言った

**次のStepへ渡すもの**: 全体サマリー（テキスト）+ 知識データサマリー

---

## Step 1: Business（事業設計）

### 目的
「誰に、何を、なぜ売るのか」を確定させる

### 生成順序と依存関係

```
1-A. IDEA_CANVAS ←── Discovery回答の全体 + knowledge/
       │
       ├──→ 1-B. USER_PERSONA ←── Q2-1, Q2-2 + knowledge/users/
       │
       ├──→ 1-C. COMPETITOR_ANALYSIS ←── Q1-4, Q4-1 + knowledge/market/
       │
       └──→ 1-D. VALUE_PROPOSITION ←── 1-A + 1-B + 1-C + knowledge/domain/

知識データ参照:
  1-A: knowledge/ 全体を参照（背景知識として）
  1-B: knowledge/users/personas.md, pain-points.md を参照
  1-C: knowledge/market/competitors.md, trends.md を参照
  1-D: knowledge/domain/best-practices.md, common-features.md を参照
```

### 1-A. IDEA_CANVAS の生成

| 項目 | 内容 |
|------|------|
| ツール | Claude.ai |
| インプット | Step 0 の全体サマリー |
| テンプレート | templates/idea/IDEA_CANVAS.md |
| 目標完成度 | 90% |

**AIへの指示**:
```
以下のアイデアサマリーをもとに、
IDEA_CANVAS.md を作成してください。

テンプレート: [IDEA_CANVAS.md のテンプレート内容]

アイデアサマリー:
[Step 0 の全体サマリー]

以下のセクションを埋めてください:
- §1 Elevator Pitch
- §2 課題（Discovery Q2-1〜Q2-6 の回答から）
- §3 ソリューション（Q3-1〜Q3-4 から）
- §4 ターゲットユーザー（Q2-1 から）
- §5 差別化（Q4-2 から）
- §6 ビジネスモデル（Q5-1, Q5-2 から）
- §7 市場規模（わかる範囲で。不明なら「要調査」と記載）
- §9 成功の定義（Q5-3 から）

§8 リスクと前提は、あなた（AI）が内容を分析して
懸念点を3-5個提案してください。
```

**完了条件**:
- [ ] Elevator Pitch が1-2文で明確
- [ ] 課題が具体的なシーンで記述されている
- [ ] MVP機能が3-5個に絞られている
- [ ] ビジネスモデルが記載されている
- [ ] ユーザーが内容を確認し「OK」と言った

---

### 1-B. USER_PERSONA の生成

| 項目 | 内容 |
|------|------|
| ツール | Claude.ai |
| インプット | 1-A（完成版IDEA_CANVAS）+ Discovery Q2回答 |
| テンプレート | templates/idea/USER_PERSONA.md |
| 目標完成度 | 70% |

**AIへの指示**:
```
以下のIDEA_CANVASをもとに、
ターゲットユーザーのペルソナを作成してください。

IDEA_CANVAS: [1-Aの完成版]

テンプレート: [USER_PERSONA.md のテンプレート内容]

以下を作成してください:
- プライマリペルソナ 1名（詳細に）
- セカンダリペルソナ 1名（概要レベル）
- アンチペルソナ 1名

プライマリペルソナは特に以下を具体的に:
- 基本プロフィール（名前、年齢、職業まで設定）
- 課題（Pains）を5つ以上
- 購買行動（意思決定基準、予算感）
- マーケティングへの示唆（響くメッセージ、リーチ方法）
```

**完了条件**:
- [ ] プライマリペルソナが「実在しそう」と感じるレベルの具体性
- [ ] 課題が IDEA_CANVAS と整合している
- [ ] マーケティングへの示唆が記載されている
- [ ] ユーザーが「このペルソナは実際のターゲットに近い」と確認

---

### 1-C. COMPETITOR_ANALYSIS の生成

| 項目 | 内容 |
|------|------|
| ツール | Claude.ai（Web検索あり推奨） |
| インプット | 1-A + Discovery Q1-4, Q4-1, Q4-2 |
| テンプレート | templates/idea/COMPETITOR_ANALYSIS.md |
| 目標完成度 | 60% |

**AIへの指示**:
```
以下のIDEA_CANVASをもとに、競合分析を行ってください。

IDEA_CANVAS: [1-Aの完成版]
ユーザーが挙げた参考サービス: [Q1-4の回答]
ユーザーが挙げた競合: [Q4-1の回答]

テンプレート: [COMPETITOR_ANALYSIS.md のテンプレート内容]

以下を作成してください:
- 直接競合 2-3社の詳細分析
- 間接競合/代替手段 2-3つ
- 機能比較マトリクス
- 差別化ポイントの整理
- ポジショニングマップ（価格×機能の2軸）

※ わからない情報は「要調査」と記載してください。
   推測で埋めないでください。
```

**完了条件**:
- [ ] 直接競合が2社以上分析されている
- [ ] 機能比較マトリクスがある
- [ ] 差別化ポイントが明確
- [ ] ユーザーが追加の競合がないか確認

---

### 1-D. VALUE_PROPOSITION の生成

| 項目 | 内容 |
|------|------|
| ツール | Claude.ai |
| インプット | 1-A + 1-B + 1-C（全て完成版） |
| テンプレート | templates/idea/VALUE_PROPOSITION.md |
| 目標完成度 | 80% |

**AIへの指示**:
```
以下の3つのドキュメントをもとに、
価値提案キャンバスを作成してください。

IDEA_CANVAS: [1-A]
USER_PERSONA: [1-B]
COMPETITOR_ANALYSIS: [1-C]

テンプレート: [VALUE_PROPOSITION.md のテンプレート内容]

特に以下を重点的に:
- Customer Profile: ペルソナの課題と利得を正確に反映
- Value Map: 機能が課題をどう解消するか1対1で対応
- フィット分析: 課題と解決策のフィット度を評価
- 価値提案ステートメント: 1文で表現

競合分析の結果を踏まえて、
競合にはない独自の価値を明確にしてください。
```

**完了条件**:
- [ ] 価値提案ステートメントが1文で明確
- [ ] Pains と Pain Relievers が1対1で対応
- [ ] フィットスコアが算出されている
- [ ] ユーザーが「これがうちの価値だ」と納得

### Step 1 全体の完了条件

```
┌─ Step 1 完了判定 ──────────────────────────────┐
│                                                  │
│ □ IDEA_CANVAS: 90%完成、ユーザー確認済み        │
│ □ USER_PERSONA: 70%完成、ユーザー確認済み       │
│ □ COMPETITOR_ANALYSIS: 60%完成                  │
│ □ VALUE_PROPOSITION: 80%完成、ユーザー確認済み   │
│                                                  │
│ □ 価値提案ステートメントが明確                   │
│ □ Go/No-Go判断:                                 │
│   ・課題は実在するか？ → Yes                    │
│   ・解決策は妥当か？ → Yes                      │
│   ・差別化できるか？ → Yes                      │
│   ・ビジネスとして成立するか？ → Yes            │
│                                                  │
│ → 全て Yes なら Step 2 へ進む                    │
│ → 1つでも No なら、該当箇所を再検討             │
└──────────────────────────────────────────────────┘
```

---

## Step 2: Product（プロダクト設計）

### 目的
「何を、どう作るか」を確定させる

### 生成順序と依存関係

```
2-A. PRD（SSOT-0）←── Step 1 全資料
       │
       ├──→ 2-B. FEATURE_CATALOG（SSOT-1）
       │          │
       │          ├──→ 2-C. UI_STATE（SSOT-2）
       │          │
       │          └──→ 2-D. 機能仕様書（共通機能）
       │
       └──→ 2-E. マーケティング資料（LP_SPEC等）
             ※ マーケ意向ありの場合のみ
```

### 2-A. PRD の生成

| 項目 | 内容 |
|------|------|
| ツール | Claude.ai |
| インプット | Step 1 の全資料 |
| テンプレート | ssot/SSOT-0_PRD.md |
| 目標完成度 | 90% |

**AIへの指示**:
```
以下の事業設計資料をもとに、
プロダクト要件定義書（PRD）を作成してください。

IDEA_CANVAS: [1-A]
USER_PERSONA: [1-B]
COMPETITOR_ANALYSIS: [1-C]
VALUE_PROPOSITION: [1-D]

テンプレート: [SSOT-0_PRD.md のテンプレート内容]

以下を決定してください:
1. プロダクトビジョン（1文）
2. 解決する課題（VALUE_PROPOSITIONから）
3. ターゲットユーザー（PERSONAから）
4. MVP機能リスト（P0: 必須、P1: 次期、P2: 将来）
5. 成功指標（定量的なKPI）
6. スコープ外（明示的にやらないこと）
7. 前提条件と制約

MVP機能は IDEA_CANVAS の §3 を基に、
3-5個に厳選してください。
多すぎる場合は「本当にMVPに必要か？」を
基準に絞ってください。
```

**完了条件**:
- [ ] MVP機能が3-5個に絞られている
- [ ] 各機能の「なぜMVPに必要か」が説明されている
- [ ] 成功指標が定量的（数字）で定義されている
- [ ] スコープ外が明示されている
- [ ] ユーザーが全項目を確認

---

### 2-B. FEATURE_CATALOG の生成

| 項目 | 内容 |
|------|------|
| ツール | Claude.ai → Claude Code（ファイル生成） |
| インプット | 2-A（完成版PRD） |
| テンプレート | ssot/SSOT-1_FEATURE_CATALOG.md |
| 目標完成度 | 90% |

**AIへの指示**:
```
以下のPRDをもとに、機能カタログを作成してください。

PRD: [2-A]

テンプレート: [SSOT-1_FEATURE_CATALOG.md のテンプレート内容]

PRDのMVP機能リストを、以下の形式で
機能カタログに展開してください:

各機能について:
- 機能ID（例: AUTH-001, DASH-001）
- 機能名
- 概要（1-2文）
- 優先度（P0/P1/P2）
- 種別（共通機能 / 固有機能）
- 依存関係（他のどの機能に依存するか）
- 推定規模（S/M/L）

共通機能の判定基準:
1. 他プロジェクトでも使うか？
2. 業界標準のパターンがあるか？
3. 独自のビジネスロジックが少ないか？
4. 外部ライブラリで実現可能か？
→ 3つ以上 Yes なら共通機能
```

**完了条件**:
- [ ] 全MVP機能がIDを持っている
- [ ] 共通/固有の分類が完了
- [ ] 依存関係が整理されている
- [ ] 実装順序（依存関係ベース）が決まっている

---

### 2-C. UI_STATE の生成

| 項目 | 内容 |
|------|------|
| ツール | Claude.ai |
| インプット | 2-A + 2-B + Discovery Q3-4（ユーザーフロー） |
| テンプレート | core/SSOT-2_UI_STATE.md |
| 目標完成度 | 80% |

**AIへの指示**:
```
以下のPRDと機能カタログをもとに、
画面一覧と状態遷移を定義してください。

PRD: [2-A]
FEATURE_CATALOG: [2-B]
ユーザーフロー: [Discovery Q3-4の回答]

テンプレート: [SSOT-2_UI_STATE.md のテンプレート内容]

以下を作成してください:
1. 画面一覧（全画面のリスト）
2. 画面遷移図（Mermaid形式）
3. 各画面の主要要素と状態
4. グローバルな状態管理（認証状態等）

ユーザーが「登録→初回利用→価値体験」に
到達するまでのフローを最短にしてください。
```

**完了条件**:
- [ ] 全画面がリストアップされている
- [ ] 画面遷移図がMermaidで描かれている
- [ ] 各画面の主要要素が定義されている
- [ ] ユーザーフローが自然

---

### 2-D. 機能仕様書の生成（★ 各機能ごとにAIがヒアリング）

| 項目 | 内容 |
|------|------|
| ツール | **Claude.ai**（ヒアリング）→ **Claude Code**（ファイル生成） |
| インプット | 2-A + 2-B + 2-C + ユーザーとの対話 |
| テンプレート | common-features/ or project-features/_TEMPLATE.md |
| 参照 | **11_FEATURE_SPEC_FLOW.md**（機能別詳細ヒアリングフロー） |
| 目標完成度 | 90%（AIの想像ではなく、ユーザー確認済みの仕様） |

**重要: このステップはAIが一括生成するのではなく、各機能ごとにユーザーとの対話でSSOTを確定させる。**

**手順**:
```
機能カタログのP0機能を実装順に並べる
    ↓
各機能について 11_FEATURE_SPEC_FLOW.md に従い:
    ↓
  Phase 1: 共通質問（目的、利用シーン、MVPスコープ）
    ↓
  Phase 2: 種別質問（認証系/CRUD系/表示系/... に応じた質問）
    ↓
  Phase 3: UI確認（ワイヤーフレーム提示→確認）
    ↓
  Phase 4: 仕様確定（全項目サマリー→ユーザー最終確認）
    ↓
  Phase 5: SSOT生成
    - 機能仕様書（新規作成）
    - SSOT-2 UI定義（追記）
    - SSOT-3 API定義（追記）
    - SSOT-4 DB定義（追記）
    - テストケース
    ↓
  次の機能へ
```

**Claude.ai への指示（各機能ごとに）**:
```
機能カタログの [機能ID: 機能名] について、
11_FEATURE_SPEC_FLOW.md に従って
詳細をヒアリングしてください。

この機能は [種別: 認証系/CRUD系/表示系/...] です。
対応する種別質問セットを使ってください。

機能カタログ:
[SSOT-1 の該当部分]

PRD:
[SSOT-0 の関連部分]
```

**完了条件（各機能ごと）**:
- [ ] ユーザーストーリーが明確
- [ ] ビジネスルールが全て列挙されている
- [ ] UI構成をユーザーが確認済み
- [ ] データ項目と権限が確定
- [ ] テストケースがある
- [ ] ユーザーが仕様サマリーを「OK」と確認

### 2-E. マーケティング資料の生成（マーケ意向ありの場合）

| 項目 | 内容 |
|------|------|
| ツール | Claude.ai |
| インプット | Step 1 全資料 + 2-A |
| テンプレート | templates/marketing/ |
| 目標完成度 | 60% |

**AIへの指示**:
```
以下の資料をもとに、LP設計書を作成してください。

IDEA_CANVAS: [1-A]
USER_PERSONA: [1-B]
VALUE_PROPOSITION: [1-D]
PRD: [2-A]

テンプレート: [LP_SPEC.md のテンプレート内容]

07_MARKETING_FRAMEWORK.md の原則に従ってください:
- PASONA構成でセクションを設計
- 感情トリガーを各セクションに配置
- USPをヘッドラインに反映
- リスクリバーサルを設計
- CTAは具体的に

ペルソナの「響くメッセージ」と「リーチ方法」を
反映してください。
```

### Step 2 全体の完了条件

```
┌─ Step 2 完了判定 ──────────────────────────────┐
│                                                  │
│ □ PRD: 90%完成、ユーザー確認済み                │
│ □ FEATURE_CATALOG: 全機能ID付き                 │
│ □ UI_STATE: 画面一覧と遷移図あり               │
│ □ 機能仕様書: 全MVP機能分が生成済み             │
│ □ （任意）LP_SPEC: 構成とコピー案あり           │
│                                                  │
│ □ 「何を作るか」が誰が読んでも明確              │
│                                                  │
│ → Step 3 へ進む                                  │
└──────────────────────────────────────────────────┘
```

---

## Step 3: Technical（技術設計）

### 目的
「どう作るか」を確定させ、開発を開始できる状態にする

### 生成順序と依存関係

```
3-A. TECH_STACK ←── Q5-5, Q5-6（技術スキル・希望）
       │
       ├──→ 3-B. API_CONTRACT（SSOT-3）←── 2-D（機能仕様書）
       │
       ├──→ 3-C. DATA_MODEL（SSOT-4）←── 2-D + 3-B
       │
       ├──→ 3-D. CROSS_CUTTING（SSOT-5）←── 3-A + 3-B
       │
       └──→ 3-E. 開発規約一式 ←── 3-A
                   │
                   ├── CODING_STANDARDS
                   ├── GIT_WORKFLOW
                   ├── TESTING_STANDARDS
                   └── DEV_ENVIRONMENT

3-F. プロジェクト初期構築 ←── 3-A〜3-E 全て
       │
       ├── CLAUDE.md 生成
       └── スキャフォールド実行
```

### 3-A. TECH_STACK の生成

| 項目 | 内容 |
|------|------|
| ツール | Claude.ai |
| インプット | Discovery Q5-5, Q5-6 + PRD |
| テンプレート | templates/TECH_STACK.md |
| 目標完成度 | 95% |

**AIへの指示**:
```
以下の情報をもとに、技術スタックを決定してください。

PRD: [2-A]
技術スキル: [Q5-5の回答]
希望技術: [Q5-6の回答]
タイムライン: [Q5-7の回答]
プラットフォーム: [Q3-5の回答]

テンプレート: [TECH_STACK.md のテンプレート内容]

以下の基準で推奨してください:
- 開発者のスキルレベルに適合
- MVPを最短で作れる
- AIコーディング支援と相性がよい（ドキュメントが豊富）
- スケール可能
- コスト効率がよい

スキルレベル別の推奨:
- プロ: 希望を尊重
- 中級: Next.js + Supabase + Vercel
- 初級: 同上 + AI補助前提
- なし: ノーコード or AI全面活用

各技術の選定理由も記載してください。
```

**完了条件**:
- [ ] フレームワーク、言語、DB、認証、ホスティング、CSS、テストが全て決定
- [ ] 各選定に理由がある
- [ ] ユーザーが合意

---

### 3-B. API_CONTRACT の生成

| 項目 | 内容 |
|------|------|
| ツール | Claude Code |
| インプット | 2-D（全機能仕様書） + 3-A |
| テンプレート | core/SSOT-3_API_CONTRACT.md |
| 目標完成度 | 85% |

**Claude Code への指示**:
```bash
claude "以下のドキュメントを全て読んで、
       API規約を作成して。

       docs/requirements/SSOT-0_PRD.md
       docs/requirements/SSOT-1_FEATURE_CATALOG.md
       docs/design/features/ 以下の全仕様書
       docs/standards/TECH_STACK.md

       docs/design/core/SSOT-3_API_CONTRACT.md に出力。

       以下を含める:
       - 全エンドポイント一覧
       - 各エンドポイントのリクエスト/レスポンス型
       - 認証要件
       - エラーレスポンス形式
       - ページネーション規約
       - レートリミット方針

       各機能仕様書の「APIエンドポイント（仮）」を
       正式なAPI設計に昇格させて。"
```

---

### 3-C. DATA_MODEL の生成

| 項目 | 内容 |
|------|------|
| ツール | Claude Code |
| インプット | 2-D + 3-B |
| テンプレート | core/SSOT-4_DATA_MODEL.md |
| 目標完成度 | 85% |

**Claude Code への指示**:
```bash
claude "以下のドキュメントを全て読んで、
       データモデルを設計して。

       docs/design/core/SSOT-3_API_CONTRACT.md
       docs/design/features/ 以下の全仕様書

       docs/design/core/SSOT-4_DATA_MODEL.md に出力。

       以下を含める:
       - 全テーブル定義（カラム、型、制約）
       - ER図（Mermaid形式）
       - インデックス設計
       - マイグレーション方針

       各機能仕様書の「データモデル（仮）」を
       正式なDB設計に昇格させて。"
```

---

### 3-D. CROSS_CUTTING の生成

| 項目 | 内容 |
|------|------|
| ツール | Claude Code |
| インプット | 3-A + 3-B |
| テンプレート | core/SSOT-5_CROSS_CUTTING.md |
| 目標完成度 | 85% |

**Claude Code への指示**:
```bash
claude "以下のドキュメントを読んで、
       横断的関心事を定義して。

       docs/standards/TECH_STACK.md
       docs/design/core/SSOT-3_API_CONTRACT.md

       docs/design/core/SSOT-5_CROSS_CUTTING.md に出力。

       以下を含める:
       - 認証・認可（セッション管理、JWT/Cookie等）
       - エラーハンドリング（フロント/バック統一）
       - ログ設計（レベル、フォーマット、出力先）
       - バリデーション規約
       - セキュリティ（CORS、CSP、入力サニタイズ）
       
       技術スタックに適合した具体的な実装方針にして。"
```

---

### 3-E. 開発規約一式の生成

| 項目 | 内容 |
|------|------|
| ツール | Claude Code（一括生成） |
| インプット | 3-A |
| テンプレート | templates/ 以下の各規約 |
| 目標完成度 | 90% |

**Claude Code への指示**:
```bash
claude "docs/standards/TECH_STACK.md を読んで、
       以下の規約を技術スタックに合わせて生成して:

       1. docs/standards/CODING_STANDARDS.md
       2. docs/standards/GIT_WORKFLOW.md
       3. docs/standards/TESTING_STANDARDS.md
       4. docs/standards/DEV_ENVIRONMENT.md

       テンプレート: templates/ 以下の対応ファイル

       Next.jsならNext.js固有のルール、
       Supabaseならsupabase-js固有のパターンを
       反映して。"
```

---

### 3-F. プロジェクト初期構築

| 項目 | 内容 |
|------|------|
| ツール | Claude Code |
| インプット | 3-A〜3-E（全て完成） |
| 実行物 | setup-project.sh + カスタマイズ |

**Claude Code への指示**:
```bash
claude "以下を実行して:

       1. docs/standards/TECH_STACK.md に基づいて
          プロジェクトを初期化（npm init, etc.）
       
       2. templates/project/CLAUDE.md をプロジェクトルートにコピーし、
          {{}} を実際の値で置換

       3. docs/standards/DEV_ENVIRONMENT.md に基づいて
          開発環境を設定（ESLint, Prettier, etc.）
       
       4. docs/design/core/SSOT-4_DATA_MODEL.md に基づいて
          DBマイグレーションファイルを生成
       
       5. 基本的なディレクトリ構造を作成"
```

### Step 3 全体の完了条件

```
┌─ Step 3 完了判定 ──────────────────────────────┐
│                                                  │
│ □ TECH_STACK: 全技術が決定、理由付き            │
│ □ API_CONTRACT: 全エンドポイント定義済み        │
│ □ DATA_MODEL: 全テーブル定義 + ER図            │
│ □ CROSS_CUTTING: 認証・エラー・ログ定義済み    │
│ □ 開発規約4点: 技術スタックに適合済み           │
│ □ CLAUDE.md: {{}} が全て実際の値に置換済み     │
│ □ プロジェクトが npm run dev で起動する         │
│                                                  │
│ → Step 4（開発開始）へ進む 🚀                    │
└──────────────────────────────────────────────────┘
```

---

## Step 4: 開発開始

### 4.1 最初に実装する機能の決定

```
機能カタログの依存関係グラフから、
依存がない（または最も少ない）P0機能を最初に実装する。

一般的な順序:
1. 認証（AUTH）← ほぼ全機能が依存
2. ユーザー管理（ACCT）
3. メイン機能（プロダクト固有のP0機能）
4. ダッシュボード / 管理画面
```

### 4.2 開発サイクル

```
各機能の実装サイクル:

[Claude Code] 実装
  claude "AUTH-001の仕様書に基づいて実装して"
    ↓
[Claude Code] テスト生成
  claude "AUTH-001のテストを生成して"
    ↓
[Claude Code] Adversarial Review（Agent Teams）
  → 別コンテキストで批判的レビュー
  → 合格まで反復（17_CODE_AUDIT.md 参照）
    ↓
完了 → 次の機能へ
```

---

## 全体タイムライン目安

| Step | 所要時間 | やること |
|------|---------|---------|
| Step 0 | 30-60分 | ディスカバリー（対話） |
| Step 1 | 2-4時間 | 事業設計資料4点の生成・確認 |
| Step 2 | 3-6時間 | プロダクト設計資料の生成・確認 |
| Step 3 | 2-4時間 | 技術設計 + プロジェクト初期構築 |
| **合計** | **1-2日** | **アイデア → 開発開始** |

※ AIが生成 → ユーザーが確認・修正 の繰り返し
※ 検証（ユーザーインタビュー等）を入れる場合は +1-2週間

---

## Step R: Retrofit（既存プロジェクト導入）

### 目的

```
既存プロジェクトをフレームワーク管理下に移行する。

入力: 既存リポジトリ（コードはあるがSSOTがない状態）
出力: docs/ 配下にSSOT一式 + CLAUDE.md

  既存プロジェクト
  ├── src/（コードあり）
  ├── package.json
  └── README.md（あるかも）

      ↓  framework retrofit

  既存プロジェクト
  ├── CLAUDE.md              ← NEW
  ├── docs/                  ← NEW
  │   ├── requirements/
  │   │   ├── SSOT-0_PRD.md
  │   │   └── SSOT-1_FEATURE_CATALOG.md
  │   ├── design/
  │   │   ├── core/
  │   │   └── features/
  │   ├── standards/
  │   └── notes/
  ├── src/（既存コードそのまま）
  └── package.json
```

### Retrofit フロー

```
Step R-1: 既存コードスキャン
────────────────────────────
  Claude Code がリポジトリ全体を読み取り:
  - ディレクトリ構造の分析
  - 使用技術の特定（言語、フレームワーク、DB等）
  - 主要エンティティの抽出
  - APIエンドポイントの一覧化
  - 認証方式の特定
  - テストの有無・カバレッジ

  出力: コードスキャンレポート（内部用）

      ↓

Step R-2: 既存ドキュメント読み込み
────────────────────────────
  既存の README、Wiki、コメント、型定義から情報を抽出:
  - プロダクトの目的
  - 機能一覧
  - 技術スタック
  - 環境構成

      ↓

Step R-3: ギャップ分析
────────────────────────────
  フレームワーク要件と既存状態を比較:

  | カテゴリ | フレームワーク要件 | 既存状態 | ギャップ |
  |---------|------------------|---------|---------|
  | PRD | SSOT-0 完成 | README のみ | 大 |
  | 機能カタログ | SSOT-1 完成 | なし | 大 |
  | API定義 | SSOT-3 完成 | コードから推定可能 | 中 |
  | データモデル | SSOT-4 完成 | マイグレーションあり | 小 |
  | テスト | カバレッジ80% | 50% | 中 |

  出力: ギャップ分析レポート → ユーザーに提示

      ↓

Step R-4: SSOT逆生成
────────────────────────────
  既存コードからSSOTを逆引きで生成する:

  コード → SSOT（逆方向）:
    src/auth/     → AUTH-001_login.md
    src/api/users → ACCT-001_signup.md
    schema.prisma → SSOT-4_DATA_MODEL.md
    routes/*      → SSOT-3_API_CONTRACT.md

  手順:
  1. コードを読み、各機能のSSOTドラフトを生成
  2. ユーザーに確認（「この理解で合っていますか？」）
  3. 修正を反映
  4. SSOT監査（13_SSOT_AUDIT.md）で95点を目指す

  注意:
  - コードの実装がそのまま「正しい仕様」とは限らない
  - バグや意図しない挙動が仕様として記録されないよう確認する
  - ユーザーに「これは意図した動作ですか？」と確認する

      ↓

Step R-5: CLAUDE.md 生成
────────────────────────────
  templates/project/CLAUDE.md を基に、
  プロジェクト固有の CLAUDE.md を生成:
  - プロジェクト概要
  - 技術スタック（R-1 で特定済み）
  - ディレクトリ構造
  - 参照すべきSSOT一覧
  - 開発規約

      ↓

Step R-6: フレームワーク管理下に移行
────────────────────────────
  - docs/ 配下にSSOT一式を配置
  - CLAUDE.md をプロジェクトルートに配置
  - 既存テストとSSOTテストケースの紐付け
  - CI/PRテンプレートの追加（任意）

  完了条件:
  □ 全機能にSSOTが存在する
  □ CLAUDE.md が設定済み
  □ 以降の開発は通常フロー（Step 4）で進められる
```

### AIへの指示（Retrofit開始）

```bash
claude "このプロジェクトをAI開発フレームワークの管理下に移行します。

       以下の手順で進めてください:
       1. リポジトリ全体をスキャンし、構造・技術・機能を把握
       2. 既存ドキュメント（README等）を読み込み
       3. フレームワーク要件とのギャップを分析し報告
       4. 承認後、既存コードからSSOTを逆生成
       5. CLAUDE.md を生成
       6. docs/ 配下にSSOT一式を配置

       各ステップで確認を求めてください。
       推測で進めないでください。"
```

### Retrofit vs 新規の違い

```
新規プロジェクト（Step 0-3）:
  仕様 → コード（順方向）
  先に仕様を決めてからコードを書く

Retrofit（Step R）:
  コード → 仕様（逆方向）
  既存コードから仕様を逆引きで生成する

共通点:
  - 最終的にSSOT一式が揃う
  - 以降の開発は同じフロー（Step 4）
  - 品質ゲートも同じ
```

---

## 変更履歴

| 日付 | 変更内容 | 変更者 |
|------|---------|-------|
| | 初版作成 | |
| | Cursor削除、Claude Code一本化。Step R: Retrofit（既存プロジェクト導入）追加 | |
| | Freeze単位の進行（Freeze 1-4）を追加 | |
| | 知識データ（docs/knowledge/）参照フローを Step 0, Step 1 に追加 | |

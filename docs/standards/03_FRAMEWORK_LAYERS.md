# 03_FRAMEWORK_LAYERS.md - フレームワーク層構造

> 共通機能と固有機能の関係、カスタマイズの範囲を定義

---

## フレームワークの3層構造

```
┌─────────────────────────────────────────────────────────────────────────┐
│                                                                         │
│   Layer 3: 固有機能仕様（Project-Specific Features）                     │
│   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━                    │
│   プロジェクト固有の機能。テンプレートから新規作成。                         │
│   例: 予約管理、AI分析、独自ワークフロー                                   │
│                                                                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   Layer 2: 共通機能仕様（Reusable Feature Specs）                        │
│   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━                    │
│   95%のプロジェクトで同じ仕様。完成済み仕様書をコピーしてカスタマイズ。       │
│   例: ログイン、サインアップ、パスワードリセット、プロフィール編集           │
│                                                                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   Layer 1: コア定義（Core Definitions）                                  │
│   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━                    │
│   全プロジェクト共通の技術基盤。原則として変更不可。                         │
│   例: 認証状態、エラーコード体系、API共通ルール、命名規則                    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 各層の詳細

### Layer 1: コア定義（Core Definitions）

**役割**: 全機能が従う「ルール・規約」

**特徴**:
- 変更不可（または変更には十分な理由とADRが必要）
- プロジェクト開始時に確定
- 全ての機能仕様がこれを参照

**含まれるもの**:

| ドキュメント | 内容 | 変更可否 |
|------------|------|---------|
| SSOT-5_CROSS_CUTTING.md | 認証状態（S0-S4）、エラーコード体系、ログ方針、セキュリティ要件 | ❌ 原則不可 |
| SSOT-3_API_CONTRACT.md | APIレスポンス形式、HTTPステータス使い分け、認証方式 | ❌ 原則不可 |
| SSOT-4_DATA_MODEL.md | 命名規則、共通カラム、主キー形式 | ❌ 原則不可 |
| SSOT-2_UI_STATE.md | 認証状態遷移、ルートガードルール | ⚠️ 拡張のみ可 |

**例: 認証状態（変更不可）**:
```
S0: LOGGED_OUT      - 未ログイン
S1: LOGGED_IN       - ログイン済み
S2: SESSION_EXPIRED - セッション切れ
S3: FORBIDDEN       - 権限不足
S4: ACCOUNT_DISABLED - アカウント停止
```

---

### Layer 2: 共通機能仕様（Reusable Feature Specs）

**役割**: 95%のプロジェクトで同じになる機能の「完成済み仕様書」

**特徴**:
- フレームワークに完成済み仕様書が同梱
- プロジェクトごとにコピーして使用
- カスタマイズ箇所が明示されている
- カスタマイズしない場合はそのまま使用可能

**提供される共通機能**:

| カテゴリ | 機能ID | 機能名 | カスタマイズレベル |
|---------|--------|-------|------------------|
| **認証** | AUTH-001 | ログイン | 低（UI調整程度） |
| | AUTH-002 | OAuth（Google） | 低 |
| | AUTH-003 | OAuth（GitHub） | 低 |
| | AUTH-005 | ログアウト | ほぼなし |
| | AUTH-006 | パスワードリセット | 低 |
| | AUTH-007 | メール認証 | 低 |
| | AUTH-009 | セッション管理 | 低 |
| | AUTH-010 | セッション更新 | ほぼなし |
| **アカウント** | ACCT-001 | サインアップ | 中（フィールド追加） |
| | ACCT-002 | プロフィール表示 | 中（フィールド追加） |
| | ACCT-003 | プロフィール編集 | 中（フィールド追加） |
| | ACCT-005 | パスワード変更 | 低 |
| | ACCT-006 | アカウント削除 | 低 |
| **共通UI** | ERR-001 | 404ページ | 低（デザイン調整） |
| | ERR-002 | 403ページ | 低 |
| | ERR-003 | 500ページ | 低 |

**カスタマイズレベルの意味**:

| レベル | 意味 | 作業量 |
|-------|------|-------|
| ほぼなし | そのまま使用可能 | 数分 |
| 低 | UIテキスト・デザイン調整のみ | 1-2時間 |
| 中 | フィールド追加・ビジネスルール微調整 | 半日 |
| 高 | 大幅な変更が必要 | 1日以上 |

---

### Layer 3: 固有機能仕様（Project-Specific Features）

**役割**: そのプロジェクト特有の機能

**特徴**:
- テンプレート（_TEMPLATE.md）から新規作成
- Layer 1のルールに従う必要がある
- 12セクション全てを埋める必要がある

**例**:
- 予約管理システム: BOOK-001〜
- ECサイト: SHOP-001〜, CART-001〜
- AI分析ツール: AI-001〜
- CRMシステム: CRM-001〜

---

## ディレクトリ構造（改善版）

```
docs/
├── core/                              ← Layer 1: コア定義
│   ├── SSOT-5_CROSS_CUTTING.md        ← 認証・エラー・セキュリティ（変更不可）
│   ├── SSOT-3_API_CONTRACT.md         ← API共通ルール（変更不可）
│   ├── SSOT-4_DATA_MODEL.md           ← DB共通ルール（変更不可）
│   └── SSOT-2_UI_STATE.md             ← 画面・状態遷移（拡張のみ可）
│
├── common-features/                   ← Layer 2: 共通機能（完成済み仕様）
│   ├── _INDEX.md                      ← 共通機能一覧・選択ガイド
│   ├── auth/
│   │   ├── AUTH-001_login.md          ← ログイン（完成済み）
│   │   ├── AUTH-002_oauth_google.md   ← Google OAuth（完成済み）
│   │   ├── AUTH-005_logout.md         ← ログアウト（完成済み）
│   │   ├── AUTH-006_password_reset.md ← パスワードリセット（完成済み）
│   │   └── ...
│   ├── account/
│   │   ├── ACCT-001_signup.md         ← サインアップ（完成済み）
│   │   ├── ACCT-002_profile_view.md   ← プロフィール表示（完成済み）
│   │   └── ...
│   └── error/
│       ├── ERR-001_404.md             ← 404ページ（完成済み）
│       └── ...
│
├── project-features/                  ← Layer 3: 固有機能（プロジェクト固有）
│   ├── _TEMPLATE.md                   ← 新規作成用テンプレート
│   └── {PROJECT-SPECIFIC}             ← プロジェクト固有の機能
│
├── ssot/                              ← プロジェクト全体のSSOT
│   ├── SSOT-0_PRD.md                  ← プロダクト要件（プロジェクト固有）
│   └── SSOT-1_FEATURE_CATALOG.md      ← 機能カタログ（選択結果）
│
└── customization/                     ← カスタマイズ記録
    └── CUSTOMIZATION_LOG.md           ← 共通機能への変更履歴
```

---

## 各層の使い方

### 1. プロジェクト開始時

```
Step 1: Layer 1（コア定義）を確認
        → 原則そのまま採用
        → 変更が必要ならADRに記録

Step 2: Layer 2（共通機能）から必要な機能を選択
        → common-features/ から project-features/ へコピー
        → カスタマイズ箇所を変更
        → CUSTOMIZATION_LOG.md に記録

Step 3: Layer 3（固有機能）を設計
        → _TEMPLATE.md から新規作成
        → 12セクションを埋める
```

### 2. 共通機能のカスタマイズ手順

```
Step 1: common-features/auth/AUTH-001_login.md をコピー
        → project-features/AUTH-001_login.md

Step 2: 「カスタマイズポイント」セクションを確認

Step 3: 必要な箇所のみ変更
        - UIテキスト
        - 追加フィールド
        - ビジネスルール

Step 4: CUSTOMIZATION_LOG.md に変更内容を記録
```

### 3. AIへの指示

```markdown
## 実装依頼

機能ID: AUTH-001
種別: 共通機能（カスタマイズ済み）

参照ドキュメント:
1. docs/project-features/AUTH-001_login.md（カスタマイズ済み仕様）
2. docs/core/SSOT-5_CROSS_CUTTING.md（コアルール）
3. docs/customization/CUSTOMIZATION_LOG.md（変更点確認）
```

---

## 層ごとの責任と変更権限

| 層 | 責任者 | 変更権限 | 変更時の要件 |
|---|--------|---------|-------------|
| Layer 1 | テックリード | 原則不可 | ADR必須 + 全体影響分析 |
| Layer 2 | 設計者 | カスタマイズ可 | CUSTOMIZATION_LOG記録 |
| Layer 3 | 設計者 | 自由 | 通常のレビュー |

---

## メリット

### 1. 開発速度の向上

| 従来 | 改善後 |
|------|-------|
| ログイン仕様を毎回ゼロから作成（2-3日） | 完成済み仕様をコピーして微調整（2-3時間） |

### 2. 品質の安定

| 従来 | 改善後 |
|------|-------|
| プロジェクトごとに仕様品質がバラバラ | 共通機能は検証済み仕様を再利用 |

### 3. 学習コストの低減

| 従来 | 改善後 |
|------|-------|
| 新メンバーが全仕様を理解する必要 | 共通機能は「標準」として学習済み |

---

## 次のドキュメント

1. **[common-features/_INDEX.md](./common-features/_INDEX.md)** - 共通機能一覧
2. **[CUSTOMIZATION_LOG.md](./customization/CUSTOMIZATION_LOG.md)** - カスタマイズ記録

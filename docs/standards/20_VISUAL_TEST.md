# 20_VISUAL_TEST.md - ブラウザベースビジュアルテスト

> 実行パターンを選択し、ビジュアルテストを自動化する

---

## 1. なぜビジュアルテストが必要か

```
コードレベルのテスト（18_TEST_FORMAT.md）で保証できること:
  ✅ APIが正しいレスポンスを返す
  ✅ バリデーションが動作する
  ✅ ビジネスルールが正しい
  ✅ エラーハンドリングが動作する

コードレベルのテストで保証できないこと:
  ❌ ボタンが実際に押せるか
  ❌ 画面遷移が正しく動くか
  ❌ レイアウトが崩れていないか
  ❌ ローディング表示が出るか
  ❌ エラーメッセージが画面に表示されるか
  ❌ レスポンシブでモバイル表示が正しいか

→ 実際にブラウザを起動し、目で見て確認するテストが必要
→ AIがブラウザを操作して確認できる
```

---

## 2. 導入フロー: 実行パターンの選択

```
ビジュアルテストをどのように実行するか？
│
├─ A: Claude Code CLI パターン
│   対話しながらテスト設計・デバッグしたい
│   Agent Teams でテスト専門エージェントを起動したい
│   ローカルで Playwright MCP を使いたい
│   → §4 へ
│
└─ B: Claude Code Web パターン
    仕様確定済みのテストを非同期・並列で回したい
    PCを閉じてもテストを継続したい
    結果をPR + レポートで受け取りたい
    → §5 へ

どちらか一方ではなく、併用が推奨:
  初回テスト設計・デバッグ → CLI パターン（§4）
  回帰テスト・一括実行     → Web パターン（§5）
```

---

## 3. テストレベル定義（共通）

```
  Level 1: 画面表示テスト
  ──────────────────────────
  「画面が正しく表示されるか」
  - 各画面にアクセスし、スクリーンショットを取得
  - SSOTの §6 UI仕様と目視比較
  - レイアウト崩れがないか確認

  Level 2: 操作フローテスト
  ──────────────────────────
  「ユーザー操作が正しく動くか」
  - SSOTの §2.4 ユーザーフローを実際に操作
  - ボタンクリック → 遷移 → 結果確認
  - フォーム入力 → 送信 → 応答確認

  Level 3: 状態表示テスト
  ──────────────────────────
  「各状態が正しく表示されるか」
  - SSOTの §6.3 状態一覧の全状態を表示
  - ローディング、空状態、エラー、データあり
  - 各状態のスクリーンショットを取得

  Level 4: レスポンシブテスト
  ──────────────────────────
  「モバイル・タブレットで正しく表示されるか」
  - デスクトップ（1280px）
  - タブレット（768px）
  - モバイル（375px）
  - 各サイズでスクリーンショットを取得

  Level 5: クロスブラウザテスト
  ──────────────────────────
  「各ブラウザで正しく動作するか」
  - Chrome
  - Firefox
  - Safari（WebKit）
```

---

## 4. Claude Code CLI パターン（Agent Teams）

### 4.1 概要

```
Claude Code CLI + Agent Teams を使い、
メインエージェントとは別にビジュアルテスト専門のエージェントを起動する。

メインエージェント（実装担当）
  │
  └── visual-tester エージェント（テスト専門）
        - Playwright MCP でブラウザを操作
        - SSOTのUI仕様と実際の表示を比較
        - スクリーンショットを取得して差異を報告
        - メインのコンテキストを汚さない

メリット:
  - メインエージェントは実装に集中できる
  - テスト専門エージェントがSSOT比較に特化
  - リアルタイムで結果を確認・デバッグ可能
  - 実装とテストを同一セッション内で並行実行
```

### 4.2 セットアップ

#### Playwright MCP 設定

```json
// .mcp.json（プロジェクトルート）
{
  "mcpServers": {
    "playwright": {
      "command": "npx",
      "args": ["@anthropic/playwright-mcp@latest"],
      "env": {
        "DISPLAY": ":1"
      }
    }
  }
}
```

#### Agent 定義ファイル

```markdown
<!-- .claude/agents/visual-tester.md -->

# Visual Tester Agent

ブラウザベースのビジュアルテストを実行する専門エージェント。
Playwright MCP を使用して画面表示・操作フロー・状態表示を検証する。

## 実行手順

1. 開発サーバーの起動を確認する（localhost:3000）
2. 指定された機能のSSOTを読み込む（docs/design/features/）
3. SSOTの §6 UI仕様に基づいてテストを実行する
4. 各テストレベルを順番に実施する:
   - Level 1: 画面表示テスト（スクリーンショット取得）
   - Level 2: 操作フローテスト（ユーザーフロー再現）
   - Level 3: 状態表示テスト（全状態を再現）
   - Level 4: レスポンシブテスト（3サイズ）
5. 品質スコアカード（§6）に基づいて採点する
6. 結果を tests/visual/reports/ に出力する

## 確認観点

- SSOTの §6.2 レイアウト図と実際の表示の一致
- 全UI要素の存在確認
- テキスト切れ・はみ出しの有無
- 余白・アラインメントの適切さ
- コンソールエラーの有無
- 操作レスポンス（3秒以内）

## 報告形式

各テストについて以下を報告:
- スクリーンショット（パス）
- SSOTとの差異リスト
- 問題の重大度（Critical / Major / Minor）
- 品質スコア（100点満点）

## 制約

- ファイルの変更は行わない（読み取りと報告のみ）
- 問題を発見しても自動修正しない（報告のみ）
- テスト結果は tests/visual/ 配下に保存する
```

### 4.3 実行方法

```bash
# Claude Code CLI で実装後、ビジュアルテストを指示
# → Agent Teams が visual-tester エージェントを自動起動

claude "AUTH-001のログイン画面を実装した。
       visual-tester エージェントを使って
       ビジュアルテストを実行して。
       SSOTは docs/design/features/common/AUTH-001_login.md"

# メインエージェントが実装を継続しながら、
# visual-tester エージェントがテストを並行実行
```

#### 実装→テストの一体フロー

```bash
# 1. メインエージェントで機能を実装
claude "AUTH-001の仕様に基づいてログイン画面を実装して"

# 2. 実装完了後、同じセッション内でテストを委譲
#    （メインエージェントが自動的に Agent Teams を起動）
#    メイン: 次の機能の実装に着手
#    visual-tester: ログイン画面のビジュアルテストを実行

# 3. テスト結果がメインに返される
#    問題があればメインが修正 → 再テスト
```

### 4.4 追加エージェント定義（推奨）

CLI パターンでは visual-tester 以外にも以下のエージェントが有用:

```
.claude/agents/
├── visual-tester.md      ← ビジュアルテスト（本セクション）
├── code-reviewer.md      ← Adversarial Review（17_CODE_AUDIT.md）
└── ssot-explorer.md      ← SSOT検索・要約
```

```markdown
<!-- .claude/agents/code-reviewer.md -->

# Code Reviewer Agent

Adversarial Review（17_CODE_AUDIT.md）の Role B として機能する。
実装コードを批判的にレビューし、問題を報告する。

## 実行手順

1. 対象ファイルを読み込む
2. 対応するSSOTを読み込む（docs/design/features/）
3. 品質スコアカード（17_CODE_AUDIT.md）に基づいて採点する
4. 問題を重大度別に報告する

## 確認観点

- SSOT MUST要件の実装漏れ
- エラーハンドリングの欠落
- 認証チェック漏れ
- any型の使用
- コーディング規約違反

## 制約

- ファイルの変更は行わない（読み取りと報告のみ）
```

```markdown
<!-- .claude/agents/ssot-explorer.md -->

# SSOT Explorer Agent

docs/ 配下のSSOTドキュメントを検索・要約する。
メインエージェントの実装作業中にSSOT参照が必要な場合に使用する。

## 実行手順

1. 指定されたキーワード/機能IDでSSOTを検索する
2. 関連するセクションを抽出する
3. 要約して返す

## 制約

- ファイルの変更は行わない（読み取りのみ）
```

---

## 5. Claude Code Web パターン（非同期実行）

### 5.1 概要

```
Claude Code Web でビジュアルテストタスクを非同期実行する。
PCを閉じてもクラウドVM上でテストが継続し、
完了時にPR + レポートで結果を受け取る。

ユーザー
  │
  ├─ & "AUTH-001のビジュアルテストを実行して"
  ├─ & "ACCT-001のビジュアルテストを実行して"
  └─ & "全画面のレスポンシブテストを実行して"
      │
      ▼
  クラウドVM（非同期・並列実行）
  ├── VM-1: AUTH-001のテスト実行中...
  ├── VM-2: ACCT-001のテスト実行中...
  └── VM-3: レスポンシブテスト実行中...
      │
      ▼
  完了 → 各タスクからPR作成
  ├── PR #10: tests/visual/AUTH-001/ にレポート追加
  ├── PR #11: tests/visual/ACCT-001/ にレポート追加
  └── PR #12: tests/visual/responsive/ にレポート追加

メリット:
  - 複数機能のテストを同時並列実行
  - PCを閉じても継続
  - 結果はPRで受け取り、差分レビュー可能
  - 回帰テストの定期実行に最適
```

### 5.2 セットアップ

#### SessionStart hooks（環境自動構築）

```json
// .claude/settings.json
{
  "hooks": {
    "SessionStart": [
      {
        "matcher": "startup",
        "hooks": [
          {
            "type": "command",
            "command": "\"$CLAUDE_PROJECT_DIR\"/scripts/setup-visual-test.sh"
          }
        ]
      }
    ]
  }
}
```

```bash
#!/bin/bash
# scripts/setup-visual-test.sh
# Claude Code Web の VM 上で実行される

# リモート環境でのみ実行
if [ "$CLAUDE_CODE_REMOTE" != "true" ]; then
  exit 0
fi

# 依存関係インストール
npm install

# Playwright ブラウザインストール
npx playwright install chromium

# 開発サーバーをバックグラウンドで起動
npm run dev &

# サーバー起動を待つ
sleep 5
echo "Visual test environment ready"
```

### 5.3 実行方法

```bash
# Claude Code CLI から Web にテストタスクを送信

# 単一機能のビジュアルテスト
& "docs/design/features/common/AUTH-001_login.md のSSOTに基づいて
   ビジュアルテスト（Level 1-4）を実行して。
   結果を tests/visual/AUTH-001/ に保存して。
   品質スコアカードに基づいて採点して。"

# 複数機能を並列テスト
& "AUTH-001のビジュアルテストを実行して"
& "ACCT-001のビジュアルテストを実行して"
& "AUTH-005のビジュアルテストを実行して"

# 全画面の回帰テスト
& "tests/visual/baseline/ の基準画像と現在の画面を比較して。
   差異があれば tests/visual/diff/ に差分画像を保存して。
   レポートを tests/visual/reports/regression-YYYY-MM-DD.md に出力して。"

# 進捗確認
/tasks
```

### 5.4 テスト実行プロンプトテンプレート

#### Level 1-4 一括テスト

```markdown
## ビジュアルテスト実行指示

対象: [FEAT-XXX]
SSOT: docs/design/features/[path]

### 手順
1. 開発サーバーが起動していることを確認（npm run dev）
2. Playwright でヘッドレスブラウザを起動
3. 以下のテストを順番に実行:

Level 1: 画面表示テスト
- SSOTの §6.2 に定義された全画面にアクセス
- 各画面のスクリーンショットを tests/visual/[FEAT-XXX]/level1/ に保存
- SSOTのUI仕様との差異をリストアップ

Level 2: 操作フローテスト
- SSOTの §2.4 ユーザーフローを再現
- 各ステップのスクリーンショットを tests/visual/[FEAT-XXX]/level2/ に保存
- 期待結果との差異をリストアップ

Level 3: 状態表示テスト
- 初期表示、ローディング、データあり、データなし、エラーの各状態を再現
- 各状態のスクリーンショットを tests/visual/[FEAT-XXX]/level3/ に保存

Level 4: レスポンシブテスト
- デスクトップ(1280px)、タブレット(768px)、モバイル(375px)で取得
- tests/visual/[FEAT-XXX]/level4/ に保存

### 出力
- tests/visual/[FEAT-XXX]/report.md にテストレポートを生成
- 品質スコアカードに基づいて採点（100点満点）
- 問題があれば重大度別にリストアップ
```

---

## 6. 品質スコアカード（共通・100点満点）

```
┌─ ビジュアルテスト品質スコアカード ─────────────────────────────────────┐
│                                                                         │
│  #   カテゴリ               配点   評価基準                             │
│  ───────────────────────────────────────────────────────────────────── │
│  1   画面表示正確性          25    SSOTのUI仕様と実際の表示が一致するか │
│  2   操作フロー正確性        25    ユーザーフローが正しく動作するか     │
│  3   全状態表示確認          20    全状態（空/ローディング/エラー等）    │
│  4   レスポンシブ対応        15    3サイズでレイアウトが適切か          │
│  5   コンソールエラー        10    JavaScriptエラーがゼロか             │
│  6   パフォーマンス          5     操作のレスポンスが許容範囲内か       │
│                                                                         │
│  合計                      100                                          │
│  合格ライン                100点                                        │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 各カテゴリの減点ルール

```
1. 画面表示正確性（25点）
   SSOTの§6.2 と表示が異なる: -5点/件
   表示要素の欠落: -5点/件
   テキスト切れ/はみ出し: -3点/件
   余白・アラインメント不正: -2点/件

2. 操作フロー正確性（25点）
   操作が動作しない: -10点/件（致命的）
   遷移先が間違い: -5点/件
   期待結果と異なる: -5点/件

3. 全状態表示確認（20点）
   状態が未確認: -5点/件
   空状態の表示が不適切: -5点
   エラー状態の表示が不適切: -5点
   ローディング表示がない: -5点

4. レスポンシブ対応（15点）
   横スクロール発生: -5点/サイズ
   タップ領域が小さすぎる: -3点/件
   テキストが読めない: -3点/件

5. コンソールエラー（10点）
   JavaScriptエラー: -5点/件
   未処理のPromise rejection: -3点/件
   404リクエスト: -2点/件

6. パフォーマンス（5点）
   操作レスポンス3秒超: -3点/件
   画面表示5秒超: -2点/件
```

---

## 7. 回帰テスト（共通）

### スクリーンショット比較

```
初回実行:
  各画面のスクリーンショットを「基準画像」として保存
  → tests/visual/baseline/[画面名]-[サイズ].png

2回目以降:
  同じ条件でスクリーンショットを取得
  → tests/visual/current/[画面名]-[サイズ].png
  → 基準画像と比較
  → 差分があれば報告

保存先:
  tests/
  └── visual/
      ├── baseline/        ← 基準画像
      ├── current/         ← 最新のスクリーンショット
      ├── diff/            ← 差分画像
      └── reports/         ← テストレポート
```

### 回帰テストの実行方法

```
CLI パターン（§4）:
  claude "前回のビジュアルテストの基準画像と
         現在の画面を比較して。
         visual-tester エージェントで実行して。"

Web パターン（§5）:
  & "tests/visual/baseline/ の基準画像と
     現在の画面を比較して。差異をレポートして。"
```

---

## 8. 監査レポートテンプレート（共通）

```markdown
# ビジュアルテスト監査レポート

## 対象
| 項目 | 内容 |
|------|------|
| 機能ID | [FEAT-XXX] |
| テスト日 | [YYYY-MM-DD] |
| 実行パターン | CLI / Web |
| テスト環境 | localhost:3000 / クラウドVM |
| ブラウザ | Chrome XXX |

## スクリーンショット一覧

### 画面表示（Level 1）
| 画面 | デスクトップ | タブレット | モバイル | 判定 |
|------|------------|----------|---------|------|
| [画面名] | [画像パス] | [画像パス] | [画像パス] | ✅/❌ |

### 操作フロー（Level 2）
| ステップ | 操作 | スクリーンショット | 結果 |
|---------|------|------------------|------|
| 1 | [操作] | [画像パス] | ✅/❌ |

### 状態確認（Level 3）
| 状態 | スクリーンショット | 判定 |
|------|------------------|------|
| 初期表示 | [画像パス] | ✅/❌ |
| ローディング | [画像パス] | ✅/❌ |
| データあり | [画像パス] | ✅/❌ |
| データなし | [画像パス] | ✅/❌ |
| エラー | [画像パス] | ✅/❌ |

## スコア
[品質スコアカード（§6）に基づくスコアリング]

## 指摘事項
| # | 重大度 | カテゴリ | 内容 | スクリーンショット |
|---|--------|---------|------|------------------|
```

---

## 変更履歴

| 日付 | 変更内容 | 変更者 |
|------|---------|-------|
| | 初版作成 | |
| | CLI/Web 2パターン導入。CLI パターンに Agent Teams 追加。Web パターンに非同期並列実行追加 | |

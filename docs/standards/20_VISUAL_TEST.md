# 20_VISUAL_TEST.md - ブラウザベースビジュアルテスト

> MCP サーバーを活用し、目視に近いテストをAIに実行させる

---

## なぜビジュアルテストが必要か

```
コードレベルのテスト（18_TEST_FORMAT.md）で保証できること:
  ✅ APIが正しいレスポンスを返す
  ✅ バリデーションが動作する
  ✅ ビジネスルールが正しい
  ✅ エラーハンドリングが動作する

コードレベルのテストで保証できないこと:
  ❌ ボタンが実際に押せるか
  ❌ 画面遷移が正しく動くか
  ❌ レイアウトが崩れていないか
  ❌ ローディング表示が出るか
  ❌ エラーメッセージが画面に表示されるか
  ❌ レスポンシブでモバイル表示が正しいか

→ 実際にブラウザを起動し、目で見て確認するテストが必要
→ MCPサーバーを使えばAIがブラウザを操作して確認できる
```

---

## MCP サーバー構成

### 使用するMCPサーバー

```
┌─ テスト環境 ──────────────────────────────────────────┐
│                                                         │
│  Playwright MCP Server                                  │
│  ─────────────────                                     │
│  ブラウザ自動操作 + スクリーンショット取得              │
│  Claude Code / Cursor から直接制御                      │
│                                                         │
│  機能:                                                  │
│  - ブラウザの起動・操作（クリック、入力、遷移）        │
│  - スクリーンショットの取得（全画面・要素単位）        │
│  - コンソールログの取得                                 │
│  - ネットワークリクエストの監視                         │
│  - アクセシビリティツリーの取得                         │
│  - マルチブラウザ対応（Chrome、Firefox、Safari）       │
│  - モバイルエミュレーション                             │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### MCP設定（Claude Code）

```json
// .mcp.json（プロジェクトルート）
{
  "mcpServers": {
    "playwright": {
      "command": "npx",
      "args": ["@anthropic/playwright-mcp@latest"],
      "env": {
        "DISPLAY": ":1"
      }
    }
  }
}
```

### MCP設定（Cursor）

```json
// .cursor/mcp.json
{
  "mcpServers": {
    "playwright": {
      "command": "npx",
      "args": ["@anthropic/playwright-mcp@latest"]
    }
  }
}
```

---

## ビジュアルテストのレベル

```
  Level 1: 画面表示テスト
  ──────────────────────────
  「画面が正しく表示されるか」
  - 各画面にアクセスし、スクリーンショットを取得
  - SSOTの §6 UI仕様と目視比較
  - レイアウト崩れがないか確認

  Level 2: 操作フローテスト
  ──────────────────────────
  「ユーザー操作が正しく動くか」
  - SSOTの §2.4 ユーザーフローを実際に操作
  - ボタンクリック → 遷移 → 結果確認
  - フォーム入力 → 送信 → 応答確認

  Level 3: 状態表示テスト
  ──────────────────────────
  「各状態が正しく表示されるか」
  - SSOTの §6.3 状態一覧の全状態を表示
  - ローディング、空状態、エラー、データあり
  - 各状態のスクリーンショットを取得

  Level 4: レスポンシブテスト
  ──────────────────────────
  「モバイル・タブレットで正しく表示されるか」
  - デスクトップ（1280px）
  - タブレット（768px）
  - モバイル（375px）
  - 各サイズでスクリーンショットを取得

  Level 5: クロスブラウザテスト
  ──────────────────────────
  「各ブラウザで正しく動作するか」
  - Chrome
  - Firefox
  - Safari（WebKit）
```

---

## ビジュアルテストの実行プロンプト

### Level 1: 画面表示テスト

```markdown
# [FEAT-XXX] 画面表示テスト

## 指示
Playwright MCP を使って、以下の画面にアクセスし、
スクリーンショットを取得してください。

## テスト手順

### 準備
1. 開発サーバーを起動（localhost:3000）
2. テスト用ユーザーでログイン

### 各画面の確認
以下の画面それぞれについて:
1. 画面にアクセス
2. 全体のスクリーンショットを取得
3. SSOTのUI仕様と比較し、差異を報告

| 画面 | パス | SSOTの§6参照 |
|------|------|-------------|
| [画面名] | /path | §6.2 レイアウト図 |
| [画面名] | /path | §6.2 レイアウト図 |

### 確認観点
各画面について以下を確認:
- [ ] レイアウトがSSOT §6.2 の定義と一致するか
- [ ] 表示要素が全て存在するか
- [ ] テキストが切れていないか
- [ ] 余白やアラインメントが適切か
- [ ] アイコンや画像が正しく表示されているか

### 報告形式
各画面について:
- スクリーンショット
- SSOTとの差異リスト（あれば）
- 問題の重大度（Critical / Major / Minor）
```

### Level 2: 操作フローテスト

```markdown
# [FEAT-XXX] 操作フローテスト

## 指示
Playwright MCP を使って、以下のユーザーフローを
実際にブラウザ上で操作し、各ステップの動作を確認してください。

## ユーザーフロー（SSOTの§2.4 原文）
[SSOTのユーザーフローを貼り付け]

## テスト手順

各ステップで:
1. 操作を実行（クリック、入力、選択）
2. スクリーンショットを取得
3. 期待される動作と実際の動作を比較
4. 問題があれば報告

| # | 操作 | 期待結果 | 確認 |
|---|------|---------|------|
| 1 | [画面]にアクセス | [表示内容] | スクショ |
| 2 | [ボタン]をクリック | [遷移先/動作] | スクショ |
| 3 | [フォーム]に入力 | [バリデーション] | スクショ |
| 4 | [送信]をクリック | [結果表示] | スクショ |

## 追加確認
- [ ] 各操作のレスポンスが3秒以内か
- [ ] ローディング表示が出るか
- [ ] 完了メッセージが表示されるか
- [ ] コンソールにエラーが出ていないか
```

### Level 3: 状態表示テスト

```markdown
# [FEAT-XXX] 状態表示テスト

## 指示
Playwright MCP を使って、SSOTで定義された
全ての画面状態を再現し、スクリーンショットで確認してください。

## 状態一覧（SSOTの§6.3 原文）
[SSOTの状態一覧を貼り付け]

## テスト手順

各状態について:
1. テストデータで状態を再現
2. スクリーンショットを取得
3. SSOTの定義と比較

| 状態 | 再現方法 | SSOTの表示定義 |
|------|---------|---------------|
| 初期表示 | ページ直アクセス | §6.3 |
| ローディング | API遅延設定 | §6.3 |
| データあり | テストデータ投入 | §6.3 |
| データなし（空） | データ削除 | §6.3 |
| エラー | API強制エラー | §6.3 |

## 空状態で特に確認
- [ ] 「データがありません」等のメッセージが表示されるか
- [ ] 新規作成への導線があるか
- [ ] レイアウトが崩れていないか
```

### Level 4: レスポンシブテスト

```markdown
# [FEAT-XXX] レスポンシブテスト

## 指示
Playwright MCP を使って、以下の3サイズで
各画面のスクリーンショットを取得してください。

## ビューポートサイズ
| デバイス | 幅 | 高さ |
|---------|------|------|
| デスクトップ | 1280 | 720 |
| タブレット | 768 | 1024 |
| モバイル | 375 | 812 |

## テスト対象画面
[主要画面のリスト]

## 各サイズで確認
- [ ] レイアウトが適切に変化するか
- [ ] テキストが読めるか
- [ ] ボタンがタップ可能なサイズか（モバイル: 44px以上）
- [ ] 横スクロールが発生していないか
- [ ] ナビゲーションが適切に変化するか（ハンバーガーメニュー等）
```

---

## ビジュアルテストの自動化

### スクリーンショット比較（回帰テスト）

```
初回実行:
  各画面のスクリーンショットを「基準画像」として保存
  → screenshots/baseline/[画面名]-[サイズ].png

2回目以降:
  同じ条件でスクリーンショットを取得
  → screenshots/current/[画面名]-[サイズ].png
  → 基準画像と比較
  → 差分があれば報告

保存先:
  tests/
  └── visual/
      ├── baseline/        ← 基準画像
      ├── current/         ← 最新のスクリーンショット
      ├── diff/            ← 差分画像
      └── reports/         ← テストレポート
```

### AIへの回帰テスト指示

```
前回のビジュアルテストの基準画像と、
今回の実装を比較してください。

基準画像: tests/visual/baseline/
現在の画面: localhost:3000

各画面について:
1. 基準画像と同じ条件でスクリーンショット取得
2. レイアウトの変化を報告
3. 意図しない変更があれば Critical として報告
4. 意図的な変更は基準画像を更新
```

---

## ビジュアルテスト品質スコアカード（100点満点）

```
┌─ ビジュアルテスト品質スコアカード ─────────────────────────────────────┐
│                                                                         │
│  #   カテゴリ               配点   評価基準                             │
│  ───────────────────────────────────────────────────────────────────── │
│  1   画面表示正確性          25    SSOTのUI仕様と実際の表示が一致するか │
│  2   操作フロー正確性        25    ユーザーフローが正しく動作するか     │
│  3   全状態表示確認          20    全状態（空/ローディング/エラー等）    │
│  4   レスポンシブ対応        15    3サイズでレイアウトが適切か          │
│  5   コンソールエラー        10    JavaScriptエラーがゼロか             │
│  6   パフォーマンス          5     操作のレスポンスが許容範囲内か       │
│                                                                         │
│  合計                      100                                          │
│  合格ライン                100点                                        │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 各カテゴリの減点ルール

```
1. 画面表示正確性（25点）
   SSOTの§6.2 と表示が異なる: -5点/件
   表示要素の欠落: -5点/件
   テキスト切れ/はみ出し: -3点/件
   余白・アラインメント不正: -2点/件

2. 操作フロー正確性（25点）
   操作が動作しない: -10点/件（致命的）
   遷移先が間違い: -5点/件
   期待結果と異なる: -5点/件

3. 全状態表示確認（20点）
   状態が未確認: -5点/件
   空状態の表示が不適切: -5点
   エラー状態の表示が不適切: -5点
   ローディング表示がない: -5点

4. レスポンシブ対応（15点）
   横スクロール発生: -5点/サイズ
   タップ領域が小さすぎる: -3点/件
   テキストが読めない: -3点/件

5. コンソールエラー（10点）
   JavaScriptエラー: -5点/件
   未処理のPromise rejection: -3点/件
   404リクエスト: -2点/件

6. パフォーマンス（5点）
   操作レスポンス3秒超: -3点/件
   画面表示5秒超: -2点/件
```

---

## ビジュアルテスト監査レポートテンプレート

```markdown
# ビジュアルテスト監査レポート

## 対象
| 項目 | 内容 |
|------|------|
| 機能ID | [FEAT-XXX] |
| テスト日 | [YYYY-MM-DD] |
| テスト環境 | localhost:3000 |
| ブラウザ | Chrome XXX |

## スクリーンショット一覧

### 画面表示
| 画面 | デスクトップ | タブレット | モバイル | 判定 |
|------|------------|----------|---------|------|
| [画面名] | [画像] | [画像] | [画像] | ✅/❌ |

### 操作フロー
| ステップ | 操作 | スクリーンショット | 結果 |
|---------|------|------------------|------|
| 1 | [操作] | [画像] | ✅/❌ |

### 状態確認
| 状態 | スクリーンショット | 判定 |
|------|------------------|------|
| 初期表示 | [画像] | ✅/❌ |
| ローディング | [画像] | ✅/❌ |
| データあり | [画像] | ✅/❌ |
| データなし | [画像] | ✅/❌ |
| エラー | [画像] | ✅/❌ |

## スコア
[品質スコアカードに基づくスコアリング]

## 指摘事項
| # | 重大度 | カテゴリ | 内容 | スクリーンショット |
|---|--------|---------|------|------------------|
```

---

## 変更履歴

| 日付 | 変更内容 | 変更者 |
|------|---------|-------|
| | 初版作成 | |

# MONITORING.md - 監視・アラート定義書

> 監視項目、アラート条件、通知先を定義

---

## 基本情報

| 項目 | 内容 |
|------|------|
| プロジェクト名 | |
| 監視ツール | Datadog / CloudWatch / Sentry |
| 最終更新日 | YYYY-MM-DD |

---

## 1. 監視ツール構成

### 1.1 ツール一覧

| 用途 | ツール | 対象 |
|------|-------|------|
| エラー監視 | Sentry | アプリケーションエラー |
| インフラ監視 | CloudWatch / Datadog | サーバー・DB |
| ログ収集 | CloudWatch Logs / Datadog | アプリログ |
| APM | Datadog APM | パフォーマンス |
| 外形監視 | UptimeRobot / Pingdom | エンドポイント死活 |
| アナリティクス | Google Analytics / PostHog | ユーザー行動 |

### 1.2 ダッシュボードURL

| ダッシュボード | URL | 用途 |
|--------------|-----|------|
| Sentry | https://sentry.io/xxx | エラー確認 |
| CloudWatch | https://console.aws.amazon.com/xxx | インフラ |
| Datadog | https://app.datadoghq.com/xxx | 総合 |

---

## 2. 監視メトリクス

### 2.1 アプリケーション

| メトリクス | 説明 | 正常範囲 | 収集間隔 |
|-----------|------|---------|---------|
| Error Rate | エラー発生率 | < 1% | 1分 |
| Response Time (p50) | 応答時間中央値 | < 200ms | 1分 |
| Response Time (p95) | 応答時間95%ile | < 500ms | 1分 |
| Response Time (p99) | 応答時間99%ile | < 1000ms | 1分 |
| Request Count | リクエスト数 | - | 1分 |
| Active Users | 同時接続数 | - | 1分 |

### 2.2 インフラ

| メトリクス | 説明 | 正常範囲 | 収集間隔 |
|-----------|------|---------|---------|
| CPU Usage | CPU使用率 | < 70% | 1分 |
| Memory Usage | メモリ使用率 | < 80% | 1分 |
| Disk Usage | ディスク使用率 | < 80% | 5分 |
| Network I/O | ネットワーク転送量 | - | 1分 |

### 2.3 データベース

| メトリクス | 説明 | 正常範囲 | 収集間隔 |
|-----------|------|---------|---------|
| Connection Count | 接続数 | < 80% of max | 1分 |
| Query Time (p95) | クエリ時間 | < 100ms | 1分 |
| Slow Queries | スロークエリ数 | < 10/min | 1分 |
| Replication Lag | レプリケーション遅延 | < 1s | 1分 |
| Disk IOPS | ディスクI/O | < 80% of limit | 1分 |

### 2.4 外部サービス

| メトリクス | 説明 | 正常範囲 | 収集間隔 |
|-----------|------|---------|---------|
| API Availability | 外部API稼働率 | > 99.9% | 1分 |
| API Latency | 外部API応答時間 | < 500ms | 1分 |
| Rate Limit Usage | レート制限使用率 | < 80% | 1分 |

---

## 3. アラート定義

### 3.1 重要度レベル

| レベル | 名称 | 対応時間 | 通知先 |
|-------|------|---------|-------|
| P1 | Critical | 15分以内 | Slack + PagerDuty + 電話 |
| P2 | High | 1時間以内 | Slack + PagerDuty |
| P3 | Medium | 4時間以内 | Slack |
| P4 | Low | 翌営業日 | Slack（通常チャンネル） |

### 3.2 アラート一覧

#### P1 (Critical)

| アラート名 | 条件 | 対応 |
|-----------|------|------|
| Service Down | 外形監視が3回連続失敗 | 即座に調査・復旧 |
| Error Rate Spike | エラー率 > 10% (5分間) | 即座に調査・ロールバック検討 |
| Database Down | DB接続失敗 | 即座に調査・復旧 |

#### P2 (High)

| アラート名 | 条件 | 対応 |
|-----------|------|------|
| High Error Rate | エラー率 > 5% (5分間) | 調査・対応 |
| High Response Time | p95 > 2000ms (5分間) | 調査・スケール検討 |
| High CPU | CPU > 90% (10分間) | スケール検討 |
| High Memory | Memory > 90% (10分間) | メモリリーク調査 |
| DB Connection Exhaustion | 接続数 > 90% (5分間) | 接続プール調整 |

#### P3 (Medium)

| アラート名 | 条件 | 対応 |
|-----------|------|------|
| Elevated Error Rate | エラー率 > 2% (15分間) | 調査 |
| Elevated Response Time | p95 > 1000ms (15分間) | パフォーマンス調査 |
| High Disk Usage | Disk > 80% | 不要ファイル削除・拡張計画 |
| Slow Queries Increase | スロークエリ > 50/min | クエリ最適化 |

#### P4 (Low)

| アラート名 | 条件 | 対応 |
|-----------|------|------|
| SSL Certificate Expiry | 30日以内に期限切れ | 更新計画 |
| Dependency Outdated | 重要な依存が古い | 更新計画 |

---

## 4. 通知設定

### 4.1 通知チャンネル

| チャンネル | 用途 | 対象アラート |
|-----------|------|-------------|
| #alerts-critical | 緊急アラート | P1 |
| #alerts-high | 重要アラート | P2 |
| #alerts | 通常アラート | P3, P4 |
| PagerDuty | オンコール | P1, P2 |
| Email | バックアップ | P1 |

### 4.2 Slack通知フォーマット

```
🚨 [P1] Service Down - Production

状態: CRITICAL
時刻: 2024-01-15 10:30:00 JST
詳細: 外形監視が3回連続で失敗

対応: 
1. 即座にダッシュボードを確認
2. 直近のデプロイを確認
3. ロールバックを検討

ダッシュボード: https://xxx
ランブック: https://xxx
```

### 4.3 エスカレーション

```
0分   → Slack (#alerts-critical)
5分   → PagerDuty (オンコール担当)
15分  → PagerDuty (バックアップ担当)
30分  → 電話 (テックリード)
60分  → 電話 (CTO)
```

---

## 5. ダッシュボード

### 5.1 概要ダッシュボード

```
┌─────────────────────────────────────────────────────────────┐
│  Overview Dashboard                                         │
├─────────────────┬─────────────────┬─────────────────────────┤
│  Request Rate   │  Error Rate     │  Response Time (p95)    │
│  ████████░░     │  ██░░░░░░░░     │  ████░░░░░░             │
│  1,234 req/s    │  0.5%           │  245ms                  │
├─────────────────┴─────────────────┴─────────────────────────┤
│  Error Rate (24h)                                           │
│  ▁▁▂▁▁▁▁▅▂▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁                                  │
├─────────────────────────────────────────────────────────────┤
│  Top Errors                     │  Slow Endpoints          │
│  1. AuthError (45)              │  1. /api/search (850ms)  │
│  2. ValidationError (23)        │  2. /api/reports (620ms) │
│  3. NetworkError (12)           │  3. /api/export (580ms)  │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 ダッシュボード一覧

| ダッシュボード名 | 内容 | 主な利用者 |
|----------------|------|-----------|
| Overview | 全体サマリー | 全員 |
| Application | アプリメトリクス詳細 | 開発者 |
| Infrastructure | インフラメトリクス | SRE |
| Database | DBメトリクス | DBA |
| Business | ビジネスメトリクス | PO |

---

## 6. ログ

### 6.1 ログレベル

| レベル | 用途 | 本番での出力 |
|-------|------|-------------|
| DEBUG | 詳細デバッグ情報 | ❌ |
| INFO | 正常動作の記録 | ✅ |
| WARN | 警告（動作は継続） | ✅ |
| ERROR | エラー（要対応） | ✅ |
| FATAL | 致命的エラー | ✅ |

### 6.2 ログフォーマット

```json
{
  "timestamp": "2024-01-15T10:30:00.000Z",
  "level": "ERROR",
  "message": "Failed to authenticate user",
  "service": "auth-service",
  "traceId": "abc123",
  "userId": "usr_xxx",
  "error": {
    "code": "AUTH_001",
    "message": "Invalid credentials"
  },
  "context": {
    "endpoint": "/api/auth/login",
    "method": "POST",
    "ip": "xxx.xxx.xxx.xxx"
  }
}
```

### 6.3 ログ保持期間

| 環境 | 保持期間 |
|------|---------|
| Production | 90日 |
| Staging | 30日 |
| Development | 7日 |

---

## 7. オンコール

### 7.1 オンコール体制

| 時間帯 | 担当 |
|-------|------|
| 平日 9:00-18:00 | 当番制（開発チーム） |
| 平日夜間・休日 | オンコール担当（週替わり） |

### 7.2 オンコールローテーション

| 週 | Primary | Secondary |
|----|---------|-----------|
| Week 1 | | |
| Week 2 | | |
| Week 3 | | |
| Week 4 | | |

### 7.3 オンコール対応フロー

```
1. アラート受信
   ↓
2. 状況確認（ダッシュボード・ログ）
   ↓
3. 影響範囲の特定
   ↓
4. 一次対応（ロールバック/スケール/再起動）
   ↓
5. 状況報告（Slack）
   ↓
6. 根本原因調査
   ↓
7. ポストモーテム作成
```

---

## 8. SLI/SLO

### 8.1 SLI（Service Level Indicator）

| SLI | 計算方法 |
|-----|---------|
| Availability | 成功リクエスト数 / 総リクエスト数 |
| Latency | p95 応答時間 |
| Error Rate | エラーリクエスト数 / 総リクエスト数 |

### 8.2 SLO（Service Level Objective）

| SLI | SLO | 計測期間 |
|-----|-----|---------|
| Availability | 99.9% | 月間 |
| Latency (p95) | < 500ms | 月間 |
| Error Rate | < 0.1% | 月間 |

### 8.3 エラーバジェット

```
月間エラーバジェット = (1 - SLO) × 総リクエスト数

例: SLO 99.9%、月間1000万リクエストの場合
エラーバジェット = 0.1% × 10,000,000 = 10,000 エラー
```

---

## 9. 定期確認

### 9.1 日次確認

| 時間 | 確認項目 |
|------|---------|
| 9:00 | 前夜のアラート確認 |
| 9:00 | エラーログ確認 |
| 9:00 | パフォーマンス傾向確認 |

### 9.2 週次確認

| 確認項目 | 担当 |
|---------|------|
| SLO達成状況 | SRE |
| エラートレンド | 開発チーム |
| パフォーマンストレンド | 開発チーム |
| キャパシティ確認 | SRE |

### 9.3 月次確認

| 確認項目 | 担当 |
|---------|------|
| SLOレポート | SRE |
| インシデントレビュー | 全員 |
| コスト確認 | TL |

---

## 変更履歴

| 日付 | 変更内容 | 変更者 |
|------|---------|-------|
| | 初版作成 | |

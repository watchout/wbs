# AI エスカレーション規約

> Version: 3.0
> 対象: Claude Code, Cursor, その他AIエージェント

---

## 1. 概要

本規約は、AIエージェントが開発作業中に判断を中断し、
人間に確認を求めるべき状況（エスカレーション）を定義する。

**原則:** 「推測で進める」「とりあえず仮で」は禁止。

---

## 2. エスカレーショントリガー（T1-T7）

以下の状況に遭遇した場合、**即座に作業を中断**しユーザーに質問すること。

| ID | トリガー | 説明 | 例 |
|----|----------|------|-----|
| **T1** | SSOT未記載 | 仕様書に記載がない判断が必要 | 「ボタンの色が未定義」 |
| **T2** | 曖昧な記載 | 複数の解釈が可能 | 「適切なエラーメッセージ」とは？ |
| **T3** | 技術的選択 | 選択肢が複数あり判断不能 | REST vs GraphQL |
| **T4** | 実装との矛盾 | SSOTと既存コードが矛盾 | 仕様は4ロール、コードは6ロール |
| **T5** | 規約の穴 | 制約・規約に未定義のケース | 「祝日の扱いが未定義」 |
| **T6** | 影響範囲不明 | 変更の影響範囲が判断不能 | 共通コンポーネントの変更 |
| **T7** | ビジネス判断 | 技術ではなくビジネス判断が必要 | 「無料プランの制限値」 |

---

## 3. 層別エスカレーションルール

### 3.1 CORE層（Freeze 1-2）

```
エスカレーション: 必須
変更権限: なし

AIは CORE層 のドキュメントを変更してはならない。
変更が必要な場合は、必ずユーザーに提案として報告する。
```

**対象ドキュメント:**
- SSOT-0: PRD
- SSOT-1: 機能台帳

---

### 3.2 CONTRACT層（Freeze 3）

```
エスカレーション: 原則必須
変更権限: 軽微な修正のみ（タイポ、明らかな誤記）

インターフェース変更は影響分析を行い、ユーザー承認を得る。
```

**対象ドキュメント:**
- SSOT-2: UI/状態遷移
- SSOT-3: API契約
- SSOT-4: データモデル
- SSOT-5: 横断的関心事

**エスカレーション例:**
- APIエンドポイントの追加/削除
- スキーマ変更（カラム追加/削除）
- 画面遷移の変更

---

### 3.3 DETAIL層（Freeze 4）

```
エスカレーション: 条件付き
変更権限: あり（止まらないルール適用）

技術的に妥当な選択肢が1つの場合は進んでよい。
複数の選択肢がある場合はエスカレーション。
```

**止まらないルール適用条件:**
1. SSOT に明記なし
2. 技術的に妥当な選択肢が1つ
3. 他の機能への影響がない
4. セキュリティリスクがない

**エスカレーション例:**
- 2つ以上のライブラリで迷う
- UIデザインの詳細で複数案がある
- パフォーマンス vs 可読性のトレードオフ

---

## 4. エスカレーション形式

### 4.1 質問テンプレート

```markdown
## 🔶 エスカレーション: [タイトル]

**トリガー:** T[番号] - [トリガー名]
**層:** [CORE | CONTRACT | DETAIL]
**対象ファイル:** [ファイルパス]

### 状況
[現在の状況を説明]

### 選択肢
| 案 | 内容 | メリット | デメリット |
|----|------|----------|-----------|
| A | ... | ... | ... |
| B | ... | ... | ... |

### 推奨
[推奨案がある場合は記載、なければ「判断を委ねます」]

### 影響範囲
[変更による影響を列挙]
```

---

### 4.2 エスカレーション例

```markdown
## 🔶 エスカレーション: ロール体系の不整合

**トリガー:** T4 - 実装との矛盾
**層:** CONTRACT
**対象ファイル:** server/utils/authMiddleware.ts

### 状況
SSOT-5 では4ロール体系（ADMIN, LEADER, MEMBER, DEVICE）と定義されているが、
authMiddleware.ts に SUPER_ADMIN と MANAGER への参照が残っている。

### 選択肢
| 案 | 内容 | メリット | デメリット |
|----|------|----------|-----------|
| A | コードから SUPER_ADMIN/MANAGER を削除 | SSOT準拠、シンプル | 将来の拡張性低下 |
| B | SSOTを6ロールに変更 | 柔軟性維持 | 複雑化、YAGNI違反 |
| C | 現状維持（乖離を許容） | 変更コストゼロ | 技術的負債 |

### 推奨
A案（YAGNI原則、SSOT優先）

### 影響範囲
- authMiddleware.ts
- authMiddleware.test.ts
- middleware/admin.ts
- 関連するVueコンポーネント
```

---

## 5. 回答受領後の対応

### 5.1 承認された場合

1. 指示に従って実装
2. 該当SSOTを更新（DETAIL層のみ自動更新可）
3. 変更をコミット
4. 変更サマリーを報告

### 5.2 追加情報を求められた場合

1. 要求された情報を調査
2. 調査結果を報告
3. 再度エスカレーション

### 5.3 保留された場合

1. 当該タスクを保留としてマーク
2. 他のタスクに着手（可能な場合）
3. 保留事項を SSOT の「未決事項」に記録

---

## 6. エスカレーション禁止事項

以下の行動は禁止：

| 禁止事項 | 理由 |
|----------|------|
| 推測で進める | 手戻りリスク、品質低下 |
| 仮実装で進める | 技術的負債の発生 |
| 複数案を勝手に選ぶ | 責任分界点の曖昧化 |
| エスカレーションを後回し | 問題の複雑化 |
| 曖昧な質問をする | ユーザーの判断コスト増加 |

---

## 7. エスカレーション不要なケース

以下はエスカレーション不要で進んでよい：

| ケース | 条件 |
|--------|------|
| タイポ修正 | 明らかな誤記 |
| コードフォーマット | Linter/Prettier による自動修正 |
| 変数名改善 | スコープがローカル |
| コメント追加 | 仕様に影響しない |
| テスト追加 | 既存仕様のカバレッジ向上 |
| 依存パッケージ更新 | セマンティックバージョニングに従う場合 |

---

## 8. 緊急度レベル

| レベル | 説明 | 対応 |
|--------|------|------|
| **P0** | ブロッカー（作業継続不可） | 即時エスカレーション |
| **P1** | 重要（品質に影響） | 当日中にエスカレーション |
| **P2** | 軽微（改善提案） | タスク完了時にまとめて報告 |

---

## 9. CLAUDE.md との関係

本規約は CLAUDE.md の「AI中断プロトコル」セクションと連動する。

CLAUDE.md に記載された T1-T7 トリガーは、本規約の詳細版である。
プロジェクト固有のエスカレーションルールは CLAUDE.md に追記する。

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|----------|
| 2026-02-05 | 3.0 | WBS プロジェクトへ導入 |

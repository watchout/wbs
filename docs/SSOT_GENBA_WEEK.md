# SSOT: ミエルボード for 現場 / ミエルボード

**プロジェクト**: ミエルボード for 現場  
**第1弾モジュール**: ミエルボード（週間ボード）  
**バージョン**: v2.0  
**最終更新**: 2025-12-07

---

## 🎯 このドキュメントの位置づけ

このドキュメントは **「ミエルボード for 現場 / ミエルボード」の設計における唯一の正（Single Source of Truth）** です。

- すべての実装はこのSSOTに基づく
- 仕様変更はこのドキュメントの更新から始める
- 設計AI・実装AIはこのSSOTを最優先で参照する

---

## 0. 前提と役割整理

### ブランド三層構造

```
┌─────────────────────────────────────────┐
│ ミエルボード（MielBoard）                   │
│ 汎用ホワイトボードDX基盤                     │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│ ミエルボード for 現場                        │
│ 現場仕事（弱電・電気工事）向け業界パッケージ    │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│ ミエルボード（週間ボード）                  │
│ 「今週、誰がどこで何をしているか」を見せる     │
│ キラーモジュール                            │
└─────────────────────────────────────────┘
```

### 名称定義

| 名称 | 役割 | スコープ |
|------|------|---------|
| **ミエルボード** | 汎用ホワイトボードDX基盤 | 全業界対応可能 |
| **ミエルボード for 現場** | 現場仕事向けバーティカル版 | 弱電・電気工事・設備系 |
| **ミエルボード** | 週間スケジュールボードモジュール | Phase 0 の主力機能 |

---

## 1. プロジェクトのゴール（Phase 0）

### 1-1. ターゲット

**主要ペルソナ**: 株式会社サクシード（弱電SI・電気工事会社）

#### 企業特性
- 従業員規模: 10〜50名
- 業種: 弱電・AV・ネットワーク・会議室設備・ホテルシステム
- 対象施設: ビル／ホテル／商業施設

#### 現状の課題
- ✅ 週間スケジュールは **事務所のホワイトボードに手書き**
- ✅ 誰がどこにいるかを把握するのに：
  - ボード前まで見に行く
  - 電話／LINEで確認
- ✅ 個人予定はカレンダーにあるが、「全員の今週」が一目で見えない

---

### 1-2. Phase 0 のゴール

> **サクシード社の事務所のTVに、「今週、誰がどこで何をしているか」が一枚で見えるボードを実現する**

#### 達成条件

- [ ] 社員 × 曜日のマトリクスがTVに常時表示される
- [ ] 予定データは既存カレンダー（Google / Outlook）から自動取得
- [ ] 部門フィルタで「工事」「営業」「保守」を切り替えられる
- [ ] 週の切り替え（前週／今週／翌週）ができる
- [ ] 紙ホワイトボードの「パッと見て全員の動きが分かる」良さを維持

#### スコープ外（Phase 1以降）

- 入出荷スケジュール
- 在庫・資産管理
- アルコールチェック
- AIコンシェルジュ

※ ただし、設計上はこれらが後から乗ることを意識する

---

## 2. ミエルボード for 現場の構成イメージ

### 2-1. 将来的なモジュール構成（Phase 0 〜 Phase 2）

```
ミエルボード for 現場
├── ミエルボード（Phase 0）     ← 今ここ
│   └── 週間スケジュールボード
├── 現場STOCK（Phase 1）
│   ├── 入出荷スケジュール
│   └── 在庫・資産管理
├── 現場ALCOHOL（Phase 1）
│   └── アルコールチェック記録
└── 現場AI（Phase 2）
    └── 社内AIコンシェルジュ
```

### 2-2. 設計上の配慮

- **Phase 0** では「ミエルボード」のみ実装
- ただし、将来のモジュール追加を阻害しない設計：
  - `Schedule.metadata` を活用した拡張
  - API構造の一貫性
  - UI のタブ構造（将来追加可能）

---

## 3. ミエルボード（Phase 0）の機能スコープ

### 3-1. 週間ボードUI

#### 画面構成

**URL例**: `/org/[slug]/weekly-board` または `/org/[slug]/genba/weekly`

#### レイアウト

```
┌─────────────────────────────────────────────────────────────┐
│ ミエルボード - 週間スケジュールボード      [全員 ▼] [今週 ◀ ▶] │
├─────────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┤
│ 社員名   │ 月   │ 火   │ 水   │ 木   │ 金   │ 土   │ 日   │
├─────────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┤
│ 田中太郎 │ 9-18 │ 9-18 │ 9-18 │ 休み │ 9-18 │     │     │
│ (工事)   │ ◯◯   │ ◯◯   │ △△   │      │ ◯◯   │     │     │
│          │ ホテル│ ホテル│ 旅館  │      │ ホテル│     │     │
├─────────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┤
│ 佐藤花子 │ 10-16│ 9-18 │ 9-18 │ 9-18 │ 10-16│     │     │
│ (営業)   │ 打合せ│ ◯◯   │ ◯◯   │ ◯◯   │ 打合せ│     │     │
│          │      │ ホテル│ ホテル│ ホテル│      │     │     │
└─────────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┘
```

#### セル表示ルール

各セルには以下を表示：

1. **時間帯**: `9-18` / `10-16` など
2. **現場名**: `◯◯ホテル` / `△△旅館` など
3. **用件**: `工事` / `打合せ` / `保守` など

**表示例**:
- `9-18 ◯◯ホテル 新館工事`
- `10-16 △△旅館 打合せ`
- `休み`

#### 操作要素

| 要素 | 機能 |
|------|------|
| **部門フィルタ** | 全員／工事／営業／保守 |
| **週切り替え** | [前の週] [今週] [次の週] |
| **フルスクリーンモード** | サイネージ表示用 |

---

### 3-2. データ取得・整形

#### API仕様（例）

**エンドポイント**: `GET /api/schedules/weekly-board`

**リクエストパラメータ**:
```typescript
{
  organizationId: string;  // 組織ID（認証から自動取得）
  startDate: string;       // 週の開始日（YYYY-MM-DD）
  department?: string;     // 部門フィルタ（optional）
}
```

**レスポンス**:
```typescript
{
  weekStart: string;
  weekEnd: string;
  employees: [
    {
      id: string;
      name: string;
      department: string;
      schedules: {
        monday: { displayText: "9-18 ◯◯ホテル 工事", ... },
        tuesday: { displayText: "9-18 ◯◯ホテル 工事", ... },
        // ... 以下同様
      }
    }
  ]
}
```

---

#### データモデル

**既存 `Schedule` テーブルを使用（原則スキーマ変更禁止・例外あり）**

**拡張方法**: `Schedule.metadata` (Json) フィールドに追加情報を格納

```typescript
// Schedule.metadata の構造例
{
  siteName: "◯◯ホテル",        // 現場名
  activityType: "工事",        // 用件
  displayText: "9-18 ◯◯ホテル 新館配線"  // 表示用テキスト
}
```

---

#### 表示テキスト整形

**ユーティリティ**: `server/utils/scheduleFormatter.ts`

```typescript
export function formatScheduleForDisplay(schedule: Schedule): string {
  const start = formatTime(schedule.start);  // "9"
  const end = formatTime(schedule.end);      // "18"
  const siteName = schedule.metadata?.siteName || "";
  const activityType = schedule.metadata?.activityType || "";
  
  return `${start}-${end} ${siteName} ${activityType}`;
  // => "9-18 ◯◯ホテル 工事"
}
```

---

### 3-3. 入力フロー（Phase 0）

#### 第一候補: 外部カレンダー連携

- **Google Calendar** / **Outlook Calendar** からイベント取得
- 社員単位で接続設定
- 定期的に同期（例: 15分ごと）

#### 代替案: 簡易入力UI

- 管理者が管理画面から直接スケジュールを編集
- 最低限のフォーム（日付・時間・現場名・用件）

#### 将来: AIコンシェルジュ

- 自然文入力: 「木曜9〜18時で◯◯ホテルLAN工事入れて」
- → Schedule に自動登録
- ※ Phase 0 では実装しないが、API構造は差し込みやすく設計

---

## 4. アーキテクチャ・制約

### 4-1. 技術スタック

**既存ミエルボード基盤を踏襲**

| レイヤー | 技術 |
|---------|------|
| **フロントエンド** | Nuxt 3 + Vue 3 + TypeScript + Pinia |
| **スタイリング** | Tailwind CSS |
| **バックエンド** | Nuxt Server API (`server/api/`) |
| **データベース** | PostgreSQL + Prisma（**生SQL禁止**） |
| **リアルタイム** | Socket.IO |
| **インフラ** | ConoHa VPS + Nginx + Docker |
| **IaC** | Terraform |

---

### 4-2. マルチテナント

**方式**: 論理マルチテナント

#### 原則

- ✅ すべての業務データに `organizationId` を付与
- ✅ すべてのAPIで `organizationId` によるフィルタ必須
- ✅ `requireAuth()` でユーザー認証 + 組織ID取得

#### URL構造

```
/org/[slug]/...
```

- `slug` → DB経由で `organizationId` を解決
- 例: `/org/succeed/weekly-board`

#### テナント展開

- **サクシード社**: 最初のテナント
- **将来**: 他の弱電・電気工事会社へ横展開

---

### 4-3. 認証・権限（RBAC）

#### 認証方式

- **JWT + Cookie**
- ログイン時にJWT発行 → HttpOnly Cookie保持
- API では `requireAuth(event)` で検証

#### 権限レベル（1〜5）

| レベル | 役割 | 権限 |
|--------|------|------|
| **1-2** | 一般社員 | 自分の予定閲覧・一部編集 |
| **3-4** | リーダー／配車担当 | 部署メンバーの予定編集 |
| **5** | 管理者 | 組織設定・社員管理・表示設定 |
| **SuperAdmin** | 開発側 | 全テナント管理（プラン・課金） |

---

### 4-4. DB変更禁止ポリシー

#### 原則

- ❌ **`prisma/schema.prisma` の変更禁止**
- ❌ **マイグレーションファイルの作成禁止**
- ✅ **`Schedule.metadata` で拡張**

#### 理由

- スキーマ変更は全テナントに影響
- マイグレーション失敗リスク
- 既存データの整合性維持

#### 拡張が必要な場合

1. まず `metadata` で解決できないか検討
2. どうしても必要な場合は総監修レベルで判断
3. Phase 0 では原則として新テーブル追加なし

---

## 5. 開発体制・品質管理

このプロジェクトは **小さなSaaSチーム用の品質基盤** を前提に運用します。

### 5-1. ルールレイヤー（`.cursorrules`）

AIが守るべき開発ルール：

- ✅ スキーマ変更は原則禁止（例外: 管理AI承認 + 影響範囲修正が揃う場合のみ）
- ✅ マルチテナント分離必須
- ✅ 生SQL禁止（Prisma ORMのみ）
- ✅ `requireAuth()` 使用必須

---

### 5-2. ツールレイヤー（GitHub / CI）

#### CI/CD（`.github/workflows/ci.yml`）

- `lint-and-typecheck`: TypeScript型エラー検出
- `build`: ビルド検証
- `security`: `npm audit` / secret scan
- `ssot-compliance`: 禁止パターン検出

#### PRテンプレート（`.github/PULL_REQUEST_TEMPLATE.md`）

必須セクション：

- `## 参照SSOT`: このSSOTへのリンク
- `## テスト・証跡`: コマンド + ログ
- `## 禁止パターンチェック`: スキーマ変更なし等
- `## DoD`: 完了定義チェックリスト

---

### 5-3. 運用レイヤー（Docs）

| ドキュメント | 目的 |
|-------------|------|
| `docs/QUALITY_MANAGEMENT_OVERVIEW.md` | 品質管理の全体像 |
| `docs/TEST_STRATEGY.md` | テストを書くべき層の明示 |
| `docs/BRANCH_AND_RELEASE.md` | ブランチ戦略・リリースフロー |
| `docs/DONE_DEFINITION.md` | 完了の定義 |

---

### 5-4. 設計AIへの重要ポイント

#### 新しい仕様・設計を提案するときは：

1. ✅ このSSOTとの整合性を確認
2. ✅ 品質管理ドキュメントとの整合性を確認
3. ✅ スキーマ変更が発生しないか確認
4. ✅ マルチテナント境界が曖昧になっていないか確認
5. ✅ テスト戦略上「必須テスト対象」かどうか判断

#### ルール抵触の可能性がある場合：

- 代替案・妥協案もあわせて提案
- 「なぜそのルールがあるのか」を理解した上で判断

---

## 6. Phase 0 の主要コンポーネント・API

### 6-1. 新規作成予定のファイル

#### フロントエンド

| ファイル | 役割 |
|---------|------|
| `components/genba/WeeklyScheduleBoard.vue` | 週間ボードマトリクス表示 |
| `pages/org/[slug]/weekly-board.vue` | 週間ボードページ |
| `composables/useWeeklyBoard.ts` | 週間ボード用の状態管理 |

#### バックエンド

| ファイル | 役割 |
|---------|------|
| `server/api/schedules/weekly-board.get.ts` | 週間ボード用データ取得API |
| `server/utils/scheduleFormatter.ts` | スケジュール表示テキスト整形 |

---

### 6-2. 既存コンポーネントの再利用

| コンポーネント | 用途 |
|---------------|------|
| `WeeklyCalendar.vue` | 参考実装（カレンダー表示） |
| `EmployeeScheduleMatrix.vue` | 参考実装（社員×日付マトリクス） |

---

## 7. 今後の拡張（Phase 1 以降）

### 7-1. Phase 1: 入出荷・在庫

**新モジュール**: 現場STOCK

- 入出荷スケジュール（Shipment）
- 在庫・資産管理（Asset / Inventory）
- `Schedule` と結びつけて「この現場にこの資材を持っていく」を管理

---

### 7-2. Phase 2: アルコールチェック・車両管理

**新モジュール**: 現場ALCOHOL

- 車両・ドライバー・スケジュールの紐付け
- アルコールチェック記録（AlcoholCheck）

---

### 7-3. Phase 3: 社内AIコンシェルジュ

**新モジュール**: 現場AI

- 自然文での予定登録
- 横断検索（「今週◯◯ホテルに入っている現場全部出して」）
- RAGベースの社内情報QA

---

## 8. 設計AI向けタスク

以下を設計AIに依頼します：

### 8-1. SSOT維持

- ✅ このドキュメント（`SSOT_GENBA_WEEK.md`）を常に最新に保つ
- ✅ 仕様変更があれば、まずこのSSOTを更新

### 8-2. Phase 0 仕様のブラッシュアップ

- ✅ `docs/phase0_weak_current_spec.md` の作成
  - 名称を「ミエルボード for 現場」「ミエルボード」に統一
  - 用語を弱電・電気工事寄りにチューニング
  - 画面・API・データの対応関係を図や表で整理

### 8-3. 品質ルールを前提にした設計チェック

新しい提案時に毎回チェック：

- [ ] スキーマ変更が発生しないか
- [ ] マルチテナント境界が曖昧になっていないか
- [ ] テスト戦略上「必須テスト対象」かどうか
- [ ] ルール抵触があれば代替案を提示

---

## 🔗 関連ドキュメント

### 基本SSOT
- **本ドキュメント** - ミエルボード for 現場 / ミエルボード の設計SSOT

### 詳細仕様
- `docs/phase0_weak_current_spec.md` - Phase 0 詳細仕様
- `docs/phase0_architecture.md` - アーキテクチャ設計
- `docs/UI_ROUTING_MAP.md` - UI・ルーティング設計（URL一覧・遷移図）

### 品質管理
- `docs/QUALITY_MANAGEMENT_OVERVIEW.md` - 品質管理の全体像
- `docs/TEST_STRATEGY.md` - テスト戦略
- `docs/BRANCH_AND_RELEASE.md` - ブランチ戦略
- `docs/DONE_DEFINITION.md` - 完了の定義

### AI制御
- `.cursorrules` - AI駆動開発ルール

---

**このSSOTは、「ミエルボード for 現場」プロジェクトにおける設計・実装の唯一の正です。**





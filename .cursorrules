# ミエルボード for 現場 / ミエルボード - Cursor AI ルール

このプロジェクトは AI駆動開発を前提としています。
以下のルールを厳守し、品質・セキュリティ・保守性を担保してください。

---

## 🔀 ツール境界ルール（4ツール体制 v3.3）

本プロジェクトでは以下の4ツールを併用します。
各ツールは**別のシェルプロセス**で動作するため、
**「編集した側が commit + push まで完了する」**ことを基本原則とします。

| ツール | 用途 | 制約 |
|--------|------|------|
| **Claude.ai** | 思考・設計・壁打ち | コード実行不可 |
| **Claude Code CLI** | 対話型の実装・デバッグ・環境構築 | ターミナル閉じると停止 |
| **Claude Code Web** | 仕様確定済みタスクの非同期実行 | PCを閉じても継続、完了時に自動PR作成 |
| **Cursor** | IDE補助（コード編集、Lint確認、ブラウザ確認） | エディタ上の操作 |

### Cursor の責務

| カテゴリ | 操作例 |
|---------|--------|
| **コード編集** | 新規実装、バグ修正、リファクタリング |
| **ドキュメント編集** | SSOT・仕様書の作成・更新 |
| **設計・相談** | アーキテクチャ設計、技術選定の議論 |
| **UI 開発** | コンポーネント実装、スタイル調整 |
| **テストコード作成** | テストファイルの作成・編集 |
| **コードレビュー** | diff の確認、変更のレビュー |
| **ブラウザ確認** | 画面の動作確認、UI 検証（Playwright MCP） |
| **Lint / 型エラー確認** | エディタ上でのリアルタイム確認 |
| **変更の確定** | 編集した変更の `git add` + `git commit` + `git push` |

### Claude Code CLI / Web の責務

| カテゴリ | CLI | Web |
|---------|-----|-----|
| **ビルド・検証** | `typecheck`, `test`, `build` | 同左 |
| **DB 操作** | `prisma migrate dev/reset/seed` | 同左 |
| **パッケージ管理** | `npm ci`, `npm install` | 同左 |
| **Git 操作（高度）** | `merge`, `rebase`, `tag` | 自動PR作成 |
| **スクリプト実行** | `./scripts/backup-db.sh` 等 | 同左 |
| **CI/CD 確認** | `gh run list`, `gh pr status` | 同左 |
| **環境構築** | Docker, サーバー起動 | 同左 |
| **機能実装（非同期）** | 対話型 | **仕様確定済み → 非同期実行** |
| **テスト生成** | 対話型 | **一括生成** |
| **複数タスク並列** | 不可 | **並列実行OK** |

### 連携フロー（典型パターン）

```
1. Claude.ai: 仕様の壁打ち・設計判断
2. Cursor: コード実装・テストコード作成 → git commit + git push
3. Claude Code CLI: git pull → typecheck && test
4. テスト失敗時:
   4a. Cursor: コード修正 → git commit + git push
   4b. Claude Code CLI: git pull → 再テスト
5. 仕様確定済みタスク → Claude Code Web に並列送信
   & "SSOT_*.md を読んでXXX機能を実装して"
   → 完了後に自動PR → レビュー → マージ
```

### 判断基準（迷った場合）

```
Q: ファイルの中身を編集する？         → Cursor（commit + push まで完了）
Q: コードの設計・構造を考える？       → Claude.ai or Cursor
Q: ビルド・テスト実行が必要？         → Claude Code CLI
Q: DB マイグレーションが必要？        → Claude Code CLI
Q: 仕様確定済みの実装タスク？         → Claude Code Web（非同期）
Q: 複数タスクを並列に進めたい？       → Claude Code Web
Q: エラーの原因をコードから調査？     → Cursor or Claude Code CLI
```

### 禁止事項

- **ローカルコミットのまま相手に引き継ぐ**ことを禁止（必ず push → pull で同期）
- **Claude Code CLI / Web でのコード設計判断**を避ける（実行に徹し、判断は Claude.ai / Cursor 側）
- **Cursor での重いシェルコマンド実行**を避ける（migrate reset, npm ci 等）
  - 例外: `git commit`, `git push`, 軽量な確認コマンド（`git status` 等）は許可

---

## 📍 現在のPhase: Phase 1

### Phase 1 運用ルール
- main直接push: ❌ 禁止（PR必須）
- PR/レビュー: 必須
- CI通過必須（typecheck, test, build）
- ブランチ保護: 有効

### ✅ Phase 1 移行完了チェックリスト
- [x] GitHub main ブランチ保護を設定
- [x] この「現在のPhase」を更新
- [ ] CI/CD が正常動作することを確認

---

## 🚨 禁止操作（CI違反で自動拒否）

以下の操作は **CIで自動検出** され、PRがブロックされます。
ガードレールより厳格な「絶対禁止」です。

### 禁止1: 生SQL DDL/DML

```typescript
// ❌ 禁止（CIで検出 → PR拒否）
await prisma.$queryRaw`CREATE TABLE ...`
await prisma.$executeRaw`ALTER TABLE ...`
await prisma.$executeRaw`INSERT INTO ...`

// ✅ 許可
await prisma.user.create({ data: { ... } })
await prisma.schedule.findMany({ where: { ... } })
```

**検出パターン**: `$queryRaw` / `$executeRaw`  
**例外**: なし

---

### 禁止2: マイグレーションファイルの改ざん

```bash
# ❌ 禁止（CIで検出 → PR拒否）
prisma/migrations/20240101_init/migration.sql を編集

# ✅ 許可
prisma migrate dev --name add_new_table  # 新規マイグレーション作成
```

**検出**: 既存 `migration.sql` ファイルの変更  
**理由**: マイグレーション履歴の改ざんはDB不整合の原因

---

### 禁止3: スキーマ変更時のマイグレーション漏れ

```bash
# ❌ 禁止（CI警告）
schema.prisma を変更して、migration.sql を作成しない

# ✅ 必須手順
1. prisma/schema.prisma を編集
2. npx prisma migrate dev --name <変更内容>
3. 生成されたマイグレーションをコミット
```

**検出**: `schema.prisma` 変更あり + `migration.sql` 追加なし

---

## 🛡️ AI駆動開発ガードレール

### 1. データベース整合性（最重要）

**原則**: PrismaスキーマとDBは常に一致させる

#### ❌ 絶対禁止
- **生SQLでのDDL操作**
  - CREATE TABLE / ALTER TABLE / DROP TABLE
  - CREATE INDEX / DROP INDEX
  - その他スキーマ変更SQL
- **Prismaを経由しないDB変更**
  - psql / pgAdmin 等での直接DDL実行
  - マイグレーションファイルの手動編集・削除
- **prisma.$queryRaw / $executeRaw でのDDL/DML**
  - DDL（スキーマ変更）: 完全禁止
  - DML（INSERT/UPDATE/DELETE）: 禁止（Prisma ORM使用）
  - SELECT: 例外的に許可（Prismaで表現できない複雑なクエリのみ）

#### ✅ 必須手順（スキーマ変更時）
1. `prisma/schema.prisma` を編集
2. `npx prisma migrate dev --name <変更内容>` を実行
3. 生成されたマイグレーションファイルをコミット
4. Prisma Clientを再生成（`npx prisma generate`）
5. `prisma/seed.ts` を必要に応じて更新

#### ✅ 許可される操作
- Prisma ORMを経由したCRUD操作
- `prisma migrate dev` によるスキーマ変更
- `prisma db seed` によるシードデータ投入
- `prisma migrate status` による状態確認

---

### 2. マルチテナント整合性

#### ❌ 絶対禁止
- organizationId なしのクエリ
- organizationId ?? 'default' のようなフォールバック
- 他テナントのデータへのアクセス

#### ✅ 必須
- すべてのAPIで `requireAuth()` を使用
- すべてのクエリで `organizationId` でフィルタ

---

### 3. コード整合性

#### ❌ 禁止
- 型定義を変更せずに実装だけ変更
- SSOTを更新せずに仕様変更
- APIレスポンス形式を変更してフロントエンド未更新

#### ✅ 必須
- 変更は「定義 → 実装」の順
- 型変更時は影響範囲を確認
- SSOT変更時は実装検証を実施

---

### 4. プロジェクト管理整合性

#### ❌ 禁止
- 実装完了後のPlane更新忘れ
- 複数Issueを1コミットに混在
- コミットせずに長時間作業

#### ✅ 必須
- 1 Issue = 1 Branch = 1 PR（理想）
- 実装完了時は必ずPlane更新
- 小さく頻繁にコミット

---

### 5. 環境整合性

#### ❌ 禁止
- .envを直接編集して共有しない変更
- ローカル依存パッケージの追加（package.json未更新）
- 環境固有の設定をハードコード

#### ✅ 必須
- 環境変更はREADME/ドキュメント更新
- 新規環境変数は `.env.example` にも追加
- `npm ci` で依存関係を再現可能に

---

### 6. AI行動規範

#### ❌ 禁止
- ファイル存在を確認せずに編集
- 破壊的操作を承認なしに実行
- 推測で動作（不明点は確認）

#### ✅ 必須
- 編集前に `read_file` / `ls` で確認
- 削除・上書きは事前に報告
- 不明点は推測せず質問

---

## 🚫 従来の絶対禁止事項（継続）

### マルチテナント
- ❌ organizationId なしのクエリ
- ❌ organizationId ?? 'default' のようなフォールバック
- ✅ すべてのAPIで requireAuth() を使用し、organizationId でフィルタ

### SQL・ORM
- ❌ 生SQLクエリ（prisma.$queryRaw 等でのDDL/DML禁止）
- ✅ Prisma ORMのみ使用

詳細は docs/QUALITY_MANAGEMENT_OVERVIEW.md を参照してください。

---

## 📖 参照ドキュメント

- フレームワーク標準: `docs/standards/`
- ツールチェーン定義: `docs/standards/09_TOOLCHAIN.md`
- ビジュアルテスト: `docs/standards/20_VISUAL_TEST.md`
- 品質管理概要: `docs/QUALITY_MANAGEMENT_OVERVIEW.md`

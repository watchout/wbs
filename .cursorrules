# ミエルボード for 現場 / 現場WEEK - Cursor AI ルール

このプロジェクトは AI駆動開発を前提としています。
以下のルールを厳守し、品質・セキュリティ・保守性を担保してください。

## 🚫 絶対禁止事項

### データベース
- ❌ DBスキーマの変更（prisma/schema.prisma の修正禁止）
- ❌ マイグレーションファイルの作成・実行
- ✅ 拡張は Schedule.metadata (Json) フィールドで実現

### マルチテナント
- ❌ organizationId なしのクエリ
- ❌ organizationId ?? 'default' のようなフォールバック
- ✅ すべてのAPIで requireAuth() を使用し、organizationId でフィルタ

### SQL・ORM
- ❌ 生SQLクエリ（prisma.$queryRaw 等の使用禁止）
- ✅ Prisma ORMのみ使用

詳細は docs/QUALITY_MANAGEMENT_OVERVIEW.md を参照してください。

---

## 🏷️ タグ方式コマンド（ワークフロー起動）

このプロジェクトでは、**会話ベースの開発フローに「軽量コマンド」を埋め込む**ことで、一貫したインターフェースで作業を進めます。

### 基本コンセプト

- **先頭に `>>` を付けたタグコマンド**で、AIの挙動モード（仕様作成／実装／修正など）を明示
- タグなし = 通常の設計ディスカッション・質問
- タグあり = 機械的ワークフローを起動

---

### `>> write` - SSOT新規作成

**用途**: 新しいSSOTドキュメントを作成

**入力例**:
```
>> write SSOT_GENBA_STOCK
```

**振る舞い**:
1. 既存SSOT（`docs/SSOT_GENBA_WEEK.md`）と実装コードを調査
2. SSOTテンプレートに沿って新規ドキュメントを作成
3. 品質チェックリスト（必要なら参照）でセルフレビュー
4. 作成後、`docs/INDEX_WEAK_CURRENT.md` に追記

**制約**:
- スキーマ変更禁止・マルチテナント原則を前提
- 既存SSOTとの整合性を必ず確認

---

### `>> impl` - SSOT実装

**用途**: SSOTに基づいて実装を行う

**入力例**:
```
>> impl SSOT_GENBA_WEEK
```

**振る舞い**:
1. 該当SSOTを読み込み、要件IDを抽出
2. 既存実装の有無をスキャン（`server/api/`, `components/` など）
3. 実装プラン（Item/Step）を提示 → **ユーザー承認必須**
4. 承認後、SSOT準拠の実装を行う
5. テスト作成（`docs/TEST_STRATEGY.md` 参照）
6. Plane Issue を更新（可能なら）

**制約**:
- 実装前に必ずSSOTを**最後まで読む**
- `requireAuth()` / `organizationId` フィルタ必須
- 生SQL禁止
- 実装完了までユーザー承認なしに進めない

---

### `>> fix` - バグ修正

**用途**: SSOT準拠の観点からバグを修正

**入力例**:
```
>> fix SSOT_GENBA_WEEK スケジュール削除エラー
```

**振る舞い**:
1. 該当SSOTと現行実装を突き合わせ
2. 「どこがSSOTと矛盾しているか」を整理
3. 原因調査（15分以内に特定できない場合は停止して報告）
4. 修正方針を提案 → **ユーザー承認必須**
5. 承認後、修正実施
6. テスト実行・Evidence提出

**制約**:
- Implementation Halt Protocol を前提
- 「闇雲に直す」のを防ぐため、必ず原因特定してから修正

---

### `>> rfv` - SSOT実装検証（Review）

**用途**: SSOTと実装のカバレッジ・ギャップを可視化

**入力例**:
```
>> rfv SSOT_GENBA_WEEK
```

**振る舞い**:
1. SSOTに定義された要件IDとコード・挙動を突き合わせ
2. **カバレッジ**（どこまで実装済み）と**ギャップ**（どこが未実装）を可視化
3. レポートを生成（`reports/` または チャット内）

**重要**:
- このタグは「仕様 vs 実装の差分」確認用
- **進捗の正はあくまで Plane**（このタグの結果を進捗根拠にしない）

---

### `>> next` - 次タスク選定

**用途**: Planeから次に着手すべきIssueを選定

**入力例**:
```
>> next
```

**振る舞い**:
1. `scripts/plane-lib/list-issues.cjs` 実行（Plane API経由）
2. 依存関係・Phase・優先度を分析
3. 「今着手すべき Issue」を提案
4. **ユーザー承認後**、Issueを "In Progress" に更新

**制約**:
- AIが勝手にタスクを選ばない
- Planeの状態に沿ったロードマップ運用を強制

---

### `>> prmt` - プロンプト生成

**用途**: 実装AI向けの詳細プロンプトを生成

**入力例**:
```
>> prmt WBS-12
```

**振る舞い**:
1. Plane から対象 Issue の詳細を取得
2. 関連するSSOT / ガードレール / 標準テンプレートを読み込み
3. 実装AI用の詳細プロンプト（Item/Step構造・Evidence要件・停止トリガーなどを含む）を**チャット内にだけ**生成
4. **プロンプトはファイル保存せず**、コピペ運用

**制約**:
- プロンプトを `docs/` に保存しない（Docs化禁止）
- 一時的な作業指示であり、SSOTとは別レイヤー

---

## 🔄 タグ方式の運用ルール

### 1. タグは「フェーズ切り替えスイッチ」

- **仕様作成フェーズ** → `>> write`
- **仕様実装フェーズ** → `>> impl`
- **バグ修正フェーズ** → `>> fix`
- **検証フェーズ** → `>> rfv`
- **タスク選定フェーズ** → `>> next`
- **プロンプト生成フェーズ** → `>> prmt`

### 2. タグごとに「標準フロー」が決まっている

- `>> write`: 調査 → SSOTドラフト → 品質チェック
- `>> impl`: SSOT読了 → 既存実装スキャン → 実装プラン → 承認 → 実装 → テスト
- `>> fix`: SSOT照合 → 原因調査 → 修正方針 → 承認 → 修正 → テスト
- `>> rfv`: SSOT読了 → コードスキャン → カバレッジレポート
- `>> next`: Plane問い合わせ → 候補提示 → ユーザー合意 → Issue更新
- `>> prmt`: Plane取得 → SSOT読了 → プロンプト生成

### 3. 進捗の正は Plane

- `>> next` / `>> prmt` / `>> impl` など、進捗やスコープ判断が必要なタグは、必ず Plane API 経由で Issue 状態を取得
- **SSOT内の「実装状況」テキストは進捗根拠に使わない**

### 4. 通常会話との分離

- **タグなし**: 自由なディスカッション、設計相談、質問
- **`>>` 付き**: 機械的ワークフローを起動する合図

---

詳細は `docs/TAG_COMMANDS.md` を参照してください。

name: CI

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

jobs:
  lint-and-typecheck:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: package-lock.json
      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit --fund=false
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/wbs?schema=public
      - name: Lint
        run: npm run lint 2>/dev/null || echo "lint script not configured"
      - name: Type Check
        run: npm run typecheck 2>/dev/null || echo "typecheck script not configured"

  build:
    name: Build Verification
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: package-lock.json
      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit --fund=false
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/wbs?schema=public
      - name: Build
        run: npm run build
        env:
          NODE_ENV: production

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: package-lock.json
      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit --fund=false
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/wbs?schema=public
      - name: Security Audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

  forbidden-operations:
    name: 🚨 Forbidden Operations Check
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check for forbidden patterns
        run: |
          echo "🔍 禁止操作チェック中..."
          ERRORS=0
          
          # ============================================
          # 禁止操作1: 生SQL DDL/DML ($queryRaw / $executeRaw)
          # ============================================
          echo ""
          echo "📌 チェック1: 生SQL使用"
          
          # server/ 配下をチェック（ci.yml自体は除外）
          RAW_SQL_FILES=$(grep -rln '\$queryRaw\|\$executeRaw' server/ --include="*.ts" 2>/dev/null || true)
          
          if [ -n "$RAW_SQL_FILES" ]; then
            echo "❌ 禁止: \$queryRaw / \$executeRaw の使用が検出されました"
            echo "$RAW_SQL_FILES"
            grep -rn '\$queryRaw\|\$executeRaw' server/ --include="*.ts" || true
            ERRORS=$((ERRORS + 1))
          else
            echo "✅ 生SQL使用なし"
          fi
          
          # ============================================
          # 禁止操作2: マイグレーションファイルの手動編集
          # ============================================
          echo ""
          echo "📌 チェック2: マイグレーションファイル改ざん"
          
          # 既存のマイグレーションファイルが変更されていないかチェック
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            MODIFIED_MIGRATIONS=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep 'prisma/migrations/.*/migration.sql' || true)
            
            if [ -n "$MODIFIED_MIGRATIONS" ]; then
              # 新規追加は許可、既存変更は禁止
              for file in $MODIFIED_MIGRATIONS; do
                if git show origin/${{ github.base_ref }}:$file > /dev/null 2>&1; then
                  echo "❌ 禁止: 既存マイグレーションファイルの変更"
                  echo "  $file"
                  ERRORS=$((ERRORS + 1))
                fi
              done
            fi
          fi
          
          if [ $ERRORS -eq 0 ]; then
            echo "✅ マイグレーション改ざんなし"
          fi
          
          # ============================================
          # 禁止操作3: スキーマ変更時のマイグレーション必須
          # ============================================
          echo ""
          echo "📌 チェック3: スキーマ変更とマイグレーションの整合性"
          
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            SCHEMA_CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep 'prisma/schema.prisma' || true)
            MIGRATION_ADDED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep 'prisma/migrations/.*/migration.sql' || true)
            
            if [ -n "$SCHEMA_CHANGED" ] && [ -z "$MIGRATION_ADDED" ]; then
              echo "⚠️ 警告: スキーマ変更がありますが、マイグレーションがありません"
              echo "  → prisma migrate dev を実行してマイグレーションを作成してください"
              # 警告のみ（コメント修正等もあるため）
            else
              echo "✅ スキーマとマイグレーションの整合性OK"
            fi
          fi
          
          # ============================================
          # 結果
          # ============================================
          echo ""
          echo "================================"
          if [ $ERRORS -gt 0 ]; then
            echo "❌ 禁止操作チェック: $ERRORS 件の違反"
            exit 1
          else
            echo "✅ 禁止操作チェック: 合格"
          fi

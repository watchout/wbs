// prisma/schema.prisma  v0.1  (20250519)
// -------------------------------------------
// NOTE: datasource & generator blocks are kept minimal; adjust
//       according to your local DB connection in dev.
// -------------------------------------------

datasource db {
  provider = "postgresql"   // dev uses sqlite:"file:./dev.db"; set via env var
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ------------ ENUMS ------------

enum Role {
  ADMIN
  LEADER     // 部署リーダー/配車担当
  MEMBER
  DEVICE     // kiosk 
}

enum Source {
  INTERNAL
  GOOGLE
  CSV
}

// ------------ MODELS ------------

model Organization {
  id          String   @id @default(uuid())
  name        String
  timezone    String   @default("Asia/Tokyo")

  users       User[]
  devices     Device[]
  schedules   Schedule[]
  auditLogs   AuditLog[]
  departments Department[]
  meetingRequests MeetingRequest[]
  calendarConnections UserCalendarConnection[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([name])
}

model Department {
  id             String   @id @default(uuid())
  organization   Organization @relation(fields: [organizationId], references: [id])
  organizationId String

  name           String
  color          String?  // 表示色（Tailwind color key）
  sortOrder      Int      @default(0)

  users          User[]

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  deletedAt      DateTime?  // ソフトデリート

  @@unique([organizationId, name])
  @@index([organizationId])
}

model User {
  id             String   @id @default(uuid())
  organization   Organization @relation(fields: [organizationId], references: [id])
  organizationId String

  email          String   @unique
  name           String?
  passwordHash      String?
  setupToken        String?
  setupTokenExpiry  DateTime?
  role           Role     @default(MEMBER)

  // 部署
  department     Department? @relation(fields: [departmentId], references: [id])
  departmentId   String?

  // OAuth2 (Google) credential reference (legacy - to be removed)
  calendars      CalendarOAuth[]
  // Calendar sync connections (new - with multi-tenant support)
  calendarConnections UserCalendarConnection[]

  schedulesAuthored Schedule[]   @relation("author")
  auditLogs      AuditLog[]

  // 日程調整関連
  meetingsOrganized MeetingRequest[] @relation("meetingOrganizer")
  meetingInvitations MeetingInvitee[] @relation("meetingInvitee")

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  deletedAt      DateTime?  // ソフトデリート

  @@index([organizationId, role])
  @@index([departmentId])
}

model CalendarOAuth {
  id             String   @id @default(uuid())
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String

  provider       String   @default("google")
  accessToken    String   @db.VarChar(2048)  //
  refreshToken   String   @db.VarChar(2048)
  expiry         DateTime?

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([userId, provider])
}

// ------------ カレンダー同期モデル ------------

model UserCalendarConnection {
  id             String   @id @default(uuid())
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String
  organization   Organization @relation(fields: [organizationId], references: [id])
  organizationId String

  provider       String   @default("google")  // "google"
  accessToken    String   @db.Text  // 暗号化保存
  refreshToken   String   @db.Text  // 暗号化保存
  tokenExpiresAt DateTime

  calendarId     String   @default("primary")
  webhookChannelId  String?
  webhookToken      String?  // Webhook検証用トークン
  webhookExpiration DateTime?

  syncRangeStart Int      @default(-7)   // 過去7日
  syncRangeEnd   Int      @default(28)   // 未来28日
  lastSyncedAt   DateTime?

  status         String   @default("active")  // active / error / disconnected

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([userId, provider])
  @@index([organizationId])
  @@index([webhookChannelId])
}

model Device {
  id             String   @id @default(uuid())
  organization   Organization @relation(fields: [organizationId], references: [id])
  organizationId String

  name           String
  kioskSecret    String   @unique
  language       String   @default("ja")
  lastHeartbeat  DateTime?

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([organizationId])
}

model Schedule {
  id             String   @id @default(uuid())
  organization   Organization @relation(fields: [organizationId], references: [id])
  organizationId String

  author         User?    @relation("author", fields: [authorId], references: [id])
  authorId       String?

  title          String
  description    String?
  start          DateTime
  end            DateTime
  color          String?      // Tailwind color key  e.g. "wasabi"
  source         Source       @default(INTERNAL)

  // 外部カレンダー同期用フィールド
  externalId        String?   // Googleカレンダーのevent.id
  externalSource    String?   // "google"
  externalUpdatedAt DateTime? // 外部での最終更新日時（無限ループ防止用）

  versions       ScheduleVersion[]

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  deletedAt      DateTime?  // ソフトデリート

  @@index([organizationId, start])
  @@index([externalId, externalSource])
}

model ScheduleVersion {
  id          String   @id @default(uuid())
  schedule    Schedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  scheduleId  String

  diffJson    Json      // before/after  JSON 
  version     Int       @default(1)
  createdAt   DateTime  @default(now())

  @@unique([scheduleId, version])
}

model AuditLog {
  id             String   @id @default(uuid())

  organization   Organization @relation(fields: [organizationId], references: [id])
  organizationId String

  user           User?    @relation(fields: [userId], references: [id])
  userId         String?

  action         String   // e.g. "SCHEDULE_CREATE"
  targetId       String?  // id of entity affected
  meta           Json?

  createdAt      DateTime @default(now())

  @@index([organizationId, createdAt])
}

// ------------ AI日程調整モデル ------------

enum MeetingRequestStatus {
  DRAFT         // 下書き
  OPEN          // 回答受付中
  CONFIRMED     // 日程確定
  CANCELLED     // キャンセル
}

enum InviteeResponseStatus {
  PENDING       // 未回答
  RESPONDED     // 回答済み
}

model MeetingRequest {
  id             String   @id @default(uuid())
  organization   Organization @relation(fields: [organizationId], references: [id])
  organizationId String

  // 作成者
  organizer      User     @relation("meetingOrganizer", fields: [organizerId], references: [id])
  organizerId    String

  title          String
  description    String?
  duration       Int      // ミーティング時間（分）
  
  // 候補日時の範囲
  dateRangeStart DateTime
  dateRangeEnd   DateTime
  
  // 調整ステータス
  status         MeetingRequestStatus @default(DRAFT)
  
  // 確定した日程（status=CONFIRMED時）
  confirmedStart DateTime?
  confirmedEnd   DateTime?
  
  // 関連データ
  candidates     MeetingCandidate[]
  invitees       MeetingInvitee[]

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  deletedAt      DateTime?

  @@index([organizationId, status])
  @@index([organizerId])
}

model MeetingCandidate {
  id               String   @id @default(uuid())
  meetingRequest   MeetingRequest @relation(fields: [meetingRequestId], references: [id], onDelete: Cascade)
  meetingRequestId String

  start            DateTime
  end              DateTime
  
  // AI提案かユーザー追加か
  isAiSuggested    Boolean  @default(false)
  
  // この候補を選択した招待者数（キャッシュ）
  responseCount    Int      @default(0)

  createdAt        DateTime @default(now())

  @@index([meetingRequestId])
}

model MeetingInvitee {
  id               String   @id @default(uuid())
  meetingRequest   MeetingRequest @relation(fields: [meetingRequestId], references: [id], onDelete: Cascade)
  meetingRequestId String

  // 招待者（社内ユーザー）
  user             User     @relation("meetingInvitee", fields: [userId], references: [id])
  userId           String

  // 回答状況
  status           InviteeResponseStatus @default(PENDING)
  
  // 選択した候補日時のID（JSON配列）
  selectedCandidateIds Json?  // ["uuid1", "uuid2"]
  
  // 回答日時
  respondedAt      DateTime?

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([meetingRequestId, userId])
  @@index([meetingRequestId])
  @@index([userId])
}

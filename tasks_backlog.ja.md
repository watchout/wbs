# タスクバックログ

以下は [functional_spec.ja.md](docs/functional_spec.ja.md) を基にしたタスクリストです。

| ID | タスク |
|----|-------|
| T1 | WebSocket(Socket.IO) による1秒未満(P95)のルーム同期を実装する |
| T2 | インクリメンタル同期とWebhookを用いたGoogleカレンダー双方向連携 |
| T3 | PWA化とIndexedDBキャッシュ(24h)によるオフラインキオスク対応 |
| T4 | 日本語・英語・ベトナム語・簡体字中国語・タガログ語・ネパール語・ブラジルポルトガル語対応UI |
| T5 | OAuth2とMagicLink認証で`ADMIN` `MEMBER` `DEVICE`ロールのRBAC |
| T6 | ConoHa用TerraformでVPSとロードバランサをコード化 |
| T7 | GitHub ActionsでDockerビルドしSSHデプロイ、Watchtowerで更新管理 |
| T8 | Nginx LB経由で複数NuxtからPostgreSQLへ接続しWALをオブジェクトストレージ保存 |
| T9 | クローンから`pnpm dev`までの開発手順を文書化 |
| T10 | Node20、pnpm、Docker24、Terraform1.7の前提条件確認 |
| T11 | `pnpm dev` `pnpm build` 等のプロジェクトスクリプト整備 |
| T12 | NuxtとPostgresを含むdocker-compose環境を提供 |
| T13 | `infra`のTerraformと`scripts/bootstrap_vps.sh`を使ったデプロイフロー |
| T14 | `DATABASE_URL`等の環境変数一覧を提示 |
| T15 | Vitest90%・Playwright・k6・Lighthouseの品質ゲート設定 |
| T16 | Conventional Commitsと`pnpm lint && pnpm test`必須の貢献ガイドライン |
| T17 | MITライセンス表記 © 2025 watchout |

## 詳細タスク
### T1 リアルタイム同期
- **T1-a Socket.IOサーバー設定**
  1. **T1-a-1** Socket.IOを導入し基本サーバーを作成
  2. **T1-a-2** CORSと接続ミドルウェアを設定
  3. **T1-a-3** 接続・切断ログを追加
  4. **T1-a-4** 起動コマンドを記載
- **T1-b イベント定義**
  1. **T1-b-1** join/leave/updateイベント名を決める
  2. **T1-b-2** ペイロードスキーマを整備
  3. **T1-b-3** ハンドラを実装
  4. **T1-b-4** 受信データを検証
- **T1-c 再接続処理**
  1. **T1-c-1** 自動再接続を実装
  2. **T1-c-2** 再接続中のイベントバッファリング
  3. **T1-c-3** エラー処理を追加
  4. **T1-c-4** テストを作成
- **T1-d Redis Adapter導入**
  1. **T1-d-1** redis-adapterパッケージを追加
  2. **T1-d-2** 環境変数を設定
  3. **T1-d-3** 複数インスタンスでのブロードキャスト確認
  4. **T1-d-4** レイテンシ測定
- **T1-e パフォーマンス計測**
  1. **T1-e-1** メトリクス取得を実装
  2. **T1-e-2** P95計測用ロードテスト
  3. **T1-e-3** シリアライズ最適化
  4. **T1-e-4** 結果を文書化

### T2 Googleカレンダー連携
- **T2-a OAuth設定**
  1. **T2-a-1** GoogleでクライアントID/Secretを取得
  2. **T2-a-2** 認可リダイレクト処理を実装
  3. **T2-a-3** リフレッシュトークンを安全に保存
  4. **T2-a-4** トークン更新処理を追加
- **T2-b インクリメンタル同期**
  1. **T2-b-1** ユーザーごとにSyncトークンを保存
  2. **T2-b-2** 定期同期ジョブを実装
  3. **T2-b-3** DBへイベント更新
  4. **T2-b-4** トークン更新処理
- **T2-c Webhook受信**
  1. **T2-c-1** 更新通知受信用エンドポイント公開
  2. **T2-c-2** 署名検証を行う
  3. **T2-c-3** 更新イベントをキューへ登録
  4. **T2-c-4** 通知にACK
- **T2-d 衝突解決**
  1. **T2-d-1** 双方向の変更を検知
  2. **T2-d-2** マージ戦略を適用
  3. **T2-d-3** 衝突ログを残す
  4. **T2-d-4** テストを追加

### T3 オフラインキオスク
- **T3-a PWAマニフェスト**
  1. **T3-a-1** マニフェストとアイコン作成
  2. **T3-a-2** Service Worker登録
  3. **T3-a-3** オフラインキャッシュを確認
  4. **T3-a-4** インストールテスト
- **T3-b IndexedDBキャッシュ**
  1. **T3-b-1** キャッシュ用スキーマ定義
  2. **T3-b-2** 取得と保存処理実装
  3. **T3-b-3** 24時間後に削除
  4. **T3-b-4** 失効時のフォールバック
- **T3-c オフラインキュー**
  1. **T3-c-1** オフライン時の操作をバッファ
  2. **T3-c-2** IndexedDBにキュー保存
  3. **T3-c-3** 復帰後に送信
  4. **T3-c-4** 衝突処理
- **T3-d 自動リトライ**
  1. **T3-d-1** ネットワーク状態の検知
  2. **T3-d-2** 失敗更新をリトライ
  3. **T3-d-3** オフライン表示
  4. **T3-d-4** 間隔設定

### T4 多言語インタフェース
- **T4-a i18n設定**
  1. **T4-a-1** Nuxt i18nを導入
  2. **T4-a-2** 利用言語を設定
  3. **T4-a-3** フォールバックを定義
  4. **T4-a-4** デモページを追加
- **T4-b メッセージ抽出**
  1. **T4-b-1** UI文字列をlocaleファイル化
  2. **T4-b-2** テンプレートでキー使用
  3. **T4-b-3** 英語訳を用意
  4. **T4-b-4** 日本語訳を用意
- **T4-c その他言語追加**
  1. **T4-c-1** ベトナム語ファイル追加
  2. **T4-c-2** 簡体字中国語ファイル追加
  3. **T4-c-3** タガログ語ファイル追加
  4. **T4-c-4** ネパール語とブラジルポルトガル語追加
- **T4-d 言語切替UI**
  1. **T4-d-1** 言語切替コンポーネント実装
  2. **T4-d-2** 選択言語を保存
  3. **T4-d-3** ブラウザ設定を自動検知
  4. **T4-d-4** テストを作成

### T5 RBAC
- **T5-a Prismaスキーマ**
  1. **T5-a-1** Userテーブルにrole列追加
  2. **T5-a-2** マイグレーション実行
  3. **T5-a-3** モデルロジック更新
  4. **T5-a-4** 管理者をシード
- **T5-b 認証フロー**
  1. **T5-b-1** OAuth2ログイン実装
  2. **T5-b-2** MagicLinkを追加
  3. **T5-b-3** セッションにrole保存
  4. **T5-b-4** ログイン手順を記載
- **T5-c 認可ガード**
  1. **T5-c-1** ルート保護ミドルウェア作成
  2. **T5-c-2** ページに必要ロール付与
  3. **T5-c-3** 未許可時のリダイレクト
  4. **T5-c-4** テスト追加
- **T5-d 管理画面**
  1. **T5-d-1** ロール管理画面を構築
  2. **T5-d-2** 役割編集を可能に
  3. **T5-d-3** 変更履歴を記録
  4. **T5-d-4** テスト追加

### T6 Terraformインフラ
- **T6-a モジュール定義**
  1. **T6-a-1** VPSモジュール作成
  2. **T6-a-2** LBモジュール設定
  3. **T6-a-3** オブジェクトストレージモジュール追加
  4. **T6-a-4** IPアドレスを出力
- **T6-b tfvarsサンプル**
  1. **T6-b-1** `terraform.tfvars.example`作成
  2. **T6-b-2** 必要変数を記載
  3. **T6-b-3** プレースホルダ値を用意
  4. **T6-b-4** READMEに手順追加
- **T6-c applyスクリプト**
  1. **T6-c-1** `terraform init`と`apply`のスクリプト作成
  2. **T6-c-2** backend設定を含む
  3. **T6-c-3** plan出力を確認
  4. **T6-c-4** stateを安全に保存
- **T6-d 出力値整理**
  1. **T6-d-1** Output値を取得
  2. **T6-d-2** `.env`スニペットとして書き出し
  3. **T6-d-3** 利用方法を文書化
  4. **T6-d-4** `terraform output`で検証

### T7 CI/CD設定
- **T7-a ビルドワークフロー**
  1. **T7-a-1** Dockerビルド用Actions作成
  2. **T7-a-2** レジストリへPush
  3. **T7-a-3** PRマージでトリガー
  4. **T7-a-4** pnpmキャッシュ
- **T7-b デプロイシークレット**
  1. **T7-b-1** SSH鍵をリポジトリシークレットに保存
  2. **T7-b-2** 環境変数シークレット設定
  3. **T7-b-3** デプロイジョブで利用
  4. **T7-b-4** 鍵ローテーション手順
- **T7-c Watchtower**
  1. **T7-c-1** Watchtowerコンテナを配置
  2. **T7-c-2** ポーリング間隔を設定
  3. **T7-c-3** イメージをセムバータグ
  4. **T7-c-4** 自動更新を検証
- **T7-d PRパイプライン**
  1. **T7-d-1** PR時にテストジョブを実行
  2. **T7-d-2** 検証用イメージをビルド
  3. **T7-d-3** lintと単体テストを実行
  4. **T7-d-4** ステータスを報告

### T8 システム構成
- **T8-a Nginx設定**
  1. **T8-a-1** Nginx用Dockerfile作成
  2. **T8-a-2** HTTPS/WSSリバースプロキシ設定
  3. **T8-a-3** Let's Encrypt対応
  4. **T8-a-4** リロードスクリプト
- **T8-b Compose定義**
  1. **T8-b-1** Nuxtサービスを複数定義
  2. **T8-b-2** Postgresコンテナを追加
  3. **T8-b-3** Redisをリンク
  4. **T8-b-4** ネットワーク設定
- **T8-c Prisma環境**
  1. **T8-c-1** DB用環境変数を追加
  2. **T8-c-2** コネクションプール設定
  3. **T8-c-3** `.env.sample`に記載
  4. **T8-c-4** 接続例を用意
- **T8-d WALオブジェクト保存**
  1. **T8-d-1** WALアーカイブ設定
  2. **T8-d-2** 古いログを削除するcron
  3. **T8-d-3** ディスク使用量を監視
  4. **T8-d-4** 復元手順を文書化

### T9 開発ドキュメント
- **T9-a セットアップ手順**
  1. **T9-a-1** git clone方法を記載
  2. **T9-a-2** `pnpm install`手順
  3. **T9-a-3** `.env.sample`コピー説明
  4. **T9-a-4** dev起動方法
- **T9-b 環境テンプレート**
  1. **T9-b-1** `.env.sample`の変数一覧
  2. **T9-b-2** 各変数の説明コメント
  3. **T9-b-3** 必須/任意を明示
  4. **T9-b-4** 詳細ドキュメントへのリンク
- **T9-c 開発サーバ実行**
  1. **T9-c-1** `pnpm dev`コマンド例
  2. **T9-c-2** 期待される出力を記載
  3. **T9-c-3** トラブルシューティング
  4. **T9-c-4** ホットリロード説明
- **T9-d Prisma Studio**
  1. **T9-d-1** 起動コマンドを示す
  2. **T9-d-2** ログイン要件を記載
  3. **T9-d-3** 画面例を添付
  4. **T9-d-4** 安全な利用方法

### T10 前提条件確認
- **T10-a Nodeバージョン**
  1. **T10-a-1** Node20以上をチェックするスクリプト
  2. **T10-a-2** 違う場合はエラーを出す
  3. **T10-a-3** preinstallで実行
  4. **T10-a-4** 使用方法を記述
- **T10-b ツールバージョン**
  1. **T10-b-1** pnpmバージョン確認
  2. **T10-b-2** `docker --version`確認
  3. **T10-b-3** Terraformバージョン提示
  4. **T10-b-4** 実行例を載せる
- **T10-c Dockerインストール**
  1. **T10-c-1** Dockerドキュメントへリンク
  2. **T10-c-2** aptによるインストール手順
  3. **T10-c-3** hello-worldで検証
  4. **T10-c-4** クロスプラットフォーム情報
- **T10-d トラブルシュート**
  1. **T10-d-1** よくあるエラーを記載
  2. **T10-d-2** 権限問題の解決
  3. **T10-d-3** WSL2特有の注意
  4. **T10-d-4** サポート連絡先

### T11 プロジェクトスクリプト
- **T11-a package.json確認**
  1. **T11-a-1** 既存スクリプト一覧
  2. **T11-a-2** lint/test/e2eを追加
  3. **T11-a-3** 各スクリプトを説明
  4. **T11-a-4** クロスプラットフォーム化
- **T11-b ドキュメント**
  1. **T11-b-1** READMEにスクリプト節を追加
  2. **T11-b-2** 使用例を示す
  3. **T11-b-3** 実行結果を表示
  4. **T11-b-4** ドキュメントを同期
- **T11-c Prisma操作**
  1. **T11-c-1** migrateコマンド説明
  2. **T11-c-2** generateコマンド説明
  3. **T11-c-3** studioコマンド説明
  4. **T11-c-4** 環境変数例を記載
- **T11-d CI用コマンド統一**
  1. **T11-d-1** テスト用エイリアス追加
  2. **T11-d-2** CIで同じスクリプトを使用
  3. **T11-d-3** 環境設定を説明
  4. **T11-d-4** 実行結果をまとめる

### T12 docker-compose環境
- **T12-a Composeファイル**
  1. **T12-a-1** Nuxt/Postgres/Redisサービス定義
  2. **T12-a-2** DBボリュームを設定
  3. **T12-a-3** ポートマッピング
  4. **T12-a-4** depends_onを追加
- **T12-b ネットワークとボリューム**
  1. **T12-b-1** backendネットワーク作成
  2. **T12-b-2** ホストにボリュームを保持
  3. **T12-b-3** クリーンアップスクリプト
  4. **T12-b-4** 使い方を記述
- **T12-c 環境変数取り込み**
  1. **T12-c-1** env_fileを利用
  2. **T12-c-2** `.env`パスを記載
  3. **T12-c-3** デフォルト値を用意
  4. **T12-c-4** 上書き例を示す
- **T12-d 利用手順**
  1. **T12-d-1** `docker compose up --build`を記載
  2. **T12-d-2** 停止とログ取得方法
  3. **T12-d-3** 開発用スクリプト
  4. **T12-d-4** ボリューム掃除を推奨

### T13 デプロイフロー
- **T13-a Terraform利用**
  1. **T13-a-1** infraディレクトリで`terraform init`
  2. **T13-a-2** `terraform apply`例を提示
  3. **T13-a-3** リモートステート保存
  4. **T13-a-4** コスト試算
- **T13-b ブートストラップスクリプト**
  1. **T13-b-1** `scripts/bootstrap_vps.sh`の流れ
  2. **T13-b-2** サーバパッケージをインストール
  3. **T13-b-3** Docker環境構築
  4. **T13-b-4** 実行方法を記載
- **T13-c CIパイプライン**
  1. **T13-c-1** マージ時に動くジョブを説明
  2. **T13-c-2** コンテナビルドとプッシュ
  3. **T13-c-3** SSHデプロイ実行
  4. **T13-c-4** git SHAでタグ付け
- **T13-d 環境切替**
  1. **T13-d-1** stagingとprodワークスペース
  2. **T13-d-2** 環境変数を記録
  3. **T13-d-3** 手動承認ゲート
  4. **T13-d-4** ロールバック手順

### T14 環境変数整理
- **T14-a `.env.sample`**
  1. **T14-a-1** 全変数のプレースホルダ
  2. **T14-a-2** それぞれ用途をコメント
  3. **T14-a-3** サンプル値を入れる
  4. **T14-a-4** リポジトリに保持
- **T14-b 秘匿情報管理**
  1. **T14-b-1** GitHubにシークレット保存
  2. **T14-b-2** `.env.local`を無視
  3. **T14-b-3** envチェックスクリプト
  4. **T14-b-4** ローテーション手順
- **T14-c 必須/任意の区別**
  1. **T14-c-1** 必須変数を明示
  2. **T14-c-2** 任意はデフォルト提供
  3. **T14-c-3** 実行時チェックを実装
  4. **T14-c-4** ドキュメント維持
- **T14-d 変更手順**
  1. **T14-d-1** 変数名変更方法を説明
  2. **T14-d-2** 置換手順を記載
  3. **T14-d-3** 移行ノート
  4. **T14-d-4** README更新

### T15 品質ゲート
- **T15-a Vitestカバレッジ**
  1. **T15-a-1** 閾値を設定
  2. **T15-a-2** レポーター追加
  3. **T15-a-3** 閾値未満でCI失敗
  4. **T15-a-4** 実行方法を文書化
- **T15-b Playwrightテスト**
  1. **T15-b-1** Chrome用テスト作成
  2. **T15-b-2** Android WebViewテスト追加
  3. **T15-b-3** CIに組み込み
  4. **T15-b-4** 実行手順を記載
- **T15-c k6負荷テスト**
  1. **T15-c-1** `scripts/k6_schedule_sync.js`作成
  2. **T15-c-2** 200rpsで15分計測
  3. **T15-c-3** 結果を解析
  4. **T15-c-4** 傾向を記録
- **T15-d Lighthouse**
  1. **T15-d-1** PWAスコアを計測
  2. **T15-d-2** 取得指標を記録
  3. **T15-d-3** 手動またはCIステップ
  4. **T15-d-4** 80点基準を維持

### T16 貢献ガイドライン
- **T16-a コミットテンプレート**
  1. **T16-a-1** 例となるメッセージ提示
  2. **T16-a-2** コミット種別を説明
  3. **T16-a-3** 規約へのリンク
  4. **T16-a-4** commitlintを追加
- **T16-b プリフック**
  1. **T16-b-1** huskyで`pnpm lint && pnpm test`
  2. **T16-b-2** セットアップ手順
  3. **T16-b-3** 失敗時の対応
  4. **T16-b-4** 例外パターンを記載
- **T16-c レビュープロセス**
  1. **T16-c-1** `@watchout/core`によるレビュー必須
  2. **T16-c-2** PRテンプレートを整備
  3. **T16-c-3** CODEOWNERSを追加
  4. **T16-c-4** 返答目安を記載
- **T16-d 自動デプロイ**
  1. **T16-d-1** mainマージでデプロイ
  2. **T16-d-2** 環境差異を説明
  3. **T16-d-3** ロールバック方法
  4. **T16-d-4** CIログへのリンク

### T17 MITライセンス
- **T17-a LICENSEファイル**
  1. **T17-a-1** MIT文言と©2025 watchoutを記載
  2. **T17-a-2** リポジトリ直下に配置
  3. **T17-a-3** READMEからリンク
  4. **T17-a-4** 年号更新手順
- **T17-b ヘッダー注意書き**
  1. **T17-b-1** ソースに短いヘッダー追加
  2. **T17-b-2** SPDX識別子を記載
  3. **T17-b-3** 第三者ライセンスを整理
  4. **T17-b-4** 自動付与スクリプト
- **T17-c READMEライセンス節**
  1. **T17-c-1** READMEにライセンス章追加
  2. **T17-c-2** LICENSEファイルへのリンク
  3. **T17-c-3** 著作権表記
  4. **T17-c-4** OSS義務を説明
